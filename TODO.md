# ToDo

## TOC データの扱い

マルチプロセスで pub_markdown を実行したときに、TOC データベースの破壊は発生しないか。


## images クリーンアップルール

doxyfw/templates/postprocess.sh L410からのPages以下でのみの参照チェックだが、演算コストを気にしている。  
Pages以外で処理した画像パスを変数に持ち、imagesでチェックする処理とどちらが低コストか。

  現在の実装 (テキストファイル方式)
                                                                                                                                                                                                                                                                                                         
  @startuml 現在の実装フロー                                                                                                                                                                                                                                                                             
  caption 現在の実装フロー                                                                                                                                                                                                                                                                               

  :md_files[] ループ (全ファイル);
  if (サブディレクトリ内？) then (yes)
      :grep + sed で画像 basename 抽出;
      :SUBDIR_IMAGES テキストファイルに追記\n(ディスク書き込み × マッチファイル数);
  endif

  :images/ をループ (I 個のファイル);
  :grep -qxF でテキストファイルを検索\n(ファイル open + 線形探索 × I 回);
  if (未登録？) then (yes)
      :rm 実行;
  endif

  @enduml

  ---
  提案の代替案 (変数保持方式)

  収集フェーズで SUBDIR_IMAGES ファイルへの書き込みを bash 変数 (配列) に変更し、チェック時はメモリ内で照合する方法です。

  ---
  コスト比較

  ┌──────────────────┬──────────────────────────────────────────────┬──────────────────────────────────────────────┐
  │       観点       │         テキストファイル方式 (現在)          │                 変数保持方式                 │
  ├──────────────────┼──────────────────────────────────────────────┼──────────────────────────────────────────────┤
  │ 収集時のコスト   │ ディスク書き込み (>>) × マッチファイル数     │ メモリへの配列追加                           │
  ├──────────────────┼──────────────────────────────────────────────┼──────────────────────────────────────────────┤
  │ チェック時コスト │ grep -qxF = ファイル open + 線形探索 × I 回  │ bash 配列の線形探索 × I 回                   │
  ├──────────────────┼──────────────────────────────────────────────┼──────────────────────────────────────────────┤
  │ ディスク I/O     │ 収集時書き込み + チェック時読み込み × I      │ なし                                         │
  ├──────────────────┼──────────────────────────────────────────────┼──────────────────────────────────────────────┤
  │ スケール特性     │ OS ページキャッシュが効けば 2 回目以降は速い │ 変数サイズが大きいと bash 内部処理が重くなる │
  └──────────────────┴──────────────────────────────────────────────┴──────────────────────────────────────────────┘

  原理的には変数保持方式の方が低コストです。 ただし決定的なのは以下の点です。

  grep -qxF "$img_name" "$SUBDIR_IMAGES" はチェック対象の images/ ファイル数 I 分だけファイルを繰り返し open します。OS ページキャッシュで実質メモリアクセスになる場合でも、システムコール (open/read) のオーバーヘッドが I 回発生します。

  ---
  実用上の評価

  - Doxygen 生成の画像数は通常数個～数十個 → I が小さいため、現実的な差は無視できるレベルです。
  - コストを最小化したいなら、awk 連想配列で O(1) ルックアップにする方法が最も効率的です。

  # 最もコスト効率の高いアプローチ (参考)
  awk '
      NR==FNR { subdir[$0]=1; next }    # SUBDIR_IMAGES を連想配列に読み込み
      !subdir[$0]                        # 登録なし → 削除対象
  ' "$SUBDIR_IMAGES" <(find "$IMAGES_DIR" -maxdepth 1 -type f -exec basename {} \;)

  実際の規模 (数十ファイル) では現在のテキストファイル方式でも問題になるコストではないため、変更の優先度は低いと判断できます。
