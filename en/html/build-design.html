<!doctype html>
<html >
<head>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="Content-Style-Type" content="text/css" />

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/template.css" />

    <link href="https://vjs.zencdn.net/5.4.4/video-js.css" rel="stylesheet" />

    <script src="https://code.jquery.com/jquery-2.2.1.min.js"></script>

    <script type='text/javascript' src='https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/js/jquery.cookie.js'></script>
    <script type='text/javascript' src='https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/js/jquery.hoverIntent.minified.js'></script>
    <script type='text/javascript' src='https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/js/jquery.dcjqaccordion.2.7.min.js'></script>

    <link href="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/css/skins/blue.css" rel="stylesheet" type="text/css" />
    <link href="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/css/skins/graphite.css" rel="stylesheet" type="text/css" />
    <link href="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/css/skins/grey.css" rel="stylesheet" type="text/css" />
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script src="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/script.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/jquery.sticky-kit.js"></script>

    <style type="text/css">
        /* TOC のスクロールバーを常にビューポート全高にする。
           sticky-kit の挙動 (ヘッダ考慮・ページ下部処理) はそのまま維持する。 */
        @media (min-width: 768px) {
            #TOC {
                height: 100vh;
                box-sizing: border-box;
            }
        }
    </style>

    <meta name="generator" content="pandoc" />
  <meta name="author" content="Tetsuo Honda" />
  <title>クロスプラットフォームビルドシステムの実装</title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="html-style.css" />
</head>
<body>

    
    <div class="navbar navbar-static-top">
    <div class="navbar-inner">
      <div class="container">
        <span class="doc-title">クロスプラットフォームビルドシステムの実装</span>
        <ul class="nav pull-right doc-info">
                    <li><p class="navbar-text">Tetsuo Honda</p></li>
                              <li><p class="navbar-text">Mon, 16 Feb 2026 23:03:26 +0900 aee0f36</p></li>
                  </ul>
      </div>
    </div>
  </div>
    <div class="container">
    <div class="row">
            <div id="TOC" class="span3">
        <div class="well toc">

        <div class="toc-navi">
          <a href="javascript:history.back()">BACK</a>&nbsp;
          <a href="index.html">HOME</a>
        </div>

                <ul>
                <li><a href="#概要" id="toc-概要"><span class="toc-section-number">1</span> 概要</a></li>
                <li><a href="#前提条件" id="toc-前提条件"><span class="toc-section-number">2</span> 前提条件</a>
                <ul>
                <li><a href="#linux-環境" id="toc-linux-環境"><span class="toc-section-number">2.1</span> Linux 環境</a></li>
                <li><a href="#windows-環境" id="toc-windows-環境"><span class="toc-section-number">2.2</span> Windows 環境</a></li>
                </ul></li>
                <li><a href="#ビルド方法" id="toc-ビルド方法"><span class="toc-section-number">3</span> ビルド方法</a>
                <ul>
                <li><a href="#ビルド実行" id="toc-ビルド実行"><span class="toc-section-number">3.1</span> ビルド実行</a></li>
                <li><a href="#テストのビルドと実行" id="toc-テストのビルドと実行"><span class="toc-section-number">3.2</span> テストのビルドと実行</a></li>
                <li><a href="#クリーンアップ" id="toc-クリーンアップ"><span class="toc-section-number">3.3</span> クリーンアップ</a></li>
                </ul></li>
                <li><a href="#ファイル構成" id="toc-ファイル構成"><span class="toc-section-number">4</span> ファイル構成</a>
                <ul>
                <li><a href="#プロジェクト構造" id="toc-プロジェクト構造"><span class="toc-section-number">4.1</span> プロジェクト構造</a></li>
                </ul></li>
                <li><a href="#主な機能" id="toc-主な機能"><span class="toc-section-number">5</span> 主な機能</a>
                <ul>
                <li><a href="#makefw-フレームワークによる統合" id="toc-makefw-フレームワークによる統合"><span class="toc-section-number">5.1</span> 1. makefw フレームワークによる統合</a></li>
                <li><a href="#makepart.mk-による追加設定" id="toc-makepart.mk-による追加設定"><span class="toc-section-number">5.2</span> 2. makepart.mk による追加設定</a></li>
                <li><a href="#静的ライブラリの自動組み込み" id="toc-静的ライブラリの自動組み込み"><span class="toc-section-number">5.3</span> 3. 静的ライブラリの自動組み込み</a></li>
                <li><a href="#クロスプラットフォーム対応" id="toc-クロスプラットフォーム対応"><span class="toc-section-number">5.4</span> 4. クロスプラットフォーム対応</a></li>
                <li><a href="#ライブラリ構成" id="toc-ライブラリ構成"><span class="toc-section-number">5.5</span> 5. ライブラリ構成</a></li>
                </ul></li>
                <li><a href="#設計思想" id="toc-設計思想"><span class="toc-section-number">6</span> 設計思想</a>
                <ul>
                <li><a href="#技術的な対処方針" id="toc-技術的な対処方針"><span class="toc-section-number">6.1</span> 技術的な対処方針</a>
                <ul>
                <li><a href="#os-判定による条件分岐" id="toc-os-判定による条件分岐"><span class="toc-section-number">6.1.1</span> OS 判定による条件分岐</a></li>
                <li><a href="#コンパイラとツールチェーンの違い" id="toc-コンパイラとツールチェーンの違い"><span class="toc-section-number">6.1.2</span> コンパイラとツールチェーンの違い</a></li>
                <li><a href="#mingw-環境の活用" id="toc-mingw-環境の活用"><span class="toc-section-number">6.1.3</span> MinGW 環境の活用</a></li>
                </ul></li>
                <li><a href="#makefw-フレームワーク" id="toc-makefw-フレームワーク"><span class="toc-section-number">6.2</span> makefw フレームワーク</a></li>
                <li><a href="#ライブラリ構成-1" id="toc-ライブラリ構成-1"><span class="toc-section-number">6.3</span> ライブラリ構成</a></li>
                <li><a href="#実装ファイル" id="toc-実装ファイル"><span class="toc-section-number">6.4</span> 実装ファイル</a></li>
                </ul></li>
                <li><a href="#実装の特徴" id="toc-実装の特徴"><span class="toc-section-number">7</span> 実装の特徴</a></li>
                <li><a href="#デバッグ" id="toc-デバッグ"><span class="toc-section-number">8</span> デバッグ</a></li>
                <li><a href="#現在の制限事項" id="toc-現在の制限事項"><span class="toc-section-number">9</span> 現在の制限事項</a></li>
                <li><a href="#今後の拡張可能性" id="toc-今後の拡張可能性"><span class="toc-section-number">10</span> 今後の拡張可能性</a></li>
                <li><a href="#実装のベストプラクティスと重要なノート" id="toc-実装のベストプラクティスと重要なノート"><span class="toc-section-number">11</span> 実装のベストプラクティスと重要なノート</a>
                <ul>
                <li><a href="#環境設定スクリプト" id="toc-環境設定スクリプト"><span class="toc-section-number">11.1</span> 環境設定スクリプト</a></li>
                <li><a href="#utf-8-ソースコードへの対応" id="toc-utf-8-ソースコードへの対応"><span class="toc-section-number">11.2</span> UTF-8 ソースコードへの対応</a></li>
                <li><a href="#pdb-ファイルの適切な配置" id="toc-pdb-ファイルの適切な配置"><span class="toc-section-number">11.3</span> PDB ファイルの適切な配置</a>
                <ul>
                <li><a href="#ライブラリの-pdb" id="toc-ライブラリの-pdb"><span class="toc-section-number">11.3.1</span> ライブラリの PDB</a></li>
                <li><a href="#実行ファイルの-pdb" id="toc-実行ファイルの-pdb"><span class="toc-section-number">11.3.2</span> 実行ファイルの PDB</a></li>
                </ul></li>
                <li><a href="#fs-オプションの追加" id="toc-fs-オプションの追加"><span class="toc-section-number">11.4</span> /FS オプションの追加</a></li>
                <li><a href="#workspace_folder-のパス変換" id="toc-workspace_folder-のパス変換"><span class="toc-section-number">11.5</span> WORKSPACE_FOLDER のパス変換</a></li>
                <li><a href="#ディレクトリの依存関係" id="toc-ディレクトリの依存関係"><span class="toc-section-number">11.6</span> ディレクトリの依存関係</a></li>
                <li><a href="#clean-ターゲットの実装" id="toc-clean-ターゲットの実装"><span class="toc-section-number">11.7</span> clean ターゲットの実装</a></li>
                </ul></li>
                <li><a href="#まとめと今後の展望" id="toc-まとめと今後の展望"><span class="toc-section-number">12</span> まとめと今後の展望</a>
                <ul>
                <li><a href="#採用した方針" id="toc-採用した方針"><span class="toc-section-number">12.1</span> 採用した方針</a></li>
                <li><a href="#メリット" id="toc-メリット"><span class="toc-section-number">12.2</span> メリット</a></li>
                <li><a href="#注意点" id="toc-注意点"><span class="toc-section-number">12.3</span> 注意点</a></li>
                </ul></li>
                </ul>
        
        </div>
      </div>
            <div class="span9">

                <H1>クロスプラットフォームビルドシステムの実装</H1>
      
      
      <h1 data-number="1" id="概要"><span class="header-section-number">1</span> 概要</h1>
<p>このドキュメントは、c-modernization-kit プロジェクトのクロスプラットフォームビルドシステムの設計、実装、および使用方法を説明します。</p>
<p>本プロジェクトは、Linux/Windows クロスプラットフォームビルドシステムを実現しています。GCC と MSVC (Microsoft Visual C++) との両方に対応し、単一の makefile で Linux と Windows の両環境でビルドできます。</p>
<h1 data-number="2" id="前提条件"><span class="header-section-number">2</span> 前提条件</h1>
<h2 data-number="2.1" id="linux-環境"><span class="header-section-number">2.1</span> Linux 環境</h2>
<p>標準的な開発ツールが必要です:</p>
<ul>
<li>GCC コンパイラ</li>
<li>GNU Make</li>
</ul>
<h2 data-number="2.2" id="windows-環境"><span class="header-section-number">2.2</span> Windows 環境</h2>
<p>注: 環境変数は VS Code 起動時に自動設定済みの前提です。以下の環境が利用可能である必要があります：</p>
<ol type="1">
<li><p>ポータブル版 Visual Studio Build Tools</p>
<ul>
<li>MSVC コンパイラ (<code>cl.exe</code>)</li>
<li>MSVC リンカー (<code>link.exe</code>)</li>
</ul></li>
<li><p>Git for Windows (MinGW)</p>
<ul>
<li>GNU Make (<code>make.exe</code>)</li>
<li>各種 Unix コマンド</li>
</ul></li>
<li><p>環境設定の実行 (手動設定時のみ)</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="op">.</span> <span class="op">.</span>\Start-VSCode-With-Env<span class="op">.</span><span class="fu">ps1</span> <span class="op">-</span>EnvOnly</span></code></pre></div></li>
</ol>
<h1 data-number="3" id="ビルド方法"><span class="header-section-number">3</span> ビルド方法</h1>
<h2 data-number="3.1" id="ビルド実行"><span class="header-section-number">3.1</span> ビルド実行</h2>
<p>prod/ ディレクトリでビルドします:</p>
<p>Windows:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode cmd"><code class="sourceCode dosbat"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> prod</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>make</span></code></pre></div>
<p>Linux:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> prod</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span></span></code></pre></div>
<p>このコマンドで以下がビルドされます:</p>
<p>ライブラリ / Libraries:</p>
<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 27%" />
<col style="width: 21%" />
<col style="width: 18%" />
</colgroup>
<thead>
<tr>
<th>ライブラリ</th>
<th>Windows</th>
<th>Linux</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td>libcalcbase</td>
<td><code>prod/calc/lib/libcalcbase.lib</code></td>
<td><code>prod/calc/lib/libcalcbase.a</code></td>
<td>基本計算関数ライブラリ (静的ライブラリ)</td>
</tr>
<tr>
<td>libcalc</td>
<td><code>prod/calc/lib/libcalc.dll</code> + <code>libcalc.lib</code></td>
<td><code>prod/calc/lib/libcalc.so</code></td>
<td>計算ハンドラーライブラリ (動的ライブラリ、calcbase を内部に静的リンク)</td>
</tr>
</tbody>
</table>
<p>コマンド / Commands:</p>
<table>
<colgroup>
<col style="width: 21%" />
<col style="width: 21%" />
<col style="width: 17%" />
<col style="width: 39%" />
</colgroup>
<thead>
<tr>
<th>コマンド</th>
<th>Windows</th>
<th>Linux</th>
<th>リンクライブラリ</th>
</tr>
</thead>
<tbody>
<tr>
<td>add</td>
<td><code>prod/calc/bin/add.exe</code></td>
<td><code>prod/calc/bin/add</code></td>
<td>calcbase のみ</td>
</tr>
<tr>
<td>calc</td>
<td><code>prod/calc/bin/calc.exe</code></td>
<td><code>prod/calc/bin/calc</code></td>
<td>calc のみ</td>
</tr>
<tr>
<td>shared-and-static-calc</td>
<td><code>prod/calc/bin/shared-and-static-calc.exe</code></td>
<td><code>prod/calc/bin/shared-and-static-calc</code></td>
<td>calc + calcbase (両方)</td>
</tr>
</tbody>
</table>
<p>.NET コマンド / .NET Commands:</p>
<table>
<colgroup>
<col style="width: 23%" />
<col style="width: 23%" />
<col style="width: 17%" />
<col style="width: 35%" />
</colgroup>
<thead>
<tr>
<th>コマンド</th>
<th>Windows</th>
<th>Linux</th>
<th>依存ライブラリ</th>
</tr>
</thead>
<tbody>
<tr>
<td>CalcApp</td>
<td><code>prod/calc.net/bin/CalcApp.exe</code></td>
<td><code>prod/calc.net/bin/CalcApp</code></td>
<td>CalcLib (libcalc の .NET ラッパー)</td>
</tr>
</tbody>
</table>
<p>重要:<br />
- libcalc は動的ライブラリとして実装されており、calcbase を内部に静的リンクします<br />
- shared-and-static-calc は、コマンドにおいて動的ライブラリと静的ライブラリの両方をリンクする実装例です<br />
- 実行ファイルの出力先は <code>prod/calc/src/makepart.mk</code> および <code>prod/calc.net/src/makepart.mk</code> で <code>OUTPUT_DIR</code> として設定されています</p>
<h2 data-number="3.2" id="テストのビルドと実行"><span class="header-section-number">3.2</span> テストのビルドと実行</h2>
<p>testfw/ ディレクトリおよび test/ ディレクトリでテストをビルド・実行します:</p>
<p>Windows:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode cmd"><code class="sourceCode dosbat"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> testfw</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>make</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ..\test</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>make</span></code></pre></div>
<p>Linux:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> testfw</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ../test</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span></span></code></pre></div>
<p>テストは Google Test フレームワークを使用しています:</p>
<ul>
<li>単体テスト: ライブラリ関数の単体テスト (<code>test/src/calc/libcalcbaseTest/</code>) および コマンドの単体テスト (<code>test/src/calc/main/</code>)</li>
<li>モックライブラリ: テスト用のモック実装 (<code>test/libsrc/mock_*/</code>)</li>
</ul>
<h2 data-number="3.3" id="クリーンアップ"><span class="header-section-number">3.3</span> クリーンアップ</h2>
<p><strong>プロダクションコードのクリーンアップ:</strong></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> prod/calc</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> clean</span></code></pre></div>
<p><strong>テストコードのクリーンアップ:</strong></p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> test</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> clean</span></code></pre></div>
<h1 data-number="4" id="ファイル構成"><span class="header-section-number">4</span> ファイル構成</h1>
<h2 data-number="4.1" id="プロジェクト構造"><span class="header-section-number">4.1</span> プロジェクト構造</h2>
<pre class="text"><code>c-modernization-kit/
+-- makefw/                              # makefile フレームワーク (testfw から切り出し)
|   +-- makefiles/
|   |   +-- makelibsrc.mk               # ライブラリビルド用共通テンプレート
|   |   +-- makesrc.mk                  # 実行ファイルビルド用共通テンプレート
|   |   +-- prepare.mk                  # 準備処理
|   |   +-- _*.mk                       # 内部処理用ファイル
|   +-- docs-src/                       # フレームワーク技術ドキュメント
+-- prod/calc/
|   +-- makefile                        # トップレベル makefile (再帰ビルド)
|   +-- lib/                            # ビルド済みライブラリ
|   +-- bin/                            # ビルド済み実行ファイル
|   +-- libsrc/
|   |   +-- makefile                    # libsrc 配下の再帰ビルド
|   |   +-- makepart.mk                # ライブラリ共通設定
|   |   +-- calcbase/
|   |   |   +-- makefile                # calcbase ビルド定義 (静的ライブラリ)
|   |   +-- calc/
|   |       +-- makefile                # calc ビルド定義 (動的ライブラリ)
|   |       +-- makepart.mk            # calc 固有設定 (LIB_TYPE=shared)
|   +-- src/
|       +-- makefile                    # src 配下の再帰ビルド
|       +-- makepart.mk                # 実行ファイル出力先設定 (OUTPUT_DIR)
|       +-- add/
|       |   +-- makefile                # add コマンドビルド定義
|       +-- calc/
|       |   +-- makefile                # calc コマンドビルド定義
|       +-- shared-and-static-calc/
|           +-- makefile                # shared-and-static-calc ビルド定義
+-- prod/calc.net/
|   +-- lib/                            # ビルド済みライブラリ
|   +-- bin/                            # ビルド済み実行ファイル
|   +-- libsrc/CalcLib/                 # .NET ライブラリソース
|   +-- src/
|       +-- makepart.mk                # 実行ファイル出力先設定 (OUTPUT_DIR)
|       +-- CalcApp/                    # .NET アプリケーションソース
+-- test/
    +-- makefile                        # テストトップレベル makefile
    +-- makepart.mk                    # テスト共通設定
    +-- libsrc/
    |   +-- makefile                    # テスト用ライブラリ配下の再帰ビルド
    |   +-- mock_calcbase/
    |   |   +-- makefile                # calcbase モックライブラリ
    |   +-- mock_calc/
    |       +-- makefile                # calc モックライブラリ
    +-- src/
        +-- makefile                    # テスト配下の再帰ビルド
        +-- calc/
            +-- libcalcbaseTest/
            |   +-- addTest/
            |       +-- makefile        # add 関数単体テスト
            +-- main/
                +-- addTest/
                |   +-- makefile        # add コマンド統合テスト
                +-- calcTest/
                |   +-- makefile        # calc コマンド統合テスト
                +-- shared-and-static-calcTest/
                    +-- makefile        # shared-and-static-calc 統合テスト</code></pre>
<p><strong>設計方針</strong>:</p>
<ul>
<li>単一の <code>makefile</code> で Linux/Windows 両対応</li>
<li>makefw テンプレートが OS 判定を自動処理</li>
<li>各 makefile は最小限の設定のみを記述</li>
</ul>
<h1 data-number="5" id="主な機能"><span class="header-section-number">5</span> 主な機能</h1>
<h2 data-number="5.1" id="makefw-フレームワークによる統合"><span class="header-section-number">5.1</span> 1. makefw フレームワークによる統合</h2>
<p><code>makefw</code> は testfw から makefile 機能を切り出したフレームワークです。共通テンプレートにより、Windows/Linux の差異を吸収します。</p>
<p><strong>makefile の基本形 (ライブラリ・実行ファイル共通):</strong></p>
<div class="sourceCode" id="cb9"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="dt">find-up</span> <span class="ch">=</span><span class="st"> </span><span class="ch">\</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="st">    </span><span class="ch">$(</span><span class="kw">if</span><span class="st"> </span><span class="ch">$(</span><span class="kw">wildcard</span><span class="st"> </span><span class="ch">$(</span><span class="dt">1</span><span class="ch">)</span><span class="st">/</span><span class="ch">$(</span><span class="dt">2</span><span class="ch">))</span><span class="kw">,</span><span class="ch">$(</span><span class="dt">1</span><span class="ch">)</span><span class="kw">,</span><span class="st">\</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="st">        </span><span class="ch">$(</span><span class="kw">if</span><span class="st"> </span><span class="ch">$(</span><span class="kw">filter</span><span class="st"> </span><span class="ch">$(</span><span class="dt">1</span><span class="ch">)</span><span class="kw">,</span><span class="ch">$(</span><span class="kw">patsubst</span><span class="st"> %/</span><span class="kw">,</span><span class="st">%</span><span class="kw">,</span><span class="ch">$(</span><span class="kw">dir</span><span class="st"> </span><span class="ch">$(</span><span class="dt">1</span><span class="ch">))))</span><span class="kw">,,</span><span class="st">\</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="st">            </span><span class="ch">$(</span><span class="kw">call</span><span class="st"> find-up</span><span class="kw">,</span><span class="ch">$(</span><span class="kw">patsubst</span><span class="st"> %/</span><span class="kw">,</span><span class="st">%</span><span class="kw">,</span><span class="ch">$(</span><span class="kw">dir</span><span class="st"> </span><span class="ch">$(</span><span class="dt">1</span><span class="ch">)))</span><span class="kw">,</span><span class="ch">$(</span><span class="dt">2</span><span class="ch">))</span><span class="st">\</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="st">        </span><span class="ch">)</span><span class="st">\</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="st">    </span><span class="ch">)</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="dt">WORKSPACE_FOLDER</span> <span class="ch">:=</span><span class="st"> </span><span class="ch">$(</span><span class="kw">strip</span><span class="st"> </span><span class="ch">$(</span><span class="kw">call</span><span class="st"> find-up</span><span class="kw">,</span><span class="ch">$(</span><span class="dt">CURDIR</span><span class="ch">)</span><span class="kw">,</span><span class="st">.workspaceRoot</span><span class="ch">))</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="kw">include</span> <span class="ch">$(</span><span class="dt">WORKSPACE_FOLDER</span><span class="ch">)</span>/makefw/makefiles/prepare.mk</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="co">##### makepart.mk の内容は、このタイミングで処理される #####</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="kw">include</span> <span class="ch">$(</span><span class="dt">WORKSPACE_FOLDER</span><span class="ch">)</span>/makefw/makefiles/makemain.mk</span></code></pre></div>
<p><code>makemain.mk</code> は、カレントディレクトリのパスを判定して、自動的に適切なテンプレートを選択します:</p>
<ul>
<li>パスに <code>/libsrc/</code> を含む → ライブラリ用テンプレート (<code>makelibsrc_c_cpp.mk</code> または <code>makelibsrc_dotnet.mk</code>)</li>
<li>パスに <code>/src/</code> を含む → 実行ファイル用テンプレート (<code>makesrc_c_cpp.mk</code> または <code>makesrc_dotnet.mk</code>)</li>
<li><code>.csproj</code> ファイルの有無により、C/C++ 用か .NET 用かを判定</li>
</ul>
<h2 data-number="5.2" id="makepart.mk-による追加設定"><span class="header-section-number">5.2</span> 2. makepart.mk による追加設定</h2>
<p>各ライブラリ/コマンド固有の設定は <code>makepart.mk</code> に記述できます。</p>
<p><strong>calc/makepart.mk の例:</strong></p>
<div class="sourceCode" id="cb10"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="dt">LIBS</span> <span class="ch">+=</span><span class="st"> calcbase</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="cf">ifeq</span> (<span class="ch">$(</span><span class="dt">OS</span><span class="ch">)</span>,Windows_NT)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Windows</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># DLL エクスポート定義</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># DLL export definition</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">CFLAGS</span>   <span class="ch">+=</span><span class="st"> /DCALC_EXPORTS</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">CXXFLAGS</span> <span class="ch">+=</span><span class="st"> /DCALC_EXPORTS</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="cf">endif</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="dt">LIB_TYPE</span> <span class="ch">=</span><span class="st"> shared</span></span></code></pre></div>
<p>この設定により、calc は Windows では DLL、Linux では .so として自動的にビルドされます。</p>
<p><strong>prod/calc/src/makepart.mk の例 (実行ファイルの出力先設定):</strong></p>
<div class="sourceCode" id="cb11"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="dt">OUTPUT_DIR</span> <span class="ch">:=</span><span class="st"> </span><span class="ch">$(</span><span class="dt">WORKSPACE_FOLDER</span><span class="ch">)</span><span class="st">/prod/calc/bin</span></span></code></pre></div>
<p>この設定により、<code>prod/calc/src/</code> 配下のすべての実行ファイルは <code>prod/calc/bin/</code> に出力されます。</p>
<p><strong>test/makepart.mk の例:</strong></p>
<div class="sourceCode" id="cb12"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="cf">ifneq</span> (<span class="ch">$(</span><span class="dt">OS</span><span class="ch">)</span>,Windows_NT)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Linux</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 詳細な警告レベル設定 (gcc)</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">CFLAGS</span><span class="ch">=\</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wall </span><span class="ch">\</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wextra </span><span class="ch">\</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="st">        </span><span class="co"># ... (その他の警告オプション)</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">CXXFLAGS</span><span class="ch">=\</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wall </span><span class="ch">\</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wextra </span><span class="ch">\</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="st">        </span><span class="co"># ... (その他の警告オプション)</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Windows</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">CFLAGS</span>      <span class="ch">=</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">CXXFLAGS</span>    <span class="ch">=</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">LDFLAGS</span>     <span class="ch">=</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="cf">endif</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="cf">ifneq</span> (<span class="ch">$(</span><span class="dt">OS</span><span class="ch">)</span>,Windows_NT)</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Linux: TARGET_ARCH (e.g., linux-el8-x64)</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">LIBSDIR</span> <span class="ch">+=</span><span class="st"> </span><span class="ch">$(</span><span class="dt">WORKSPACE_FOLDER</span><span class="ch">)</span><span class="st">/testfw/lib/</span><span class="ch">$(</span><span class="dt">TARGET_ARCH</span><span class="ch">)</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Windows: TARGET_ARCH/MSVC_CRT_SUBDIR (e.g., windows-x64/md)</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>    <span class="dt">LIBSDIR</span> <span class="ch">+=</span><span class="st"> </span><span class="ch">$(</span><span class="dt">WORKSPACE_FOLDER</span><span class="ch">)</span><span class="st">/testfw/lib/</span><span class="ch">$(</span><span class="dt">TARGET_ARCH</span><span class="ch">)</span><span class="st">/</span><span class="ch">$(</span><span class="dt">MSVC_CRT_SUBDIR</span><span class="ch">)</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a><span class="cf">endif</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a><span class="dt">LIBSDIR</span> <span class="ch">+=</span><span class="st"> </span><span class="ch">\</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a><span class="st">    </span><span class="ch">$(</span><span class="dt">WORKSPACE_FOLDER</span><span class="ch">)</span><span class="st">/test/lib</span></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a><span class="dt">LINK_TEST</span> <span class="ch">=</span><span class="st"> 1</span></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a><span class="cf">ifeq</span> (<span class="ch">$(</span><span class="dt">OS</span><span class="ch">)</span>,Windows_NT)</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Windows</span></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>    <span class="dt">CFLAGS</span>   <span class="ch">+=</span><span class="st"> /DCALC_STATIC</span></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>    <span class="dt">CXXFLAGS</span> <span class="ch">+=</span><span class="st"> /DCALC_STATIC</span></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a><span class="cf">endif</span></span></code></pre></div>
<p><code>LINK_TEST = 1</code> を設定することで、Google Test フレームワークが自動的にリンクされます。</p>
<h2 data-number="5.3" id="静的ライブラリの自動組み込み"><span class="header-section-number">5.3</span> 3. 静的ライブラリの自動組み込み</h2>
<p><code>LIB_TYPE=shared</code> の場合、動的ライブラリ (DLL/.so) は依存する静的ライブラリを自動的に内部リンクします。</p>
<p><strong>calc/makefile の例:</strong></p>
<div class="sourceCode" id="cb13"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="kw">include</span> <span class="ch">$(</span><span class="dt">WORKSPACE_FOLDER</span><span class="ch">)</span>/makefw/makefiles/makemain.mk</span></code></pre></div>
<p><strong>calc/makepart.mk:</strong></p>
<div class="sourceCode" id="cb14"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="dt">LIBS</span> <span class="ch">+=</span><span class="st"> calcbase</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="dt">LIB_TYPE</span> <span class="ch">=</span><span class="st"> shared</span></span></code></pre></div>
<p><strong>動作:</strong></p>
<ul>
<li><code>LIBS</code> に指定された <code>calcbase</code> をライブラリ検索パスから検索
<ul>
<li>Windows: <code>libcalcbase.lib</code> を検索</li>
<li>Linux: <code>libcalcbase.a</code> を検索</li>
</ul></li>
<li>静的ライブラリが見つかった場合は DLL/.so に静的リンク</li>
<li>見つからない場合は動的リンクフラグとして保持</li>
</ul>
<h2 data-number="5.4" id="クロスプラットフォーム対応"><span class="header-section-number">5.4</span> 4. クロスプラットフォーム対応</h2>
<p>makefw テンプレートが Windows (MSVC) と Linux (GCC) の両方に自動対応します。</p>
<p><strong>makefw/makefiles/prepare.mk 内の OS 判定:</strong></p>
<div class="sourceCode" id="cb15"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="cf">ifneq</span> (<span class="ch">$(</span><span class="dt">OS</span><span class="ch">)</span>,Windows_NT)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Linux (gcc/g++)</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">ifeq</span> (<span class="ch">$(</span><span class="kw">origin</span><span class="st"> CC</span><span class="ch">)</span>,default)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>        <span class="dt">CC</span> <span class="ch">=</span><span class="st"> gcc</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">endif</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">ifeq</span> (<span class="ch">$(</span><span class="kw">origin</span><span class="st"> CXX</span><span class="ch">)</span>,default)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">CXX</span> <span class="ch">=</span><span class="st"> g++</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">endif</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">ifeq</span> (<span class="ch">$(</span><span class="kw">origin</span><span class="st"> LD</span><span class="ch">)</span>,default)</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>        <span class="dt">LD</span> <span class="ch">=</span><span class="st"> g++</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">endif</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">ifeq</span> (<span class="ch">$(</span><span class="kw">origin</span><span class="st"> AR</span><span class="ch">)</span>,default)</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>        <span class="dt">AR</span> <span class="ch">=</span><span class="st"> ar</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">endif</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Windows (MSVC)</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">ifeq</span> (<span class="ch">$(</span><span class="kw">origin</span><span class="st"> CC</span><span class="ch">)</span>,default)</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>        <span class="dt">CC</span> <span class="ch">=</span><span class="st"> cl</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">endif</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">ifeq</span> (<span class="ch">$(</span><span class="kw">origin</span><span class="st"> CXX</span><span class="ch">)</span>,default)</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>        <span class="dt">CXX</span> <span class="ch">=</span><span class="st"> cl</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">endif</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">ifeq</span> (<span class="ch">$(</span><span class="kw">origin</span><span class="st"> LD</span><span class="ch">)</span>,default)</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>        <span class="dt">LD</span> <span class="ch">=</span><span class="st"> link  </span><span class="co"># (MSVC の link.exe)</span></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">endif</span></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">ifeq</span> (<span class="ch">$(</span><span class="kw">origin</span><span class="st"> AR</span><span class="ch">)</span>,default)</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>        <span class="dt">AR</span> <span class="ch">=</span><span class="st"> lib</span></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">endif</span></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a><span class="cf">endif</span></span></code></pre></div>
<p>各 makefile はテンプレートを include するだけで、OS 固有の処理は不要です。</p>
<h2 data-number="5.5" id="ライブラリ構成"><span class="header-section-number">5.5</span> 5. ライブラリ構成</h2>
<p>本プロジェクトでは、以下の構成でライブラリをビルドします：</p>
<table>
<colgroup>
<col style="width: 25%" />
<col style="width: 23%" />
<col style="width: 20%" />
<col style="width: 16%" />
<col style="width: 13%" />
</colgroup>
<thead>
<tr>
<th>ライブラリ</th>
<th>LIB_TYPE 設定</th>
<th>Windows</th>
<th>Linux</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td>libcalcbase</td>
<td>未設定 (→ static)</td>
<td><code>.lib</code></td>
<td><code>.a</code></td>
<td>静的ライブラリ</td>
</tr>
<tr>
<td>libcalc</td>
<td><code>shared</code> (makepart.mk で指定)</td>
<td><code>.dll</code> + <code>.lib</code></td>
<td><code>.so</code></td>
<td>動的ライブラリ + インポートライブラリ</td>
</tr>
</tbody>
</table>
<p><strong>LIB_TYPE 変数:</strong></p>
<ul>
<li>未設定の場合はデフォルトで <code>static</code></li>
<li><code>makepart.mk</code> で <code>LIB_TYPE = shared</code> を指定すると動的ライブラリとしてビルド</li>
</ul>
<h1 data-number="6" id="設計思想"><span class="header-section-number">6</span> 設計思想</h1>
<h2 data-number="6.1" id="技術的な対処方針"><span class="header-section-number">6.1</span> 技術的な対処方針</h2>
<h3 data-number="6.1.1" id="os-判定による条件分岐"><span class="header-section-number">6.1.1</span> OS 判定による条件分岐</h3>
<p>makefile 内で OS を判定し、コンパイラやツールを切り替えます。</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="cf">ifeq</span> (<span class="ch">$(</span><span class="dt">OS</span><span class="ch">)</span>,Windows_NT)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Windows 環境</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">CC</span> <span class="ch">:=</span><span class="st"> cl</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">LD</span> <span class="ch">:=</span><span class="st"> link</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">AR</span> <span class="ch">:=</span><span class="st"> lib</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">OBJEXT</span> <span class="ch">:=</span><span class="st"> .obj</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">EXEEXT</span> <span class="ch">:=</span><span class="st"> .exe</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Linux 環境</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">CC</span> <span class="ch">:=</span><span class="st"> gcc</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">LD</span> <span class="ch">:=</span><span class="st"> gcc</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">AR</span> <span class="ch">:=</span><span class="st"> ar</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">OBJEXT</span> <span class="ch">:=</span><span class="st"> .o</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">EXEEXT</span> <span class="ch">:=</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a><span class="cf">endif</span></span></code></pre></div>
<p><code>$(OS)</code> 環境変数は、Windows では <code>Windows_NT</code> が設定されます。Linux では通常未定義です。</p>
<h3 data-number="6.1.2" id="コンパイラとツールチェーンの違い"><span class="header-section-number">6.1.2</span> コンパイラとツールチェーンの違い</h3>
<table>
<thead>
<tr>
<th style="text-align: left;">項目</th>
<th style="text-align: left;">Linux (GCC)</th>
<th style="text-align: left;">Windows (MSVC)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">C コンパイラ</td>
<td style="text-align: left;">gcc</td>
<td style="text-align: left;">cl.exe</td>
</tr>
<tr>
<td style="text-align: left;">C++ コンパイラ</td>
<td style="text-align: left;">g++</td>
<td style="text-align: left;">cl.exe</td>
</tr>
<tr>
<td style="text-align: left;">リンカー</td>
<td style="text-align: left;">gcc/g++</td>
<td style="text-align: left;">link.exe</td>
</tr>
<tr>
<td style="text-align: left;">静的ライブラリ生成</td>
<td style="text-align: left;">ar</td>
<td style="text-align: left;">lib.exe</td>
</tr>
<tr>
<td style="text-align: left;">静的ライブラリ拡張</td>
<td style="text-align: left;">.a</td>
<td style="text-align: left;">.lib</td>
</tr>
<tr>
<td style="text-align: left;">共有ライブラリ拡張</td>
<td style="text-align: left;">.so</td>
<td style="text-align: left;">.dll</td>
</tr>
<tr>
<td style="text-align: left;">実行ファイル拡張</td>
<td style="text-align: left;">なし</td>
<td style="text-align: left;">.exe</td>
</tr>
<tr>
<td style="text-align: left;">オブジェクト拡張</td>
<td style="text-align: left;">.o</td>
<td style="text-align: left;">.obj</td>
</tr>
</tbody>
</table>
<h3 data-number="6.1.3" id="mingw-環境の活用"><span class="header-section-number">6.1.3</span> MinGW 環境の活用</h3>
<p>Windows 環境では、Git for Windows に付属する MinGW 環境を活用します。これにより：</p>
<ul>
<li><code>bash</code>, <code>pwd</code>, <code>dirname</code> などの Linux コマンドが使える</li>
<li><code>sh</code> コマンドで既存のシェルスクリプトを実行できる</li>
<li>makefw/cmnd/ 配下のシェルスクリプトがそのまま動作する</li>
<li>doxyfw の makefile がそのまま動作する</li>
</ul>
<h2 data-number="6.2" id="makefw-フレームワーク"><span class="header-section-number">6.2</span> makefw フレームワーク</h2>
<p>makefw は testfw から makefile 関連機能を切り出したフレームワークです：</p>
<ul>
<li><strong>testfw</strong>: テスト実行、モック、Google Test 統合に特化</li>
<li><strong>makefw</strong>: クロスプラットフォームビルドシステムに特化</li>
</ul>
<p>この分離により、ビルドシステムとテストフレームワークの責務が明確になりました。</p>
<h2 data-number="6.3" id="ライブラリ構成-1"><span class="header-section-number">6.3</span> ライブラリ構成</h2>
<p>本プロジェクトでは、以下の構成を採用しています：</p>
<ul>
<li><strong>libcalcbase</strong>: 静的ライブラリ (LIB_TYPE 変数未設定、デフォルトで static)</li>
<li><strong>libcalc</strong>: 動的ライブラリ (makepart.mk で <code>LIB_TYPE = shared</code> を指定)</li>
</ul>
<p>この構成により、以下のメリットがあります：</p>
<ol type="1">
<li>libcalc.dll/.so が calcbase を内部に静的リンクする</li>
<li>依存関係が単純化され、配布時に libcalc.dll/.so のみを配置すれば動作</li>
<li>Windows と Linux で同様の動作を実現</li>
</ol>
<h2 data-number="6.4" id="実装ファイル"><span class="header-section-number">6.4</span> 実装ファイル</h2>
<p><strong>フレームワーク:</strong></p>
<ul>
<li><code>makefw/makefiles/prepare.mk</code> - 準備処理</li>
<li><code>makefw/makefiles/makemain.mk</code> - テンプレート自動選択
<ul>
<li><code>makefw/makefiles/makelibsrc_c_cpp.mk</code> - C/C++ ライブラリビルド用テンプレート</li>
<li><code>makefw/makefiles/makesrc_c_cpp.mk</code> - C/C++ 実行ファイルビルド用テンプレート</li>
<li><code>makefw/makefiles/makelibsrc_dotnet.mk</code> - .NET ライブラリビルド用テンプレート</li>
<li><code>makefw/makefiles/makesrc_dotnet.mk</code> - .NET 実行ファイルビルド用テンプレート</li>
</ul></li>
</ul>
<p><strong>ライブラリ:</strong></p>
<ul>
<li><code>prod/calc/libsrc/calcbase/makefile</code> - calcbase ビルド定義 (LIB_TYPE 未設定 → static)</li>
<li><code>prod/calc/libsrc/calc/makefile</code> - calc ビルド定義</li>
<li><code>prod/calc/libsrc/calc/makepart.mk</code> - calc 固有設定 (LIB_TYPE = shared)</li>
</ul>
<p><strong>コマンド:</strong></p>
<ul>
<li><code>prod/calc/src/add/makefile</code> - add コマンド (calcbase のみリンク)</li>
<li><code>prod/calc/src/calc/makefile</code> - calc コマンド (calc のみリンク)</li>
<li><code>prod/calc/src/shared-and-static-calc/makefile</code> - shared-and-static-calc コマンド (calc + calcbase をリンク)</li>
</ul>
<p><strong>テスト:</strong></p>
<ul>
<li><code>test/makepart.mk</code> - テスト共通設定 (テストフレームワークリンク、警告レベル設定)</li>
<li><code>test/libsrc/mock_calcbase/makefile</code> - calcbase モックライブラリ</li>
<li><code>test/libsrc/mock_calc/makefile</code> - calc モックライブラリ</li>
<li><code>test/src/calc/libcalcbaseTest/addTest/makefile</code> - add 関数単体テスト</li>
<li><code>test/src/calc/main/addTest/makefile</code> - add コマンド統合テスト</li>
<li><code>test/src/calc/main/calcTest/makefile</code> - calc コマンド統合テスト</li>
<li><code>test/src/calc/main/shared-and-static-calcTest/makefile</code> - shared-and-static-calc 統合テスト</li>
</ul>
<h1 data-number="7" id="実装の特徴"><span class="header-section-number">7</span> 実装の特徴</h1>
<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th>項目</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td>クロスプラットフォーム</td>
<td>単一の makefile で Windows/Linux 両対応</td>
</tr>
<tr>
<td>OS 判定</td>
<td>makefw テンプレートが自動処理</td>
</tr>
<tr>
<td>ライブラリ構成</td>
<td>makepart.mk で柔軟に設定可能</td>
</tr>
<tr>
<td>依存関係解決</td>
<td><code>LIBS</code> 変数による明示的な指定</td>
</tr>
<tr>
<td>静的リンク自動化</td>
<td>動的ライブラリビルド時に静的ライブラリを自動検索・リンク</td>
</tr>
<tr>
<td>テストフレームワーク統合</td>
<td><code>LINK_TEST = 1</code> で Google Test を自動リンク</td>
</tr>
<tr>
<td>モック機能</td>
<td>testfw のインクルードオーバーライド機能によるモック</td>
</tr>
</tbody>
</table>
<h1 data-number="8" id="デバッグ"><span class="header-section-number">8</span> デバッグ</h1>
<p>makefw テンプレートには <code>debug</code> ターゲットがあり、設定された変数を表示できます：</p>
<p><strong>calcbase のデバッグ:</strong></p>
<p>Windows:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode cmd"><code class="sourceCode dosbat"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> prod\calc\libsrc\calcbase</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>make debug</span></code></pre></div>
<p>Linux:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> prod/calc/libsrc/calcbase</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> debug</span></code></pre></div>
<p>出力例 (Windows の場合):</p>
<pre class="text"><code>TARGET = libcalcbase.lib
LIB_TYPE = static
OS = Windows_NT
LIBS =
STATIC_LIBS =
OBJS = obj/add.obj</code></pre>
<p><strong>calc のデバッグ:</strong></p>
<p>Windows:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode cmd"><code class="sourceCode dosbat"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> prod\calc\libsrc\calc</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>make debug</span></code></pre></div>
<p>Linux:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> prod/calc/libsrc/calc</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> debug</span></code></pre></div>
<p>出力例 (Windows の場合、makepart.mk で LIB_TYPE=shared 設定済み):</p>
<pre class="text"><code>TARGET = libcalc.dll
LIB_TYPE = shared
OS = Windows_NT
LIBS = calcbase
STATIC_LIBS = C:/path/to/prod/calc/lib/libcalcbase.lib
OBJS = obj/calcHandler.obj</code></pre>
<h1 data-number="9" id="現在の制限事項"><span class="header-section-number">9</span> 現在の制限事項</h1>
<ol type="1">
<li><strong>ライブラリ構成の固定</strong>
<ul>
<li>libcalcbase は静的ライブラリとして実装 (makepart.mk で変更可能だが、依存関係上推奨しない)</li>
<li>libcalc は動的ライブラリとして実装 (makepart.mk で <code>LIB_TYPE = shared</code> 設定済み)</li>
</ul></li>
<li><strong>testfw 機能との分離</strong>
<ul>
<li>makefw はビルドシステムのみを提供</li>
<li>テスト機能 (inject, filter, モック) は testfw が提供</li>
</ul></li>
<li><strong>ライブラリ検索パス</strong>
<ul>
<li><code>LIBSDIR</code> で指定されたパスから検索</li>
<li>prepare.mk により、以下のデフォルトパスが設定されます：
<ul>
<li><code>$(WORKSPACE_FOLDER)/prod/calc/lib</code></li>
<li><code>$(WORKSPACE_FOLDER)/test/lib</code></li>
</ul></li>
</ul></li>
</ol>
<h1 data-number="10" id="今後の拡張可能性"><span class="header-section-number">10</span> 今後の拡張可能性</h1>
<ol type="1">
<li><strong>より高度な依存関係解決</strong>
<ul>
<li><code>-L</code> オプションの追加サポート</li>
<li>システムライブラリパスの自動検索</li>
</ul></li>
<li><strong>ビルド最適化</strong>
<ul>
<li>並列ビルドのさらなる最適化</li>
<li>インクリメンタルビルドの改善</li>
</ul></li>
<li><strong>プラットフォーム拡張</strong>
<ul>
<li>macOS サポート</li>
<li>その他のコンパイラサポート (Clang など)</li>
</ul></li>
</ol>
<h1 data-number="11" id="実装のベストプラクティスと重要なノート"><span class="header-section-number">11</span> 実装のベストプラクティスと重要なノート</h1>
<p>このセクションでは、クロスプラットフォーム対応の実装で得られた重要な知見とベストプラクティスを説明します。</p>
<h2 data-number="11.1" id="環境設定スクリプト"><span class="header-section-number">11.1</span> 環境設定スクリプト</h2>
<p>Windows 環境では、<code>Start-VSCode-With-Env.ps1</code> で環境設定を行う必要があります。VS Code を起動せず環境変数のみを設定する場合は、<code>-EnvOnly</code> パラメータを指定してドットソースで実行します。</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode powershell"><code class="sourceCode powershell"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="op">.</span> <span class="op">.</span>\Start-VSCode-With-Env<span class="op">.</span><span class="fu">ps1</span> <span class="op">-</span>EnvOnly</span></code></pre></div>
<h2 data-number="11.2" id="utf-8-ソースコードへの対応"><span class="header-section-number">11.2</span> UTF-8 ソースコードへの対応</h2>
<p>ソースコードが UTF-8 で記述されている場合、MSVC のコンパイル時に <code>/utf-8</code> オプションを追加する必要があります。</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="dt">CFLAGS</span> <span class="ch">:=</span><span class="st"> /W4 /Zi /TC /nologo /utf-8 /I</span><span class="ch">$(</span><span class="dt">WORKSPACE_FOLDER</span><span class="ch">)</span><span class="st">/prod/calc/include</span></span></code></pre></div>
<p>このオプションを指定しないと、以下の警告が発生します：</p>
<pre class="text"><code>warning C4819: The file contains a character that cannot be represented
in the current code page (932). Save the file in Unicode format to prevent data loss</code></pre>
<h2 data-number="11.3" id="pdb-ファイルの適切な配置"><span class="header-section-number">11.3</span> PDB ファイルの適切な配置</h2>
<p>MSVC のデバッグ情報ファイル (PDB) は、以下のように配置します。</p>
<h3 data-number="11.3.1" id="ライブラリの-pdb"><span class="header-section-number">11.3.1</span> ライブラリの PDB</h3>
<p>ライブラリファイル (.lib) と同じディレクトリに配置します。</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="dt">CFLAGS</span> <span class="ch">:=</span><span class="st"> /W4 /Zi /TC /nologo /utf-8 /FS /Fd</span><span class="ch">$(</span><span class="dt">OUTPUT_DIR</span><span class="ch">)</span><span class="st">/libcalc.pdb /I...</span></span></code></pre></div>
<p>生成結果：</p>
<pre class="text"><code>prod/calc/lib/
+-- libcalc.lib
+-- libcalc.pdb</code></pre>
<h3 data-number="11.3.2" id="実行ファイルの-pdb"><span class="header-section-number">11.3.2</span> 実行ファイルの PDB</h3>
<p>実行ファイルと同じディレクトリに配置します。コンパイル時の中間 PDB は obj ディレクトリに配置します。</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="dt">CFLAGS</span> <span class="ch">:=</span><span class="st"> /W4 /Zi /TC /nologo /utf-8 /Fd</span><span class="ch">$(</span><span class="dt">OBJDIR</span><span class="ch">)</span><span class="st">/add.pdb /I...</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="dt">LDFLAGS</span> <span class="ch">:=</span><span class="st"> /DEBUG /PDB:</span><span class="ch">$(</span><span class="dt">OUTPUT_DIR</span><span class="ch">)</span><span class="st">/add.pdb /LIBPATH:...</span></span></code></pre></div>
<p>生成結果：</p>
<pre class="text"><code>prod/calc/src/add/
+-- add.exe
+-- add.pdb     (リンク時の PDB、実行ファイルと同じ場所)
+-- obj/
    +-- add.obj
    +-- add.pdb (コンパイル時の PDB、obj ディレクトリ)</code></pre>
<h2 data-number="11.4" id="fs-オプションの追加"><span class="header-section-number">11.4</span> /FS オプションの追加</h2>
<p>複数のソースファイルが同じ PDB ファイルに同時に書き込む場合、<code>/FS</code> オプションを追加して同期を保証する必要があります。</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="dt">CFLAGS</span> <span class="ch">:=</span><span class="st"> /W4 /Zi /TC /nologo /utf-8 /FS /Fd</span><span class="ch">$(</span><span class="dt">OUTPUT_DIR</span><span class="ch">)</span><span class="st">/calc.pdb /I...</span></span></code></pre></div>
<p>このオプションを指定しないと、以下のエラーが発生することがあります：</p>
<pre class="text"><code>fatal error C1041: cannot open program database &#39;calc.pdb&#39;;
if multiple CL.EXE write to the same .PDB file, please use /FS</code></pre>
<h2 data-number="11.5" id="workspace_folder-のパス変換"><span class="header-section-number">11.5</span> WORKSPACE_FOLDER のパス変換</h2>
<p>makefile 内で Unix スタイルのパス (<code>/d/Users/...</code>) を取得した場合、MSVC はこのパスを認識できません。<code>cygpath -w</code> を使用して Windows スタイルのパス (<code>D:\Users\...</code>) に変換する必要があります。</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="dt">WORKSPACE_FOLDER</span> <span class="ch">:=</span><span class="st"> </span><span class="ch">$(</span><span class="kw">shell</span><span class="st"> \</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="st">    dir=`pwd`; \</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="st">    while [ &quot;</span><span class="ch">$$</span><span class="st">dir&quot; != &quot;/&quot; ]; do \</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="st">        if [ -f &quot;</span><span class="ch">$$</span><span class="st">dir/.workspaceRoot&quot; ]; then \</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="st">            cygpath -w &quot;</span><span class="ch">$$</span><span class="st">dir&quot; 2&gt;/dev/null || echo </span><span class="ch">$$</span><span class="st">dir; \</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="st">            break; \</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="st">        fi; \</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="st">        dir=</span><span class="ch">$$</span><span class="st">(dirname </span><span class="ch">$$</span><span class="st">dir); \</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="st">    done \</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="ch">)</span></span></code></pre></div>
<p><code>cygpath -w</code> が利用できない環境では、<code>echo $$dir</code> にフォールバックします。</p>
<h2 data-number="11.6" id="ディレクトリの依存関係"><span class="header-section-number">11.6</span> ディレクトリの依存関係</h2>
<p>PDB ファイルを OUTPUT_DIR に出力する場合、コンパイルルールに OUTPUT_DIR の依存関係を追加する必要があります。</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="dv">$(OBJDIR)/%$(OBJEXT):</span><span class="dt"> %.c | </span><span class="ch">$(</span><span class="dt">OBJDIR</span><span class="ch">)</span><span class="dt"> </span><span class="ch">$(</span><span class="dt">OUTPUT_DIR</span><span class="ch">)</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="er">    </span><span class="ch">$(</span><span class="dt">CC</span><span class="ch">)</span> <span class="ch">$(</span><span class="dt">CFLAGS</span><span class="ch">)</span> /c /Fo<span class="ch">$@</span> <span class="ch">$&lt;</span></span></code></pre></div>
<p>これにより、コンパイル前に OUTPUT_DIR が作成されることが保証されます。</p>
<h2 data-number="11.7" id="clean-ターゲットの実装"><span class="header-section-number">11.7</span> clean ターゲットの実装</h2>
<p>Windows 環境では、clean ターゲットで PDB ファイルも削除する必要があります。</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="ot">.PHONY:</span><span class="dt"> clean</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="dv">clean:</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="er">    </span>rm -rf <span class="ch">$(</span><span class="dt">OBJDIR</span><span class="ch">)</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    rm -f <span class="ch">$(</span><span class="dt">OUTPUT_DIR</span><span class="ch">)</span>/<span class="ch">$(</span><span class="dt">TARGET</span><span class="ch">)</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="cf">ifeq</span> (<span class="ch">$(</span><span class="dt">OS</span><span class="ch">)</span>,Windows_NT)</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    rm -f <span class="ch">$(</span><span class="dt">OUTPUT_DIR</span><span class="ch">)</span>/*.pdb</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="cf">endif</span></span></code></pre></div>
<p>obj ディレクトリの削除により、コンパイル時の PDB と ILK ファイルが削除されます。OUTPUT_DIR に配置されたリンク時の PDB ファイルのみ、明示的に削除します。</p>
<h1 data-number="12" id="まとめと今後の展望"><span class="header-section-number">12</span> まとめと今後の展望</h1>
<h2 data-number="12.1" id="採用した方針"><span class="header-section-number">12.1</span> 採用した方針</h2>
<p>本プロジェクトのクロスプラットフォーム対応では、以下の方針を採用しました：</p>
<ul>
<li><strong>OS 判定による条件分岐</strong>: コンパイラとツールを切り替え</li>
<li><strong>MinGW 環境の活用</strong>: 既存のシェルスクリプトとシェルコマンドを利用</li>
<li><strong>makefw フレームワーク</strong>: testfw から切り出し、クロスプラットフォーム対応</li>
<li><strong>既存コードの保護</strong>: Linux 環境では既存の動作を完全に維持</li>
</ul>
<h2 data-number="12.2" id="メリット"><span class="header-section-number">12.2</span> メリット</h2>
<ul>
<li><strong>再利用性</strong>: makefw がクロスプラットフォーム対応され、他のプロジェクトでも利用できる</li>
<li><strong>保守性</strong>: Linux と Windows で同じ makefile を使用できるため、メンテナンス性が向上</li>
<li><strong>互換性</strong>: MinGW 環境により、既存のシェルスクリプトとシェルコマンドを活用できる</li>
<li><strong>ネイティブ性</strong>: MSVC を使用することで、Windows ネイティブなバイナリを生成できる</li>
<li><strong>安定性</strong>: Linux の動作は完全に維持される</li>
</ul>
<h2 data-number="12.3" id="注意点"><span class="header-section-number">12.3</span> 注意点</h2>
<ul>
<li><strong>makefw の共有</strong>: makefw は複数のプロジェクトで共有されるため、変更時には慎重に行う</li>
<li><strong>コンパイラフラグ</strong>: MSVC と GCC でコンパイラフラグが異なるため、makepart.mk の条件分岐を慎重に設定</li>
<li><strong>環境設定順序</strong>: Windows では環境設定スクリプトを必ず正しい順序で実行</li>
<li><strong>MinGW 必須</strong>: doxyfw は MinGW の bash を前提としているため、Windows では MinGW 環境が必須</li>
<li><strong>テストライブラリ</strong>: テストを実行する場合、Windows 版の Google Test ライブラリが必要</li>
<li><strong>文字コード</strong>: ソースコードが UTF-8 の場合、MSVC では <code>/utf-8</code> オプションが必要</li>
</ul>
            </div>
    </div>
  </div>
  <script src="https://vjs.zencdn.net/5.4.4/video.js"></script>

  <!-- ============================================================
       展開可能リスト (collapsible-list) 変換スクリプト

       このスクリプトは .collapsible-list クラスを持つ要素内の
       ネストされたリストを <details>/<summary> 構造に変換します。

       - 対象: .collapsible-list 内の子要素 (<ul>/<ol>) を持つ <li>
       - 動作: デフォルトで折りたたみ、クリックで展開
       - 通常のリストには影響しません
       - ブラウザの「戻る」で状態を復元します (sessionStorage)

       詳細は docs-src/collapsible-list.md を参照してください。
       ============================================================ -->
  <script>
  (function() {
    document.addEventListener('DOMContentLoaded', function() {
      // .collapsible-list 内のすべての li 要素を処理
      var containers = document.querySelectorAll('.collapsible-list');
      containers.forEach(function(container) {
        var listItems = container.querySelectorAll('li');
        listItems.forEach(function(li) {
          // 子要素として ul または ol を持つかチェック
          var childList = li.querySelector(':scope > ul, :scope > ol');
          if (!childList) return;

          // 既に details でラップされている場合はスキップ
          if (li.querySelector(':scope > details')) return;

          // li の直接のテキストコンテンツと要素を取得
          var summaryContent = [];
          var nodesToMove = [];

          // 子ノードを走査
          Array.from(li.childNodes).forEach(function(node) {
            if (node === childList) return;
            if (node.nodeType === Node.TEXT_NODE ||
                (node.nodeType === Node.ELEMENT_NODE &&
                 node.tagName !== 'UL' && node.tagName !== 'OL')) {
              summaryContent.push(node.cloneNode(true));
              nodesToMove.push(node);
            }
          });

          // details/summary 構造を作成
          var details = document.createElement('details');
          var summary = document.createElement('summary');

          // summary にコンテンツを追加
          summaryContent.forEach(function(node) {
            summary.appendChild(node);
          });

          // 元のノードを削除
          nodesToMove.forEach(function(node) {
            li.removeChild(node);
          });

          // details 構造を組み立て
          details.appendChild(summary);

          // 子リストを details に移動
          li.removeChild(childList);
          details.appendChild(childList);

          // li に details を挿入
          li.insertBefore(details, li.firstChild);
        });
      });

      // ============================================================
      // 折りたたみ状態の保存・復元
      //
      // sessionStorage を使用して、ブラウザの「戻る」操作時に
      // 折りたたみ状態を復元します。
      // 初回表示時は全て折りたたみ (デフォルト)、
      // 「戻る」操作時のみ以前の状態を復元します。
      // ============================================================

      var storageKey = 'collapsible-state:' + window.location.pathname;
      var allDetails = document.querySelectorAll('.collapsible-list details');

      if (allDetails.length === 0) return;

      // ナビゲーション種別の判定: back_forward のみ状態を復元
      var isBackForward = false;
      try {
        var navEntries = performance.getEntriesByType('navigation');
        if (navEntries.length > 0) {
          isBackForward = navEntries[0].type === 'back_forward';
        } else if (performance.navigation) {
          // フォールバック (非推奨 API)
          isBackForward = performance.navigation.type === 2;
        }
      } catch (e) {
        // performance API が利用できない場合は復元しない
      }

      // 「戻る」操作時のみ状態を復元
      if (isBackForward) {
        try {
          var savedState = sessionStorage.getItem(storageKey);
          if (savedState) {
            var state = JSON.parse(savedState);
            allDetails.forEach(function(details, index) {
              if (state[index]) {
                details.open = true;
              }
            });
          }
        } catch (e) {
          // sessionStorage の読み込みエラーは無視
        }
      }

      // 状態変更時に sessionStorage へ保存
      function saveState() {
        try {
          var state = {};
          allDetails.forEach(function(details, index) {
            if (details.open) {
              state[index] = true;
            }
          });
          sessionStorage.setItem(storageKey, JSON.stringify(state));
        } catch (e) {
          // sessionStorage の書き込みエラーは無視
        }
      }

      allDetails.forEach(function(details) {
        details.addEventListener('toggle', saveState);
      });
    });
  })();
  </script>

</body>
</html>
