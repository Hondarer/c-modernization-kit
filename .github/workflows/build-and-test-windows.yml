name: Build and Test (Windows)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: windows-2025

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install OpenCppCoverage
        run: |
          choco install opencppcoverage -y

          # PATH に追加 (GitHub Actions の永続化メカニズムを使用)
          $opencppPath = "C:\Program Files\OpenCppCoverage"
          if (Test-Path $opencppPath) {
              Write-Host "`nAdding OpenCppCoverage to PATH..."
              Add-Content -Path $env:GITHUB_PATH -Value $opencppPath
              Write-Host "PATH addition completed."
          } else {
              Write-Host "ERROR: OpenCppCoverage installation directory not found at $opencppPath"
              exit 1
          }
        shell: pwsh

      - name: Install ReportGenerator
        run: dotnet tool install --global dotnet-reportgenerator-globaltool
        shell: pwsh

      - name: Setup MSVC environment
        run: |
          & "${{ github.workspace }}\.github\workflows\Add-VSBT-Env-x64.ps1"
        shell: pwsh

      - name: Build
        run: make
        shell: pwsh

      - name: Run tests
        run: make test
        shell: pwsh

      - name: Upload test results artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.repository.name }}-windows-test-results-${{ github.sha }}
          path: test/**/results/
          if-no-files-found: warn
