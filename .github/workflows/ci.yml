name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: write

jobs:
  build-and-docs:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/hondarer/oracle-linux-8-container/oracle-linux-8-dev:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
      env:
        HOST_USER: user
        HOST_UID: 1001
        HOST_GID: 127

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 全履歴を取得 (git log 用: Markdown 処理時に author と date を取得するため)
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git safe directory
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Initialize submodules (shallow)
        run: git submodule update --init --recursive --depth 1

      - name: Build and run tests
        run: make && make test

      - name: Generate and publish documentation
        run: make doxy && make docs

      - name: Create artifact archives for gh-pages
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          shopt -s globstar nullglob
          mkdir -p docs/artifacts
          # HTML ドキュメント
          html_files=(docs/doxygen docs/**/html)
          [ ${#html_files[@]} -gt 0 ] && zip -r docs/artifacts/docs-html.zip "${html_files[@]}" || true
          # DOCX ドキュメント
          docx_files=(docs/**/docx/)
          [ ${#docx_files[@]} -gt 0 ] && zip -r docs/artifacts/docs-docx.zip "${docx_files[@]}" || true
          # テスト結果
          test_files=(test/**/results/)
          [ ${#test_files[@]} -gt 0 ] && zip -r docs/artifacts/test-results.zip "${test_files[@]}" || true

      - name: Deploy to gh-pages
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          force_orphan: true

      - name: Upload html artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.repository.name }}-docs-html-${{ github.sha }}
          path: |
            docs/doxygen
            docs/**/html
          if-no-files-found: warn

      - name: Upload docx artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.repository.name }}-docs-docx-${{ github.sha }}
          path: docs/**/docx/
          if-no-files-found: warn

      - name: Upload test results artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.repository.name }}-test-results-${{ github.sha }}
          path: test/**/results/
          if-no-files-found: warn
