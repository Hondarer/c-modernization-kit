<!doctype html>
<html >
<head>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="Content-Style-Type" content="text/css" />

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/template.css" />

    <link href="https://vjs.zencdn.net/5.4.4/video-js.css" rel="stylesheet" />

    <script src="https://code.jquery.com/jquery-2.2.1.min.js"></script>

    <script type='text/javascript' src='https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/js/jquery.cookie.js'></script>
    <script type='text/javascript' src='https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/js/jquery.hoverIntent.minified.js'></script>
    <script type='text/javascript' src='https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/js/jquery.dcjqaccordion.2.7.min.js'></script>

    <link href="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/css/skins/blue.css" rel="stylesheet" type="text/css" />
    <link href="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/css/skins/graphite.css" rel="stylesheet" type="text/css" />
    <link href="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/css/skins/grey.css" rel="stylesheet" type="text/css" />
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script src="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/script.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/jquery.sticky-kit.js"></script>
    
    <meta name="generator" content="pandoc" />
  <meta name="author" content="Tetsuo Honda" />
  <title>MSVC ランタイムライブラリのリンクモデル</title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="html-style.css" />
</head>
<body>

    
    <div class="navbar navbar-static-top">
    <div class="navbar-inner">
      <div class="container">
        <span class="doc-title">MSVC ランタイムライブラリのリンクモデル</span>
        <ul class="nav pull-right doc-info">
                    <li><p class="navbar-text">Tetsuo Honda</p></li>
                              <li><p class="navbar-text">Thu, 6 Nov 2025 05:21:51 +0900 cffda3b</p></li>
                  </ul>
      </div>
    </div>
  </div>
    <div class="container">
    <div class="row">
            <div id="TOC" class="span3">
        <div class="well toc">

        <ul>
        <li><a href="#はじめに" id="toc-はじめに"><span class="toc-section-number">1</span> はじめに</a></li>
        <li><a href="#ランタイムライブラリとは" id="toc-ランタイムライブラリとは"><span class="toc-section-number">2</span> ランタイムライブラリとは</a></li>
        <li><a href="#ランタイムリンクモデルの種類" id="toc-ランタイムリンクモデルの種類"><span class="toc-section-number">3</span> ランタイムリンクモデルの種類</a>
        <ul>
        <li><a href="#mt-静的ランタイムライブラリ" id="toc-mt-静的ランタイムライブラリ"><span class="toc-section-number">3.1</span> /MT (静的ランタイムライブラリ)</a></li>
        <li><a href="#md-動的ランタイムライブラリ" id="toc-md-動的ランタイムライブラリ"><span class="toc-section-number">3.2</span> /MD (動的ランタイムライブラリ)</a></li>
        </ul></li>
        <li><a href="#mt-と-md-の主な違い" id="toc-mt-と-md-の主な違い"><span class="toc-section-number">4</span> /MT と /MD の主な違い</a></li>
        <li><a href="#混在時の問題" id="toc-混在時の問題"><span class="toc-section-number">5</span> 混在時の問題</a>
        <ul>
        <li><a href="#異なるヒープの使用によるクラッシュ" id="toc-異なるヒープの使用によるクラッシュ"><span class="toc-section-number">5.1</span> 異なるヒープの使用によるクラッシュ</a></li>
        <li><a href="#グローバル変数の二重インスタンス" id="toc-グローバル変数の二重インスタンス"><span class="toc-section-number">5.2</span> グローバル変数の二重インスタンス</a></li>
        <li><a href="#リンカー警告-lnk4098" id="toc-リンカー警告-lnk4098"><span class="toc-section-number">5.3</span> リンカー警告 LNK4098</a></li>
        </ul></li>
        <li><a href="#プロジェクトでの推奨事項" id="toc-プロジェクトでの推奨事項"><span class="toc-section-number">6</span> プロジェクトでの推奨事項</a>
        <ul>
        <li><a href="#基本原則" id="toc-基本原則"><span class="toc-section-number">6.1</span> 基本原則</a></li>
        <li><a href="#md-を推奨する理由" id="toc-md-を推奨する理由"><span class="toc-section-number">6.2</span> /MD を推奨する理由</a></li>
        <li><a href="#mt-を選択するケース" id="toc-mt-を選択するケース"><span class="toc-section-number">6.3</span> /MT を選択するケース</a></li>
        <li><a href="#本プロジェクトでの選択" id="toc-本プロジェクトでの選択"><span class="toc-section-number">6.4</span> 本プロジェクトでの選択</a></li>
        </ul></li>
        <li><a href="#ビルド設定" id="toc-ビルド設定"><span class="toc-section-number">7</span> ビルド設定</a>
        <ul>
        <li><a href="#静的ライブラリ-calcbase.lib" id="toc-静的ライブラリ-calcbase.lib"><span class="toc-section-number">7.1</span> 静的ライブラリ (calcbase.lib)</a></li>
        <li><a href="#動的リンクライブラリ-calc.dll" id="toc-動的リンクライブラリ-calc.dll"><span class="toc-section-number">7.2</span> 動的リンクライブラリ (calc.dll)</a></li>
        <li><a href="#実行ファイル-add.exe" id="toc-実行ファイル-add.exe"><span class="toc-section-number">7.3</span> 実行ファイル (add.exe)</a></li>
        </ul></li>
        <li><a href="#実行環境の準備" id="toc-実行環境の準備"><span class="toc-section-number">8</span> 実行環境の準備</a>
        <ul>
        <li><a href="#再頒布可能パッケージの入手" id="toc-再頒布可能パッケージの入手"><span class="toc-section-number">8.1</span> 再頒布可能パッケージの入手</a></li>
        <li><a href="#インストール" id="toc-インストール"><span class="toc-section-number">8.2</span> インストール</a></li>
        </ul></li>
        <li><a href="#まとめ" id="toc-まとめ"><span class="toc-section-number">9</span> まとめ</a>
        <ul>
        <li><a href="#重要なポイント" id="toc-重要なポイント"><span class="toc-section-number">9.1</span> 重要なポイント</a></li>
        </ul></li>
        <li><a href="#参考リンク" id="toc-参考リンク"><span class="toc-section-number">10</span> 参考リンク</a></li>
        </ul>

        </div>
      </div>
            <div class="span9">

                <H1>MSVC ランタイムライブラリのリンクモデル</H1>
      
      
      <h1 data-number="1" id="はじめに"><span class="header-section-number">1</span> はじめに</h1>
<p>本ドキュメントは、MSVC (Microsoft Visual C++) におけるランタイムライブラリのリンクモデル (<code>/MT</code> と <code>/MD</code>) の違いと、プロジェクト全体で適切なモデルを選択する重要性について説明します。</p>
<p>Windows 環境で C/C++ プログラムをビルドする際、ランタイムライブラリ (C ランタイム) のリンク方法を <code>/MT</code> (静的リンク) または <code>/MD</code> (動的リンク) で指定する必要があります。この選択は、実行ファイル (.exe)、静的ライブラリ (.lib)、動的リンクライブラリ (.dll) のすべてに影響し、誤った組み合わせは実行時のクラッシュやメモリ破壊の原因となります。</p>
<h1 data-number="2" id="ランタイムライブラリとは"><span class="header-section-number">2</span> ランタイムライブラリとは</h1>
<p>ランタイムライブラリは、プログラムの実行に必要な基本的な機能を提供するライブラリです。C ランタイムライブラリには、以下のような関数が含まれます。</p>
<ul>
<li>メモリ管理関数 (<code>malloc</code>, <code>free</code>, <code>new</code>, <code>delete</code>)</li>
<li>入出力関数 (<code>printf</code>, <code>scanf</code>, <code>fopen</code>, <code>fclose</code>)</li>
<li>文字列操作関数 (<code>strcpy</code>, <code>strlen</code>, <code>strcmp</code>)</li>
<li>数学関数 (<code>sin</code>, <code>cos</code>, <code>sqrt</code>)</li>
<li>グローバル変数 (<code>errno</code>, <code>stdin</code>, <code>stdout</code>, <code>stderr</code>)</li>
</ul>
<p>すべての C/C++ プログラムは、これらの関数を直接的または間接的に使用するため、ランタイムライブラリが必要です。</p>
<h1 data-number="3" id="ランタイムリンクモデルの種類"><span class="header-section-number">3</span> ランタイムリンクモデルの種類</h1>
<p>MSVC では、ランタイムライブラリのリンク方法として <code>/MT</code> と <code>/MD</code> の2種類が提供されています。</p>
<h2 data-number="3.1" id="mt-静的ランタイムライブラリ"><span class="header-section-number">3.1</span> /MT (静的ランタイムライブラリ)</h2>
<p>C ランタイムライブラリのコードが、最終的な実行ファイルや DLL に直接埋め込まれます。</p>
<p><strong>使用されるライブラリファイル</strong></p>
<ul>
<li><code>LIBCMT.lib</code> (リリースビルド)</li>
<li><code>LIBCMTD.lib</code> (デバッグビルド、<code>/MTd</code>)</li>
</ul>
<p><strong>特徴</strong></p>
<ul>
<li>実行ファイルのサイズが大きくなる (ランタイムコードが埋め込まれるため)</li>
<li>実行時に追加の DLL (<code>vcruntime140.dll</code> など) が不要</li>
<li>配布が簡単 (実行ファイル単体で動作)</li>
<li>各モジュール (exe, dll) が独立したランタイムライブラリのコピーを持つ</li>
</ul>
<h2 data-number="3.2" id="md-動的ランタイムライブラリ"><span class="header-section-number">3.2</span> /MD (動的ランタイムライブラリ)</h2>
<p>C ランタイムライブラリのコードは実行ファイルには埋め込まれず、実行時に専用の DLL を動的にロードして使用します。</p>
<p><strong>使用されるライブラリファイル</strong></p>
<ul>
<li><code>MSVCRT.lib</code> (インポートライブラリ、リリースビルド)</li>
<li><code>MSVCRTD.lib</code> (インポートライブラリ、デバッグビルド、<code>/MDd</code>)</li>
</ul>
<p><strong>実行時に必要な DLL</strong></p>
<ul>
<li><code>vcruntime140.dll</code> (Visual Studio 2015 以降)</li>
<li><code>msvcp140.dll</code> (C++ 標準ライブラリ、C++ プログラムの場合)</li>
<li><code>ucrtbase.dll</code> (Universal CRT)</li>
</ul>
<p><strong>特徴</strong></p>
<ul>
<li>実行ファイルのサイズが小さくなる (ランタイムコードが含まれないため)</li>
<li>実行時に上記の DLL が必要</li>
<li>複数のモジュール (exe, dll) が同じランタイムライブラリインスタンスを共有</li>
<li>メモリ効率が良い (複数のプロセスで DLL を共有)</li>
</ul>
<h1 data-number="4" id="mt-と-md-の主な違い"><span class="header-section-number">4</span> /MT と /MD の主な違い</h1>
<p>以下の表は、<code>/MT</code> と <code>/MD</code> の主な違いをまとめたものです。</p>
<table>
<colgroup>
<col style="width: 42%" />
<col style="width: 28%" />
<col style="width: 28%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">項目</th>
<th style="text-align: left;">/MT (静的)</th>
<th style="text-align: left;">/MD (動的)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">ランタイムコードの配置</td>
<td style="text-align: left;">実行ファイルに埋め込み</td>
<td style="text-align: left;">DLL として分離</td>
</tr>
<tr>
<td style="text-align: left;">実行ファイルのサイズ</td>
<td style="text-align: left;">大きい</td>
<td style="text-align: left;">小さい</td>
</tr>
<tr>
<td style="text-align: left;">配布に必要なファイル</td>
<td style="text-align: left;">実行ファイルのみ</td>
<td style="text-align: left;">実行ファイル + ランタイム DLL</td>
</tr>
<tr>
<td style="text-align: left;">メモリ使用量</td>
<td style="text-align: left;">各モジュールが独立したコピーを持つため大きい</td>
<td style="text-align: left;">複数モジュールで共有するため小さい</td>
</tr>
<tr>
<td style="text-align: left;">リンク時のライブラリファイル</td>
<td style="text-align: left;"><code>LIBCMT.lib</code></td>
<td style="text-align: left;"><code>MSVCRT.lib</code> (インポートライブラリ)</td>
</tr>
<tr>
<td style="text-align: left;">モジュール間でのランタイム共有</td>
<td style="text-align: left;">不可 (各モジュールが独立)</td>
<td style="text-align: left;">可 (同じ DLL を共有)</td>
</tr>
</tbody>
</table>
<h1 data-number="5" id="混在時の問題"><span class="header-section-number">5</span> 混在時の問題</h1>
<p>異なるランタイムリンクモデル (<code>/MT</code> と <code>/MD</code>) でビルドされたモジュール (実行ファイル、静的ライブラリ、DLL) を混在させると、以下の深刻な問題が発生します。</p>
<h2 data-number="5.1" id="異なるヒープの使用によるクラッシュ"><span class="header-section-number">5.1</span> 異なるヒープの使用によるクラッシュ</h2>
<p><code>/MT</code> と <code>/MD</code> では、それぞれ独立したヒープマネージャーが使用されます。一方のヒープで確保したメモリを他方で解放しようとすると、クラッシュが発生します。</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">// libfoo.lib (/MT でビルド) 内の関数</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span><span class="op">*</span> create_buffer<span class="op">(</span><span class="dt">void</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> malloc<span class="op">(</span><span class="dv">100</span><span class="op">);</span>  <span class="co">// /MT のヒープで確保</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co">// main.exe (/MD でビルド) 内</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">void</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span><span class="op">*</span> p <span class="op">=</span> create_buffer<span class="op">();</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    free<span class="op">(</span>p<span class="op">);</span>  <span class="co">// /MD のヒープで解放 → クラッシュ!</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<div data-custom-style="Source Code Caption">
ヒープ不一致の例
</div>
<h2 data-number="5.2" id="グローバル変数の二重インスタンス"><span class="header-section-number">5.2</span> グローバル変数の二重インスタンス</h2>
<p>C ランタイムのグローバル変数 (例: <code>errno</code>, <code>stdin</code>, <code>stdout</code>) が、<code>/MT</code> と <code>/MD</code> のモジュールでそれぞれ別のインスタンスとして存在します。一方で設定した値が他方では反映されず、意図しない動作が発生します。</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">// libfoo.lib (/MT でビルド) 内の関数</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> set_error<span class="op">(</span><span class="dt">void</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    errno <span class="op">=</span> EINVAL<span class="op">;</span>  <span class="co">// /MT の errno に設定</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co">// main.exe (/MD でビルド) 内</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">void</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    set_error<span class="op">();</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;errno = </span><span class="sc">%d\n</span><span class="st">&quot;</span><span class="op">,</span> errno<span class="op">);</span>  <span class="co">// /MD の errno を参照 → 0 (変更されていない!)</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<div data-custom-style="Source Code Caption">
errno の二重インスタンス
</div>
<h2 data-number="5.3" id="リンカー警告-lnk4098"><span class="header-section-number">5.3</span> リンカー警告 LNK4098</h2>
<p>異なるランタイムライブラリが混在している場合、リンカーは以下の警告を出力します。</p>
<pre class="text"><code>LINK : warning LNK4098: defaultlib &#39;LIBCMT&#39; conflicts with use of other libs; use /NODEFAULTLIB:library</code></pre>
<p>この警告は、プロジェクト内でランタイムリンクモデルが統一されていないことを示しています。この警告を無視すると、上記のようなクラッシュやメモリ破壊が発生する可能性があります。</p>
<h1 data-number="6" id="プロジェクトでの推奨事項"><span class="header-section-number">6</span> プロジェクトでの推奨事項</h1>
<h2 data-number="6.1" id="基本原則"><span class="header-section-number">6.1</span> 基本原則</h2>
<p><strong>プロジェクト全体で同じランタイムリンクモデルを使用する</strong></p>
<p>すべての実行ファイル、静的ライブラリ、DLL を同じモデル (<code>/MT</code> または <code>/MD</code>) でビルドする必要があります。</p>
<h2 data-number="6.2" id="md-を推奨する理由"><span class="header-section-number">6.2</span> /MD を推奨する理由</h2>
<p>Microsoft 公式ドキュメントでは、特に DLL を含むプロジェクトでは <code>/MD</code> の使用を推奨しています。理由は以下の通りです。</p>
<p><strong>DLL との親和性</strong></p>
<p>DLL は複数の実行ファイルから呼び出される可能性があります。<code>/MD</code> を使用することで、すべての DLL と実行ファイルが同じランタイムライブラリインスタンスを共有し、ヒープの不一致やグローバル変数の問題を回避できます。</p>
<p><strong>メモリ効率</strong></p>
<p>複数のモジュールが同じランタイムライブラリ DLL を共有するため、メモリ使用量が削減されます。</p>
<p><strong>Microsoft の標準的な手法</strong></p>
<p>Windows のシステム DLL や多くのサードパーティライブラリは <code>/MD</code> でビルドされているため、これに合わせることで互換性の問題を減らせます。</p>
<p><strong>配布の手間</strong></p>
<p>Microsoft は Visual C++ 再頒布可能パッケージ (Visual C++ Redistributable) を提供しており、ユーザーはこれをインストールすることで、すべての <code>/MD</code> アプリケーションに必要なランタイム DLL を一度に入手できます。</p>
<h2 data-number="6.3" id="mt-を選択するケース"><span class="header-section-number">6.3</span> /MT を選択するケース</h2>
<p>以下の条件を満たす場合は、<code>/MT</code> の選択も有効です。</p>
<p><strong>単一の実行ファイルのみのプロジェクト</strong></p>
<p>DLL を作成せず、単一の実行ファイルのみを配布する場合、<code>/MT</code> を使用することで配布が簡単になります (ランタイム DLL が不要)。</p>
<p><strong>DLL 境界を越えたメモリ操作がない</strong></p>
<p>DLL が整数や値型のみを受け渡し、ポインタの受け渡しやメモリの割り当て/解放を行わない場合、<code>/MT</code> でも問題は発生しません。</p>
<p><strong>配布先の環境が限定的</strong></p>
<p>配布先の環境が限定されており、ランタイム DLL のインストールが困難な場合、<code>/MT</code> を使用することで依存関係を削減できます。</p>
<h2 data-number="6.4" id="本プロジェクトでの選択"><span class="header-section-number">6.4</span> 本プロジェクトでの選択</h2>
<p>本プロジェクト (doxygen-sample) では、以下の理由から <strong><code>/MD</code> を採用</strong>しています。</p>
<p><strong>DLL を含むプロジェクト</strong></p>
<p><code>calc.dll</code> を作成しており、これを <code>add.exe</code> がリンクしています。<code>/MD</code> を使用することで、DLL と exe が同じランタイムライブラリインスタンスを共有し、将来的な拡張 (ポインタの受け渡しなど) にも対応できます。</p>
<p><strong>複雑なプロジェクトへの拡張性</strong></p>
<p>将来、他のライブラリや機能を追加する際、<code>/MD</code> であれば互換性の問題が発生しにくくなります。</p>
<p><strong>Microsoft の推奨に従う</strong></p>
<p>標準的な Windows 開発の手法に従うことで、他の開発者やツールとの互換性を保ちます。</p>
<h1 data-number="7" id="ビルド設定"><span class="header-section-number">7</span> ビルド設定</h1>
<p>本プロジェクトでは、すべてのコンポーネントを <code>/MD</code> でビルドするよう設定しています。</p>
<h2 data-number="7.1" id="静的ライブラリ-calcbase.lib"><span class="header-section-number">7.1</span> 静的ライブラリ (calcbase.lib)</h2>
<div class="sourceCode" id="cb4"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="dt">CFLAGS</span> <span class="ch">:=</span><span class="st"> /W4 /Zi /TC /nologo /utf-8 /FS /MD /Fd</span><span class="ch">$(</span><span class="dt">TARGETDIR</span><span class="ch">)</span><span class="st">/</span><span class="ch">$(</span><span class="dt">TARGET_BASE</span><span class="ch">)</span><span class="st">.pdb /I</span><span class="ch">$(</span><span class="dt">WORKSPACE_FOLDER</span><span class="ch">)</span><span class="st">/prod/calc/include</span></span></code></pre></div>
<div data-custom-style="Source Code Caption">
prod/calc/libsrc/makelibsrc-windows-poc.mk
</div>
<h2 data-number="7.2" id="動的リンクライブラリ-calc.dll"><span class="header-section-number">7.2</span> 動的リンクライブラリ (calc.dll)</h2>
<div class="sourceCode" id="cb5"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="dt">CFLAGS</span> <span class="ch">:=</span><span class="st"> /W4 /Zi /TC /nologo /utf-8 /FS /MD /LD /Fd</span><span class="ch">$(</span><span class="dt">TARGETDIR</span><span class="ch">)</span><span class="st">/</span><span class="ch">$(</span><span class="dt">TARGET_BASE</span><span class="ch">)</span><span class="st">.pdb /I</span><span class="ch">$(</span><span class="dt">WORKSPACE_FOLDER</span><span class="ch">)</span><span class="st">/prod/calc/include</span></span></code></pre></div>
<div data-custom-style="Source Code Caption">
prod/calc/libsrc/makelibsrc-windows-poc.mk
</div>
<h2 data-number="7.3" id="実行ファイル-add.exe"><span class="header-section-number">7.3</span> 実行ファイル (add.exe)</h2>
<div class="sourceCode" id="cb6"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="dt">CFLAGS</span> <span class="ch">:=</span><span class="st"> /W4 /Zi /TC /nologo /utf-8 /MD /Fd</span><span class="ch">$(</span><span class="dt">OBJDIR</span><span class="ch">)</span><span class="st">/add.pdb /I</span><span class="ch">$(</span><span class="dt">WORKSPACE_FOLDER</span><span class="ch">)</span><span class="st">/prod/calc/include</span></span></code></pre></div>
<div data-custom-style="Source Code Caption">
prod/calc/src/add/Makefile.Windows-poc
</div>
<p>すべてのコンポーネントに <code>/MD</code> フラグが追加されており、動的ランタイムライブラリを使用します。</p>
<h1 data-number="8" id="実行環境の準備"><span class="header-section-number">8</span> 実行環境の準備</h1>
<p><code>/MD</code> でビルドされたプログラムを実行するには、Visual C++ 再頒布可能パッケージのインストールが必要です。</p>
<h2 data-number="8.1" id="再頒布可能パッケージの入手"><span class="header-section-number">8.1</span> 再頒布可能パッケージの入手</h2>
<p>Microsoft の公式サイトから、使用している Visual Studio のバージョンに対応する再頒布可能パッケージをダウンロードします。</p>
<ul>
<li>Visual Studio 2015, 2017, 2019, 2022 用: <a href="https://learn.microsoft.com/ja-jp/cpp/windows/latest-supported-vc-redist">https://learn.microsoft.com/ja-jp/cpp/windows/latest-supported-vc-redist</a></li>
</ul>
<h2 data-number="8.2" id="インストール"><span class="header-section-number">8.2</span> インストール</h2>
<p>ダウンロードした再頒布可能パッケージ (例: <code>vc_redist.x64.exe</code>) を実行し、インストールします。これにより、以下の DLL がシステムにインストールされます。</p>
<ul>
<li><code>vcruntime140.dll</code></li>
<li><code>msvcp140.dll</code></li>
<li><code>ucrtbase.dll</code></li>
</ul>
<p>インストール後、<code>/MD</code> でビルドされたプログラムが正常に実行できます。</p>
<h1 data-number="9" id="まとめ"><span class="header-section-number">9</span> まとめ</h1>
<p>MSVC におけるランタイムライブラリのリンクモデルの選択は、プロジェクト全体の安定性と保守性に大きく影響します。</p>
<h2 data-number="9.1" id="重要なポイント"><span class="header-section-number">9.1</span> 重要なポイント</h2>
<p><strong>プロジェクト全体で統一する</strong></p>
<p>すべてのモジュール (実行ファイル、静的ライブラリ、DLL) を同じモデルでビルドします。</p>
<p><strong>複雑なプロジェクトでは /MD を推奨</strong></p>
<p>DLL を含むプロジェクトや、将来的な拡張を想定する場合は、<code>/MD</code> (動的ランタイム) を使用します。</p>
<p><strong>警告を無視しない</strong></p>
<p>リンカー警告 LNK4098 が出力された場合は、ランタイムリンクモデルの不一致が発生しているため、必ず修正します。</p>
<p><strong>配布時には再頒布可能パッケージが必要</strong></p>
<p><code>/MD</code> を使用する場合、ユーザーの環境に Visual C++ 再頒布可能パッケージがインストールされている必要があります。</p>
<p>本プロジェクトでは、すべてのコンポーネントを <code>/MD</code> でビルドすることで、ランタイムライブラリの統一を実現し、安定した動作を保証しています。</p>
<h1 data-number="10" id="参考リンク"><span class="header-section-number">10</span> 参考リンク</h1>
<ul>
<li><p>Microsoft Docs: C ランタイム ライブラリのリンク<br />
<a href="https://learn.microsoft.com/ja-jp/cpp/c-runtime-library/crt-library-features">https://learn.microsoft.com/ja-jp/cpp/c-runtime-library/crt-library-features</a></p></li>
<li><p>Microsoft Docs: /MD、/MT、/LD (ランタイム ライブラリの使用)<br />
<a href="https://learn.microsoft.com/ja-jp/cpp/build/reference/md-mt-ld-use-run-time-library">https://learn.microsoft.com/ja-jp/cpp/build/reference/md-mt-ld-use-run-time-library</a></p></li>
<li><p>Microsoft Docs: 最新のサポートされる Visual C++ 再頒布可能パッケージのダウンロード<br />
<a href="https://learn.microsoft.com/ja-jp/cpp/windows/latest-supported-vc-redist">https://learn.microsoft.com/ja-jp/cpp/windows/latest-supported-vc-redist</a></p></li>
</ul>
            </div>
    </div>
  </div>
  <script src="https://vjs.zencdn.net/5.4.4/video.js"></script>

</body>
</html>
