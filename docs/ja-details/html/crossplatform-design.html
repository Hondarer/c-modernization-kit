<!doctype html>
<html >
<head>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="Content-Style-Type" content="text/css" />

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/template.css" />

    <link href="https://vjs.zencdn.net/5.4.4/video-js.css" rel="stylesheet" />

    <script src="https://code.jquery.com/jquery-2.2.1.min.js"></script>

    <script type='text/javascript' src='https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/js/jquery.cookie.js'></script>
    <script type='text/javascript' src='https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/js/jquery.hoverIntent.minified.js'></script>
    <script type='text/javascript' src='https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/js/jquery.dcjqaccordion.2.7.min.js'></script>

    <link href="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/css/skins/blue.css" rel="stylesheet" type="text/css" />
    <link href="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/css/skins/graphite.css" rel="stylesheet" type="text/css" />
    <link href="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/css/skins/grey.css" rel="stylesheet" type="text/css" />
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script src="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/script.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/jquery.sticky-kit.js"></script>
    
    <meta name="generator" content="pandoc" />
  <meta name="author" content="Tetsuo Honda" />
  <title>クロスプラットフォーム対応設計</title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="html-style.css" />
</head>
<body>

    
    <div class="navbar navbar-static-top">
    <div class="navbar-inner">
      <div class="container">
        <span class="doc-title">クロスプラットフォーム対応設計</span>
        <ul class="nav pull-right doc-info">
                    <li><p class="navbar-text">Tetsuo Honda</p></li>
                              <li><p class="navbar-text">Thu, 13 Nov 2025 22:36:55 +0900 18ac2c5</p></li>
                  </ul>
      </div>
    </div>
  </div>
    <div class="container">
    <div class="row">
            <div id="TOC" class="span3">
        <div class="well toc">

        <ul>
        <li><a href="#はじめに" id="toc-はじめに"><span class="toc-section-number">1</span> はじめに</a>
        <ul>
        <li><a href="#設計の目標" id="toc-設計の目標"><span class="toc-section-number">1.1</span> 設計の目標</a></li>
        <li><a href="#設計の基本方針" id="toc-設計の基本方針"><span class="toc-section-number">1.2</span> 設計の基本方針</a></li>
        </ul></li>
        <li><a href="#現状分析" id="toc-現状分析"><span class="toc-section-number">2</span> 現状分析</a>
        <ul>
        <li><a href="#プロジェクト全体の構造" id="toc-プロジェクト全体の構造"><span class="toc-section-number">2.1</span> プロジェクト全体の構造</a></li>
        <li><a href="#testfw-サブモジュールの役割" id="toc-testfw-サブモジュールの役割"><span class="toc-section-number">2.2</span> testfw サブモジュールの役割</a>
        <ul>
        <li><a href="#testfwmakefilesprepare.mk" id="toc-testfwmakefilesprepare.mk"><span class="toc-section-number">2.2.1</span> testfw/makefiles/prepare.mk</a></li>
        <li><a href="#testfwmakefilesmakelibsrc.mk" id="toc-testfwmakefilesmakelibsrc.mk"><span class="toc-section-number">2.2.2</span> testfw/makefiles/makelibsrc.mk</a></li>
        <li><a href="#testfwmakefilesmakesrc.mk" id="toc-testfwmakefilesmakesrc.mk"><span class="toc-section-number">2.2.3</span> testfw/makefiles/makesrc.mk</a></li>
        </ul></li>
        <li><a href="#doxyfw-サブモジュールの役割" id="toc-doxyfw-サブモジュールの役割"><span class="toc-section-number">2.3</span> doxyfw サブモジュールの役割</a>
        <ul>
        <li><a href="#doxyfwmakefile" id="toc-doxyfwmakefile"><span class="toc-section-number">2.3.1</span> doxyfw/Makefile</a></li>
        </ul></li>
        <li><a href="#prod-と-test-の-makeflags.mk" id="toc-prod-と-test-の-makeflags.mk"><span class="toc-section-number">2.4</span> prod と test の makeflags.mk</a></li>
        <li><a href="#linux-依存箇所の特定" id="toc-linux-依存箇所の特定"><span class="toc-section-number">2.5</span> Linux 依存箇所の特定</a>
        <ul>
        <li><a href="#シェルコマンド" id="toc-シェルコマンド"><span class="toc-section-number">2.5.1</span> シェルコマンド</a></li>
        <li><a href="#コンパイラとツールチェーン" id="toc-コンパイラとツールチェーン"><span class="toc-section-number">2.5.2</span> コンパイラとツールチェーン</a></li>
        <li><a href="#testfw-のシェルスクリプト" id="toc-testfw-のシェルスクリプト"><span class="toc-section-number">2.5.3</span> testfw のシェルスクリプト</a></li>
        <li><a href="#doxyfw-のシェルコマンド" id="toc-doxyfw-のシェルコマンド"><span class="toc-section-number">2.5.4</span> doxyfw のシェルコマンド</a></li>
        </ul></li>
        </ul></li>
        <li><a href="#windows-対応の課題" id="toc-windows-対応の課題"><span class="toc-section-number">3</span> Windows 対応の課題</a>
        <ul>
        <li><a href="#コンパイラとツールチェーンの違い" id="toc-コンパイラとツールチェーンの違い"><span class="toc-section-number">3.1</span> コンパイラとツールチェーンの違い</a></li>
        <li><a href="#シェルコマンドの違い" id="toc-シェルコマンドの違い"><span class="toc-section-number">3.2</span> シェルコマンドの違い</a></li>
        <li><a href="#パスと環境の違い" id="toc-パスと環境の違い"><span class="toc-section-number">3.3</span> パスと環境の違い</a></li>
        <li><a href="#testfw-と-doxyfw-への影響範囲" id="toc-testfw-と-doxyfw-への影響範囲"><span class="toc-section-number">3.4</span> testfw と doxyfw への影響範囲</a></li>
        </ul></li>
        <li><a href="#対処方針" id="toc-対処方針"><span class="toc-section-number">4</span> 対処方針</a>
        <ul>
        <li><a href="#os-判定による条件分岐" id="toc-os-判定による条件分岐"><span class="toc-section-number">4.1</span> OS 判定による条件分岐</a></li>
        <li><a href="#mingw-環境の活用" id="toc-mingw-環境の活用"><span class="toc-section-number">4.2</span> MinGW 環境の活用</a></li>
        <li><a href="#msvc-との統合" id="toc-msvc-との統合"><span class="toc-section-number">4.3</span> MSVC との統合</a>
        <ul>
        <li><a href="#コンパイラフラグの変換" id="toc-コンパイラフラグの変換"><span class="toc-section-number">4.3.1</span> コンパイラフラグの変換</a></li>
        <li><a href="#ライブラリ生成の変換" id="toc-ライブラリ生成の変換"><span class="toc-section-number">4.3.2</span> ライブラリ生成の変換</a></li>
        <li><a href="#リンクの変換" id="toc-リンクの変換"><span class="toc-section-number">4.3.3</span> リンクの変換</a></li>
        <li><a href="#オブジェクトファイルとライブラリの拡張子" id="toc-オブジェクトファイルとライブラリの拡張子"><span class="toc-section-number">4.3.4</span> オブジェクトファイルとライブラリの拡張子</a></li>
        </ul></li>
        </ul></li>
        <li><a href="#実装設計" id="toc-実装設計"><span class="toc-section-number">5</span> 実装設計</a>
        <ul>
        <li><a href="#変更が必要なファイルの全体像" id="toc-変更が必要なファイルの全体像"><span class="toc-section-number">5.1</span> 変更が必要なファイルの全体像</a>
        <ul>
        <li><a href="#testfw-サブモジュール" id="toc-testfw-サブモジュール"><span class="toc-section-number">5.1.1</span> testfw サブモジュール</a></li>
        <li><a href="#doxyfw-サブモジュール" id="toc-doxyfw-サブモジュール"><span class="toc-section-number">5.1.2</span> doxyfw サブモジュール</a></li>
        <li><a href="#メインプロジェクト" id="toc-メインプロジェクト"><span class="toc-section-number">5.1.3</span> メインプロジェクト</a></li>
        </ul></li>
        <li><a href="#testfwmakefilesprepare.mk-の変更" id="toc-testfwmakefilesprepare.mk-の変更"><span class="toc-section-number">5.2</span> testfw/makefiles/prepare.mk の変更</a></li>
        <li><a href="#testfwmakefilesmakelibsrc.mk-の変更" id="toc-testfwmakefilesmakelibsrc.mk-の変更"><span class="toc-section-number">5.3</span> testfw/makefiles/makelibsrc.mk の変更</a>
        <ul>
        <li><a href="#os-判定とツール設定" id="toc-os-判定とツール設定"><span class="toc-section-number">5.3.1</span> OS 判定とツール設定</a></li>
        <li><a href="#ライブラリターゲット名の設定" id="toc-ライブラリターゲット名の設定"><span class="toc-section-number">5.3.2</span> ライブラリターゲット名の設定</a></li>
        <li><a href="#ビルドルール" id="toc-ビルドルール"><span class="toc-section-number">5.3.3</span> ビルドルール</a></li>
        </ul></li>
        <li><a href="#testfwmakefilesmakesrc.mk-の変更" id="toc-testfwmakefilesmakesrc.mk-の変更"><span class="toc-section-number">5.4</span> testfw/makefiles/makesrc.mk の変更</a>
        <ul>
        <li><a href="#os-判定とツール設定-1" id="toc-os-判定とツール設定-1"><span class="toc-section-number">5.4.1</span> OS 判定とツール設定</a></li>
        <li><a href="#実行ファイルターゲット名の設定" id="toc-実行ファイルターゲット名の設定"><span class="toc-section-number">5.4.2</span> 実行ファイルターゲット名の設定</a></li>
        <li><a href="#ビルドルール-1" id="toc-ビルドルール-1"><span class="toc-section-number">5.4.3</span> ビルドルール</a></li>
        </ul></li>
        <li><a href="#prodmakeflags.mk-の変更" id="toc-prodmakeflags.mk-の変更"><span class="toc-section-number">5.5</span> prod/makeflags.mk の変更</a></li>
        <li><a href="#testmakeflags.mk-の変更" id="toc-testmakeflags.mk-の変更"><span class="toc-section-number">5.6</span> test/makeflags.mk の変更</a></li>
        <li><a href="#doxyfwmakefile-の変更" id="toc-doxyfwmakefile-の変更"><span class="toc-section-number">5.7</span> doxyfw/Makefile の変更</a></li>
        </ul></li>
        <li><a href="#実装手順" id="toc-実装手順"><span class="toc-section-number">6</span> 実装手順</a>
        <ul>
        <li><a href="#ステップ-1-testfwmakefilesprepare.mk-の更新" id="toc-ステップ-1-testfwmakefilesprepare.mk-の更新"><span class="toc-section-number">6.1</span> ステップ 1: testfw/makefiles/prepare.mk の更新</a></li>
        <li><a href="#ステップ-2-testfwmakefilesmakelibsrc.mk-の更新" id="toc-ステップ-2-testfwmakefilesmakelibsrc.mk-の更新"><span class="toc-section-number">6.2</span> ステップ 2: testfw/makefiles/makelibsrc.mk の更新</a></li>
        <li><a href="#ステップ-3-testfwmakefilesmakesrc.mk-の更新" id="toc-ステップ-3-testfwmakefilesmakesrc.mk-の更新"><span class="toc-section-number">6.3</span> ステップ 3: testfw/makefiles/makesrc.mk の更新</a></li>
        <li><a href="#ステップ-4-prodmakeflags.mk-の更新" id="toc-ステップ-4-prodmakeflags.mk-の更新"><span class="toc-section-number">6.4</span> ステップ 4: prod/makeflags.mk の更新</a></li>
        <li><a href="#ステップ-5-testmakeflags.mk-の更新" id="toc-ステップ-5-testmakeflags.mk-の更新"><span class="toc-section-number">6.5</span> ステップ 5: test/makeflags.mk の更新</a></li>
        <li><a href="#ステップ-6-linux-環境でのテスト" id="toc-ステップ-6-linux-環境でのテスト"><span class="toc-section-number">6.6</span> ステップ 6: Linux 環境でのテスト</a></li>
        <li><a href="#ステップ-7-windows-環境でのテスト" id="toc-ステップ-7-windows-環境でのテスト"><span class="toc-section-number">6.7</span> ステップ 7: Windows 環境でのテスト</a></li>
        </ul></li>
        <li><a href="#テストと検証" id="toc-テストと検証"><span class="toc-section-number">7</span> テストと検証</a>
        <ul>
        <li><a href="#linux-環境でのテスト" id="toc-linux-環境でのテスト"><span class="toc-section-number">7.1</span> Linux 環境でのテスト</a>
        <ul>
        <li><a href="#prod-のビルド確認" id="toc-prod-のビルド確認"><span class="toc-section-number">7.1.1</span> prod のビルド確認</a></li>
        <li><a href="#test-のビルド確認" id="toc-test-のビルド確認"><span class="toc-section-number">7.1.2</span> test のビルド確認</a></li>
        <li><a href="#doxyfw-のドキュメント生成確認" id="toc-doxyfw-のドキュメント生成確認"><span class="toc-section-number">7.1.3</span> doxyfw のドキュメント生成確認</a></li>
        </ul></li>
        <li><a href="#windows-環境でのテスト" id="toc-windows-環境でのテスト"><span class="toc-section-number">7.2</span> Windows 環境でのテスト</a>
        <ul>
        <li><a href="#前提条件" id="toc-前提条件"><span class="toc-section-number">7.2.1</span> 前提条件</a></li>
        <li><a href="#prod-のビルド確認-1" id="toc-prod-のビルド確認-1"><span class="toc-section-number">7.2.2</span> prod のビルド確認</a></li>
        <li><a href="#test-のビルド確認-1" id="toc-test-のビルド確認-1"><span class="toc-section-number">7.2.3</span> test のビルド確認</a></li>
        <li><a href="#doxyfw-のドキュメント生成確認-1" id="toc-doxyfw-のドキュメント生成確認-1"><span class="toc-section-number">7.2.4</span> doxyfw のドキュメント生成確認</a></li>
        </ul></li>
        <li><a href="#エラー対応" id="toc-エラー対応"><span class="toc-section-number">7.3</span> エラー対応</a>
        <ul>
        <li><a href="#コンパイラフラグの確認" id="toc-コンパイラフラグの確認"><span class="toc-section-number">7.3.1</span> コンパイラフラグの確認</a></li>
        <li><a href="#パスの確認" id="toc-パスの確認"><span class="toc-section-number">7.3.2</span> パスの確認</a></li>
        <li><a href="#ライブラリ名の確認" id="toc-ライブラリ名の確認"><span class="toc-section-number">7.3.3</span> ライブラリ名の確認</a></li>
        <li><a href="#シンボリックリンクの確認" id="toc-シンボリックリンクの確認"><span class="toc-section-number">7.3.4</span> シンボリックリンクの確認</a></li>
        </ul></li>
        </ul></li>
        <li><a href="#poc-実装で得られた知見" id="toc-poc-実装で得られた知見"><span class="toc-section-number">8</span> PoC 実装で得られた知見</a>
        <ul>
        <li><a href="#環境設定スクリプトの実行順序" id="toc-環境設定スクリプトの実行順序"><span class="toc-section-number">8.1</span> 環境設定スクリプトの実行順序</a></li>
        <li><a href="#utf-8-ソースコードへの対応" id="toc-utf-8-ソースコードへの対応"><span class="toc-section-number">8.2</span> UTF-8 ソースコードへの対応</a></li>
        <li><a href="#pdb-ファイルの適切な配置" id="toc-pdb-ファイルの適切な配置"><span class="toc-section-number">8.3</span> PDB ファイルの適切な配置</a>
        <ul>
        <li><a href="#ライブラリの-pdb" id="toc-ライブラリの-pdb"><span class="toc-section-number">8.3.1</span> ライブラリの PDB</a></li>
        <li><a href="#実行ファイルの-pdb" id="toc-実行ファイルの-pdb"><span class="toc-section-number">8.3.2</span> 実行ファイルの PDB</a></li>
        </ul></li>
        <li><a href="#インクリメンタルリンク情報ファイル-ilk-の配置" id="toc-インクリメンタルリンク情報ファイル-ilk-の配置"><span class="toc-section-number">8.4</span> インクリメンタルリンク情報ファイル (ILK) の配置</a></li>
        <li><a href="#workspace_folder-のパス変換" id="toc-workspace_folder-のパス変換"><span class="toc-section-number">8.5</span> WORKSPACE_FOLDER のパス変換</a></li>
        <li><a href="#fs-オプションの追加" id="toc-fs-オプションの追加"><span class="toc-section-number">8.6</span> /FS オプションの追加</a></li>
        <li><a href="#makefile-の変数定義順序" id="toc-makefile-の変数定義順序"><span class="toc-section-number">8.7</span> Makefile の変数定義順序</a></li>
        <li><a href="#ディレクトリの依存関係" id="toc-ディレクトリの依存関係"><span class="toc-section-number">8.8</span> ディレクトリの依存関係</a></li>
        <li><a href="#clean-ターゲットの改善" id="toc-clean-ターゲットの改善"><span class="toc-section-number">8.9</span> clean ターゲットの改善</a>
        <ul>
        <li><a href="#ライブラリの-clean-ターゲット" id="toc-ライブラリの-clean-ターゲット"><span class="toc-section-number">8.9.1</span> ライブラリの clean ターゲット</a></li>
        <li><a href="#実行ファイルの-clean-ターゲット" id="toc-実行ファイルの-clean-ターゲット"><span class="toc-section-number">8.9.2</span> 実行ファイルの clean ターゲット</a></li>
        </ul></li>
        </ul></li>
        <li><a href="#まとめ" id="toc-まとめ"><span class="toc-section-number">9</span> まとめ</a>
        <ul>
        <li><a href="#採用する方針" id="toc-採用する方針"><span class="toc-section-number">9.1</span> 採用する方針</a></li>
        <li><a href="#メリット" id="toc-メリット"><span class="toc-section-number">9.2</span> メリット</a></li>
        <li><a href="#注意点" id="toc-注意点"><span class="toc-section-number">9.3</span> 注意点</a></li>
        <li><a href="#次のステップ" id="toc-次のステップ"><span class="toc-section-number">9.4</span> 次のステップ</a></li>
        </ul></li>
        </ul>

        </div>
      </div>
            <div class="span9">

                <H1>クロスプラットフォーム対応設計</H1>
      
      
      <h1 data-number="1" id="はじめに"><span class="header-section-number">1</span> はじめに</h1>
<p>本ドキュメントは、doxygen-sample プロジェクト全体を、Linux 環境から Windows 環境でもビルド可能にするためのクロスプラットフォーム対応の設計を示します。</p>
<p>現在、prod と test 配下のビルドシステムは Linux 専用として構築されており、GCC/G++ と Linux のシェルコマンドに依存しています。Windows 環境でビルドを実現するため、Git for Windows に付属している MinGW のコマンド、GNU Make、および、ポータブル版 Visual Studio Build Tools (MSVC) を活用したクロスプラットフォーム対応を行います。</p>
<h2 data-number="1.1" id="設計の目標"><span class="header-section-number">1.1</span> 設計の目標</h2>
<ul>
<li>prod, test 配下のソースコードを Linux と Windows の両環境でビルドできるようにする</li>
<li>doxyfw でのドキュメント生成を Linux と Windows の両環境で実行できるようにする</li>
<li>testfw と doxyfw サブモジュール自体をクロスプラットフォーム対応する (他のプロジェクトでも利用可能にする)</li>
<li>既存の Linux 環境でのビルドを完全に維持する (動作に変更を加えない)</li>
<li>Windows 環境では MSVC (cl.exe, lib.exe, link.exe) を使用する</li>
<li>Git for Windows に付属している MinGW 環境のシェルコマンドを活用して、既存スクリプトの互換性を保つ</li>
</ul>
<h2 data-number="1.2" id="設計の基本方針"><span class="header-section-number">1.2</span> 設計の基本方針</h2>
<ul>
<li>testfw サブモジュールの Makefile テンプレートに OS 判定による条件分岐を追加する</li>
<li>doxyfw サブモジュールの Makefile は MinGW の bash を前提とし、そのまま維持する</li>
<li>prod と test の makeflags.mk に OS 判定による条件分岐を追加する</li>
<li>Linux 環境では既存の動作を完全に維持する (条件分岐の else 節に既存コードを配置)</li>
<li>PowerShell での互換処理は作成しない (MinGW の bash で既存スクリプトを実行)</li>
</ul>
<h1 data-number="2" id="現状分析"><span class="header-section-number">2</span> 現状分析</h1>
<h2 data-number="2.1" id="プロジェクト全体の構造"><span class="header-section-number">2.1</span> プロジェクト全体の構造</h2>
<p>プロジェクトは、以下のサブモジュールと構成で構築されています。</p>
<pre class="text"><code>doxygen-sample/
|-- .workspaceRoot       (ワークスペースルートマーカー)
|-- doxyfw/              (Doxygen フレームワーク: git submodule)
|   |-- Makefile        (ドキュメント生成)
|   |-- Doxyfile        (Doxygen 基本設定)
|   |-- doxybook-config.json
|   +-- templates/      (カスタムテンプレート、前処理・後処理スクリプト)
|-- testfw/              (テストフレームワーク: git submodule)
|   |-- makefiles/      (ビルド用 Makefile テンプレート)
|   |   |-- prepare.mk  (前処理: defines 取得、makeflags.mk 読み込み)
|   |   |-- makelibsrc.mk (ライブラリビルド)
|   |   +-- makesrc.mk  (実行ファイルビルド、テスト実行)
|   +-- cmnd/           (シェルスクリプト群)
|-- prod/                (プロダクションコード)
|   |-- Makefile        (トップレベル)
|   |-- makeflags.mk    (共通コンパイラフラグ)
|   +-- calc/           (計算ライブラリのサンプル)
|       |-- Makefile
|       |-- include/libcalc.h
|       |-- libsrc/     (ライブラリソース)
|       |   |-- Makefile
|       |   |-- makeflags.mk (TARGETDIR 設定)
|       |   +-- calc/
|       |       |-- Makefile (testfw/makefiles/makelibsrc.mk を使用)
|       |       |-- add.c
|       |       +-- calcHandler.c
|       +-- src/        (アプリケーションソース)
|           |-- Makefile
|           |-- makeflags.mk (libcalc へのリンク設定)
|           +-- add/
|               |-- Makefile (testfw/makefiles/makesrc.mk を使用)
|               +-- add.c
+-- test/                (テストコード)
    |-- Makefile        (トップレベル)
    |-- makeflags.mk    (共通コンパイラフラグ、LINK_TEST=1)
    |-- libsrc/         (テスト用ライブラリ)
    |   |-- Makefile
    |   |-- makeflags.mk
    |   +-- mock_calc/
    |       +-- Makefile (testfw/makefiles/makelibsrc.mk を使用)
    +-- src/            (テストソース)
        |-- Makefile
        +-- calc/
            |-- Makefile
            +-- libcalc/
                +-- addTest/
                    +-- Makefile (testfw/makefiles/makesrc.mk を使用)</code></pre>
<h2 data-number="2.2" id="testfw-サブモジュールの役割"><span class="header-section-number">2.2</span> testfw サブモジュールの役割</h2>
<p>testfw サブモジュールは、以下の Makefile テンプレートを提供します。</p>
<h3 data-number="2.2.1" id="testfwmakefilesprepare.mk"><span class="header-section-number">2.2.1</span> testfw/makefiles/prepare.mk</h3>
<p>各 Makefile から最初に include され、以下の処理を行います。</p>
<ul>
<li><code>c_cpp_properties.json</code> から defines を取得し、Makefile 変数に設定</li>
<li><code>testfw/cmnd/get_defines.sh</code> を実行</li>
<li><code>testfw/cmnd/get_files_lang.sh</code> でファイルエンコーディングを取得</li>
<li>ワークスペースルートから Makefile のディレクトリまでの <code>makeflags.mk</code> を検索し、親から子の順に include</li>
</ul>
<h3 data-number="2.2.2" id="testfwmakefilesmakelibsrc.mk"><span class="header-section-number">2.2.2</span> testfw/makefiles/makelibsrc.mk</h3>
<p>ライブラリをビルドするためのテンプレートです。</p>
<ul>
<li>静的ライブラリ (.a) または共有ライブラリ (.so) を生成</li>
<li>GCC/G++ でコンパイル、ar でアーカイブ作成</li>
<li>オブジェクトファイル拡張子: .o</li>
<li>シンボリックリンク、コピー、inject、filter の処理に対応</li>
<li>依存関係の自動生成 (.d ファイル)</li>
</ul>
<h3 data-number="2.2.3" id="testfwmakefilesmakesrc.mk"><span class="header-section-number">2.2.3</span> testfw/makefiles/makesrc.mk</h3>
<p>実行ファイルをビルドし、テストを実行するためのテンプレートです。</p>
<ul>
<li>実行ファイルを生成</li>
<li>GCC/G++ でコンパイル・リンク</li>
<li>オブジェクトファイル拡張子: .o</li>
<li>テストライブラリ (gtest, gmock, gcov) へのリンク</li>
<li>カバレッジ取得 (gcov, lcov, gcovr)</li>
<li>シンボリックリンク、コピー、inject、filter の処理に対応</li>
</ul>
<h2 data-number="2.3" id="doxyfw-サブモジュールの役割"><span class="header-section-number">2.3</span> doxyfw サブモジュールの役割</h2>
<p>doxyfw サブモジュールは、Doxygen ドキュメント生成機能を提供します。</p>
<h3 data-number="2.3.1" id="doxyfwmakefile"><span class="header-section-number">2.3.1</span> doxyfw/Makefile</h3>
<p><code>make docs</code> コマンドで以下の処理を実行します。</p>
<ol type="1">
<li>Doxygen で C ソースから XML と HTML を生成</li>
<li><code>templates/preprocess.sh</code> で XML を前処理</li>
<li>Doxybook2 で XML を Markdown に変換</li>
<li><code>templates/postprocess.sh</code> で Markdown を後処理</li>
</ol>
<p>シェルコマンド (<code>command -v</code>, <code>mkdir -p</code>, <code>mktemp</code>, <code>cat</code>, <code>rm -rf</code>, <code>cp -rp</code>) を使用しています。</p>
<h2 data-number="2.4" id="prod-と-test-の-makeflags.mk"><span class="header-section-number">2.4</span> prod と test の makeflags.mk</h2>
<p>prod/makeflags.mk と test/makeflags.mk は、共通のコンパイラフラグを定義します。</p>
<ul>
<li><code>CCOMFLAGS</code>: C コンパイラフラグ (GCC 用: -Wall, -Wextra, -g, -std=c99 など)</li>
<li><code>CPPCOMFLAGS</code>: C++ コンパイラフラグ (GCC 用: -Wall, -Wextra, -g など)</li>
<li><code>LDCOMFLAGS</code>: リンカフラグ</li>
<li><code>LIBSDIR</code>: ライブラリディレクトリ</li>
<li>test/makeflags.mk のみ: <code>LINK_TEST = 1</code> (テストライブラリをリンク)</li>
</ul>
<h2 data-number="2.5" id="linux-依存箇所の特定"><span class="header-section-number">2.5</span> Linux 依存箇所の特定</h2>
<p>以下の箇所が Linux 環境に依存しています。</p>
<h3 data-number="2.5.1" id="シェルコマンド"><span class="header-section-number">2.5.1</span> シェルコマンド</h3>
<div class="sourceCode" id="cb2"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="dt">SHELL</span> <span class="ch">:=</span><span class="st"> /bin/bash</span></span></code></pre></div>
<div data-custom-style="Source Code Caption">
testfw/makefiles/makelibsrc.mk, makesrc.mk
</div>
<div class="sourceCode" id="cb3"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="dt">WORKSPACE_FOLDER</span> <span class="ch">:=</span><span class="st"> </span><span class="ch">$(</span><span class="kw">shell</span><span class="st"> \</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="st">    dir=`pwd`; \</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="st">    while [ &quot;</span><span class="ch">$$</span><span class="st">dir&quot; != &quot;/&quot; ]; do \</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="st">        if [ -f &quot;</span><span class="ch">$$</span><span class="st">dir/.workspaceRoot&quot; ]; then \</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="st">            echo </span><span class="ch">$$</span><span class="st">dir; \</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="st">            break; \</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="st">        fi; \</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="st">        dir=</span><span class="ch">$$</span><span class="st">(dirname </span><span class="ch">$$</span><span class="st">dir); \</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="st">    done \</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="ch">)</span></span></code></pre></div>
<div data-custom-style="Source Code Caption">
WORKSPACE_FOLDER 検索
</div>
<p>使用されている主なシェルコマンド</p>
<ul>
<li><code>pwd</code> (カレントディレクトリの取得)</li>
<li><code>dirname</code> (親ディレクトリの取得)</li>
<li><code>ln -s</code> (シンボリックリンクの作成)</li>
<li><code>mkdir -p</code> (ディレクトリの作成)</li>
<li><code>mktemp</code> (一時ファイルの作成)</li>
<li><code>nkf</code> (文字コード変換)</li>
<li><code>command -v</code> (コマンドの存在確認)</li>
</ul>
<h3 data-number="2.5.2" id="コンパイラとツールチェーン"><span class="header-section-number">2.5.2</span> コンパイラとツールチェーン</h3>
<div class="sourceCode" id="cb4"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="dt">CC</span> <span class="ch">:=</span><span class="st"> gcc</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="dt">CPP</span> <span class="ch">:=</span><span class="st"> g++</span></span></code></pre></div>
<div data-custom-style="Source Code Caption">
testfw/makefiles/makelibsrc.mk, makesrc.mk
</div>
<div class="sourceCode" id="cb5"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>ar rvs <span class="ch">$@</span> <span class="ch">$(</span><span class="dt">OBJS</span><span class="ch">)</span></span></code></pre></div>
<div data-custom-style="Source Code Caption">
testfw/makefiles/makelibsrc.mk (アーカイブ作成)
</div>
<div class="sourceCode" id="cb6"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ch">$(</span><span class="dt">LD</span><span class="ch">)</span> <span class="ch">$(</span><span class="dt">LDFLAGS</span><span class="ch">)</span> -o <span class="ch">$@</span> <span class="ch">$(</span><span class="dt">OBJS</span><span class="ch">)</span> <span class="ch">$(</span><span class="dt">LIBS</span><span class="ch">)</span> <span class="ch">$(</span><span class="dt">TEST_LIBS</span><span class="ch">)</span></span></code></pre></div>
<div data-custom-style="Source Code Caption">
testfw/makefiles/makesrc.mk (リンク)
</div>
<p>使用されているツール</p>
<ul>
<li><code>gcc</code> (C コンパイラ)</li>
<li><code>g++</code> (C++ コンパイラ)</li>
<li><code>ar</code> (アーカイブ作成)</li>
<li>出力: <code>.a</code> (静的ライブラリ), <code>.so</code> (共有ライブラリ), 拡張子なし (実行ファイル)</li>
<li>オブジェクトファイル: <code>.o</code></li>
</ul>
<h3 data-number="2.5.3" id="testfw-のシェルスクリプト"><span class="header-section-number">2.5.3</span> testfw のシェルスクリプト</h3>
<div class="sourceCode" id="cb7"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="dt">DEFINES</span> <span class="ch">:=</span><span class="st"> </span><span class="ch">$(</span><span class="kw">shell</span><span class="st"> sh </span><span class="ch">$(</span><span class="dt">WORKSPACE_FOLDER</span><span class="ch">)</span><span class="st">/testfw/cmnd/get_defines.sh</span><span class="ch">)</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="dt">FILES_LANG</span> <span class="ch">:=</span><span class="st"> </span><span class="ch">$(</span><span class="kw">shell</span><span class="st"> sh </span><span class="ch">$(</span><span class="dt">WORKSPACE_FOLDER</span><span class="ch">)</span><span class="st">/testfw/cmnd/get_files_lang.sh</span><span class="ch">)</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="dt">INCDIR</span> <span class="ch">:=</span><span class="st"> </span><span class="ch">$(</span><span class="kw">shell</span><span class="st"> sh </span><span class="ch">$(</span><span class="dt">WORKSPACE_FOLDER</span><span class="ch">)</span><span class="st">/testfw/cmnd/get_include_paths.sh</span><span class="ch">)</span></span></code></pre></div>
<div data-custom-style="Source Code Caption">
testfw/makefiles/prepare.mk
</div>
<p>依存しているスクリプト</p>
<ul>
<li><code>testfw/cmnd/get_defines.sh</code> (defines の取得)</li>
<li><code>testfw/cmnd/get_files_lang.sh</code> (ファイルエンコーディングの取得)</li>
<li><code>testfw/cmnd/get_include_paths.sh</code> (include パスの取得)</li>
</ul>
<h3 data-number="2.5.4" id="doxyfw-のシェルコマンド"><span class="header-section-number">2.5.4</span> doxyfw のシェルコマンド</h3>
<div class="sourceCode" id="cb8"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>command -v doxygen</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>mkdir -p ../docs/doxygen</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>mktemp</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>cat Doxyfile ../Doxyfile.part &gt; <span class="ch">$$</span>TEMP_DOXYFILE</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>rm -f <span class="ch">$$</span>TEMP_DOXYFILE</span></code></pre></div>
<div data-custom-style="Source Code Caption">
doxyfw/Makefile
</div>
<h1 data-number="3" id="windows-対応の課題"><span class="header-section-number">3</span> Windows 対応の課題</h1>
<h2 data-number="3.1" id="コンパイラとツールチェーンの違い"><span class="header-section-number">3.1</span> コンパイラとツールチェーンの違い</h2>
<table>
<thead>
<tr>
<th style="text-align: left;">項目</th>
<th style="text-align: left;">Linux (GCC)</th>
<th style="text-align: left;">Windows (MSVC)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">C コンパイラ</td>
<td style="text-align: left;">gcc</td>
<td style="text-align: left;">cl.exe</td>
</tr>
<tr>
<td style="text-align: left;">C++ コンパイラ</td>
<td style="text-align: left;">g++</td>
<td style="text-align: left;">cl.exe</td>
</tr>
<tr>
<td style="text-align: left;">リンカー</td>
<td style="text-align: left;">gcc/g++</td>
<td style="text-align: left;">link.exe</td>
</tr>
<tr>
<td style="text-align: left;">静的ライブラリ生成</td>
<td style="text-align: left;">ar</td>
<td style="text-align: left;">lib.exe</td>
</tr>
<tr>
<td style="text-align: left;">静的ライブラリ拡張</td>
<td style="text-align: left;">.a</td>
<td style="text-align: left;">.lib</td>
</tr>
<tr>
<td style="text-align: left;">共有ライブラリ拡張</td>
<td style="text-align: left;">.so</td>
<td style="text-align: left;">.dll</td>
</tr>
<tr>
<td style="text-align: left;">実行ファイル拡張</td>
<td style="text-align: left;">なし</td>
<td style="text-align: left;">.exe</td>
</tr>
<tr>
<td style="text-align: left;">オブジェクト拡張</td>
<td style="text-align: left;">.o</td>
<td style="text-align: left;">.obj</td>
</tr>
</tbody>
</table>
<p>MSVC は GCC とコンパイラオプションの書式が異なります。</p>
<pre class="text"><code>GCC: -Wall -Wextra -g -fPIC -std=c99 -Iinclude -Llib -lfoo
MSVC: /W4 /Zi /TC /Iinclude foo.lib /link /LIBPATH:lib</code></pre>
<h2 data-number="3.2" id="シェルコマンドの違い"><span class="header-section-number">3.2</span> シェルコマンドの違い</h2>
<p>Linux のシェルコマンド (<code>/bin/bash</code>) は、Windows のネイティブコマンドプロンプト (cmd.exe) では利用できません。</p>
<p>ただし、本プロジェクトでは、Git for Windows の MinGW 環境を利用可能とするため、<code>bash</code> をはじめ、<code>pwd</code>, <code>dirname</code>, <code>ln</code>, <code>mkdir</code>, <code>mktemp</code> などの Linux コマンドを使用できます。</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode cmd"><code class="sourceCode dosbat"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">REM Git for Windows の MinGW コマンドを利用可能にする</span></span></code></pre></div>
<div data-custom-style="Source Code Caption">
Add-MinGW-Path.cmd
</div>
<p>この環境設定により、既存のシェルスクリプトや Makefile 内のシェルコマンドを、ほぼそのまま利用できます。</p>
<h2 data-number="3.3" id="パスと環境の違い"><span class="header-section-number">3.3</span> パスと環境の違い</h2>
<table>
<colgroup>
<col style="width: 36%" />
<col style="width: 30%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr>
<th style="text-align: left;">項目</th>
<th style="text-align: left;">Linux</th>
<th style="text-align: left;">Windows</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">パス区切り文字</td>
<td style="text-align: left;">/</td>
<td style="text-align: left;"> (GNU Make では / も可)</td>
</tr>
<tr>
<td style="text-align: left;">ルートディレクトリ</td>
<td style="text-align: left;">/</td>
<td style="text-align: left;">C:, D: など</td>
</tr>
<tr>
<td style="text-align: left;">環境変数参照 (シェル)</td>
<td style="text-align: left;">$VAR, ${VAR}</td>
<td style="text-align: left;">%VAR% (cmd), $env:VAR (PowerShell)</td>
</tr>
<tr>
<td style="text-align: left;">行末</td>
<td style="text-align: left;">LF</td>
<td style="text-align: left;">CRLF (ただし MinGW は LF 対応)</td>
</tr>
</tbody>
</table>
<p>GNU Make は Windows でもパス区切りに <code>/</code> を使えるため、この点は大きな問題にはなりません。</p>
<h2 data-number="3.4" id="testfw-と-doxyfw-への影響範囲"><span class="header-section-number">3.4</span> testfw と doxyfw への影響範囲</h2>
<p>testfw と doxyfw サブモジュールは、複数のプロジェクトで共有されています。他のプロジェクトもクロスプラットフォーム対応が必要なため、testfw と doxyfw 自体をクロスプラットフォーム対応する方針とします。</p>
<ul>
<li>testfw: Makefile テンプレートに OS 判定を追加し、Linux と Windows の両環境で動作するようにする</li>
<li>doxyfw: MinGW の bash を前提とし、既存のシェルコマンドをそのまま利用する</li>
</ul>
<h1 data-number="4" id="対処方針"><span class="header-section-number">4</span> 対処方針</h1>
<h2 data-number="4.1" id="os-判定による条件分岐"><span class="header-section-number">4.1</span> OS 判定による条件分岐</h2>
<p>Makefile 内で OS を判定し、コンパイラやツールを切り替えます。</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="cf">ifeq</span> (<span class="ch">$(</span><span class="dt">OS</span><span class="ch">)</span>,Windows_NT)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Windows 環境</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">CC</span> <span class="ch">:=</span><span class="st"> cl</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">AR</span> <span class="ch">:=</span><span class="st"> lib</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">LIBEXT</span> <span class="ch">:=</span><span class="st"> .lib</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">OBJEXT</span> <span class="ch">:=</span><span class="st"> .obj</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">EXEEXT</span> <span class="ch">:=</span><span class="st"> .exe</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Linux 環境</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">CC</span> <span class="ch">:=</span><span class="st"> gcc</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">AR</span> <span class="ch">:=</span><span class="st"> ar</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">LIBEXT</span> <span class="ch">:=</span><span class="st"> .a</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">OBJEXT</span> <span class="ch">:=</span><span class="st"> .o</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">EXEEXT</span> <span class="ch">:=</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="cf">endif</span></span></code></pre></div>
<div data-custom-style="Source Code Caption">
OS 判定の例
</div>
<p><code>$(OS)</code> 環境変数は、Windows では <code>Windows_NT</code> が設定されます。Linux では通常未定義です。</p>
<h2 data-number="4.2" id="mingw-環境の活用"><span class="header-section-number">4.2</span> MinGW 環境の活用</h2>
<p>CLAUDE.md に記載されているように、Windows 環境では以下のスクリプトを <strong>この順序で</strong> 実行して、MinGW コマンドと MSVC を利用可能にします。</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode cmd"><code class="sourceCode dosbat"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="bu">call</span> <span class="ot">Add-MinGW-Path.cmd</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="bu">call</span> <span class="ot">Add-VSBT-Env-x64.cmd</span></span></code></pre></div>
<div data-custom-style="Source Code Caption">
呼び出し例 (重要: この順序で実行)
</div>
<p><strong>注意</strong>: この順序で実行することで、MSVC の <code>link.exe</code> が MinGW の <code>link</code> コマンドより PATH の優先順位が高くなります。逆の順序で実行すると、リンク時にエラーが発生します。</p>
<p>これにより、以下が可能になります。</p>
<ul>
<li><code>bash</code>, <code>pwd</code>, <code>dirname</code> などの Linux コマンドが使える</li>
<li><code>sh</code> コマンドで既存のシェルスクリプトを実行できる</li>
<li><code>cl.exe</code>, <code>link.exe</code>, <code>lib.exe</code> が利用できる</li>
<li>testfw/cmnd/ 配下のシェルスクリプトがそのまま動作する</li>
<li>doxyfw の Makefile がそのまま動作する</li>
</ul>
<h2 data-number="4.3" id="msvc-との統合"><span class="header-section-number">4.3</span> MSVC との統合</h2>
<h3 data-number="4.3.1" id="コンパイラフラグの変換"><span class="header-section-number">4.3.1</span> コンパイラフラグの変換</h3>
<p>GCC と MSVC ではコンパイラフラグが異なるため、makeflags.mk に条件分岐を追加して、OS に応じたフラグを設定します。</p>
<table>
<thead>
<tr>
<th style="text-align: left;">目的</th>
<th style="text-align: left;">GCC</th>
<th style="text-align: left;">MSVC</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">警告レベル</td>
<td style="text-align: left;">-Wall -Wextra</td>
<td style="text-align: left;">/W4</td>
</tr>
<tr>
<td style="text-align: left;">デバッグ情報</td>
<td style="text-align: left;">-g</td>
<td style="text-align: left;">/Zi</td>
</tr>
<tr>
<td style="text-align: left;">最適化</td>
<td style="text-align: left;">-O2</td>
<td style="text-align: left;">/O2</td>
</tr>
<tr>
<td style="text-align: left;">C 標準バージョン</td>
<td style="text-align: left;">-std=c99</td>
<td style="text-align: left;">/TC</td>
</tr>
<tr>
<td style="text-align: left;">C++ 標準バージョン</td>
<td style="text-align: left;">-std=c++17</td>
<td style="text-align: left;">/std:c++17</td>
</tr>
<tr>
<td style="text-align: left;">インクルードパス</td>
<td style="text-align: left;">-Ipath</td>
<td style="text-align: left;">/Ipath</td>
</tr>
<tr>
<td style="text-align: left;">ライブラリパス</td>
<td style="text-align: left;">-Lpath</td>
<td style="text-align: left;">(リンカオプション)</td>
</tr>
<tr>
<td style="text-align: left;">ライブラリ指定</td>
<td style="text-align: left;">-lfoo</td>
<td style="text-align: left;">foo.lib</td>
</tr>
</tbody>
</table>
<h3 data-number="4.3.2" id="ライブラリ生成の変換"><span class="header-section-number">4.3.2</span> ライブラリ生成の変換</h3>
<p>GCC の <code>ar</code> コマンドと MSVC の <code>lib.exe</code> は、呼び出し方が異なります。</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>ar rvs libfoo.a foo.o bar.o</span></code></pre></div>
<div data-custom-style="Source Code Caption">
GCC (ar)
</div>
<div class="sourceCode" id="cb14"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="dv">lib /OUT:</span><span class="dt">foo.lib foo.obj bar.obj</span></span></code></pre></div>
<div data-custom-style="Source Code Caption">
MSVC (lib.exe)
</div>
<p>既存の testfw Makefile テンプレートを修正し、OS 判定によって適切なコマンドを実行します。</p>
<h3 data-number="4.3.3" id="リンクの変換"><span class="header-section-number">4.3.3</span> リンクの変換</h3>
<p>GCC と MSVC では、リンクの方法が異なります。</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>gcc -o program program.o -Llib -lfoo</span></code></pre></div>
<div data-custom-style="Source Code Caption">
GCC (gcc/g++)
</div>
<div class="sourceCode" id="cb16"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="dv">link /OUT:</span><span class="dt">program.exe program.obj foo.lib /LIBPATH:lib</span></span></code></pre></div>
<div data-custom-style="Source Code Caption">
MSVC (link.exe)
</div>
<p>testfw/makefiles/makesrc.mk を修正し、OS 判定によって適切なコマンドを実行します。</p>
<h3 data-number="4.3.4" id="オブジェクトファイルとライブラリの拡張子"><span class="header-section-number">4.3.4</span> オブジェクトファイルとライブラリの拡張子</h3>
<table>
<thead>
<tr>
<th style="text-align: left;">コンパイラ</th>
<th style="text-align: left;">オブジェクト</th>
<th style="text-align: left;">静的ライブラリ</th>
<th style="text-align: left;">実行ファイル</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">GCC</td>
<td style="text-align: left;">.o</td>
<td style="text-align: left;">.a</td>
<td style="text-align: left;">なし</td>
</tr>
<tr>
<td style="text-align: left;">MSVC</td>
<td style="text-align: left;">.obj</td>
<td style="text-align: left;">.lib</td>
<td style="text-align: left;">.exe</td>
</tr>
</tbody>
</table>
<p>Makefile 内で、拡張子も OS に応じて切り替えます。</p>
<h1 data-number="5" id="実装設計"><span class="header-section-number">5</span> 実装設計</h1>
<h2 data-number="5.1" id="変更が必要なファイルの全体像"><span class="header-section-number">5.1</span> 変更が必要なファイルの全体像</h2>
<p>以下のファイルを変更します。</p>
<h3 data-number="5.1.1" id="testfw-サブモジュール"><span class="header-section-number">5.1.1</span> testfw サブモジュール</h3>
<ul>
<li><code>testfw/makefiles/prepare.mk</code> (OS 判定追加、Linux は変更なし)</li>
<li><code>testfw/makefiles/makelibsrc.mk</code> (OS 判定でコンパイラ、アーカイバ、拡張子切り替え)</li>
<li><code>testfw/makefiles/makesrc.mk</code> (OS 判定でコンパイラ、リンカ、拡張子切り替え)</li>
</ul>
<h3 data-number="5.1.2" id="doxyfw-サブモジュール"><span class="header-section-number">5.1.2</span> doxyfw サブモジュール</h3>
<ul>
<li><code>doxyfw/Makefile</code> (MinGW の bash を前提とし、変更不要)</li>
</ul>
<h3 data-number="5.1.3" id="メインプロジェクト"><span class="header-section-number">5.1.3</span> メインプロジェクト</h3>
<ul>
<li><code>prod/makeflags.mk</code> (OS 判定でコンパイラフラグ切り替え)</li>
<li><code>test/makeflags.mk</code> (OS 判定でコンパイラフラグ切り替え)</li>
</ul>
<h2 data-number="5.2" id="testfwmakefilesprepare.mk-の変更"><span class="header-section-number">5.2</span> testfw/makefiles/prepare.mk の変更</h2>
<p>OS 判定を追加しますが、Linux 環境では既存の動作を完全に維持します。</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="cf">ifeq</span> (<span class="ch">$(</span><span class="dt">OS</span><span class="ch">)</span>,Windows_NT)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Windows 環境</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 現時点では追加処理なし (MinGW の bash を利用)</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Linux 環境 (既存コードをそのまま維持)</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="cf">endif</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="dt">DEFINES</span> <span class="ch">:=</span><span class="st"> </span><span class="ch">$(</span><span class="kw">shell</span><span class="st"> sh </span><span class="ch">$(</span><span class="dt">WORKSPACE_FOLDER</span><span class="ch">)</span><span class="st">/testfw/cmnd/get_defines.sh</span><span class="ch">)</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="ch">$(</span><span class="kw">foreach</span><span class="st"> define</span><span class="kw">,</span><span class="st"> </span><span class="ch">$(</span><span class="dt">DEFINES</span><span class="ch">)</span><span class="kw">,</span><span class="st"> </span><span class="ch">$(</span><span class="kw">eval</span><span class="st"> </span><span class="ch">$(</span><span class="dt">define</span><span class="ch">)</span><span class="st"> = 1</span><span class="ch">))</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="dt">FILES_LANG</span> <span class="ch">:=</span><span class="st"> </span><span class="ch">$(</span><span class="kw">shell</span><span class="st"> sh </span><span class="ch">$(</span><span class="dt">WORKSPACE_FOLDER</span><span class="ch">)</span><span class="st">/testfw/cmnd/get_files_lang.sh</span><span class="ch">)</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="dt">MAKEFLAGS_MK</span> <span class="ch">:=</span><span class="st"> </span><span class="ch">$(</span><span class="kw">shell</span><span class="st"> \</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="st">    dir=`pwd`; \</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="st">    while [ &quot;</span><span class="ch">$$</span><span class="st">dir&quot; != &quot;/&quot; ]; do \</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a><span class="st">        if [ -f &quot;</span><span class="ch">$$</span><span class="st">dir/makeflags.mk&quot; ]; then \</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a><span class="st">            echo &quot;</span><span class="ch">$$</span><span class="st">dir/makeflags.mk&quot;; \</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a><span class="st">        fi; \</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a><span class="st">        if [ -f &quot;</span><span class="ch">$$</span><span class="st">dir/.workspaceRoot&quot; ]; then \</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a><span class="st">            break; \</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a><span class="st">        fi; \</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a><span class="st">        dir=</span><span class="ch">$$</span><span class="st">(dirname </span><span class="ch">$$</span><span class="st">dir); \</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a><span class="st">    done \</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a><span class="ch">)</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a><span class="dt">MAKEFLAGS_MK</span> <span class="ch">:=</span><span class="st"> </span><span class="ch">$(</span><span class="kw">foreach</span><span class="st"> mkfile</span><span class="kw">,</span><span class="st"> </span><span class="ch">$(</span><span class="kw">shell</span><span class="st"> seq </span><span class="ch">$(</span><span class="kw">words</span><span class="st"> </span><span class="ch">$(</span><span class="dt">MAKEFLAGS_MK</span><span class="ch">))</span><span class="st"> -1 1</span><span class="ch">)</span><span class="kw">,</span><span class="st"> </span><span class="ch">$(</span><span class="kw">word</span><span class="st"> </span><span class="ch">$(</span><span class="dt">mkfile</span><span class="ch">)</span><span class="kw">,</span><span class="st"> </span><span class="ch">$(</span><span class="dt">MAKEFLAGS_MK</span><span class="ch">)))</span></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a><span class="ch">$(</span><span class="kw">foreach</span><span class="st"> makeflags</span><span class="kw">,</span><span class="st"> </span><span class="ch">$(</span><span class="dt">MAKEFLAGS_MK</span><span class="ch">)</span><span class="kw">,</span><span class="st"> </span><span class="ch">$(</span><span class="kw">eval</span><span class="st"> include </span><span class="ch">$(</span><span class="dt">makeflags</span><span class="ch">)))</span></span></code></pre></div>
<div data-custom-style="Source Code Caption">
testfw/makefiles/prepare.mk (変更後のイメージ)
</div>
<p>prepare.mk は、MinGW の bash を前提とし、既存のシェルコマンドをそのまま利用します。</p>
<h2 data-number="5.3" id="testfwmakefilesmakelibsrc.mk-の変更"><span class="header-section-number">5.3</span> testfw/makefiles/makelibsrc.mk の変更</h2>
<p>OS 判定による条件分岐を追加し、Linux と Windows で異なるコンパイラとツールを使用します。</p>
<h3 data-number="5.3.1" id="os-判定とツール設定"><span class="header-section-number">5.3.1</span> OS 判定とツール設定</h3>
<div class="sourceCode" id="cb18"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="cf">ifeq</span> (<span class="ch">$(</span><span class="dt">OS</span><span class="ch">)</span>,Windows_NT)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Windows 環境 (MSVC)</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">ifneq</span> (<span class="ch">$(</span><span class="dt">CC</span><span class="ch">)</span>,cl)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>        <span class="dt">CC</span> <span class="ch">:=</span><span class="st"> cl</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">endif</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">CPP</span> <span class="ch">:=</span><span class="st"> cl</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">AR</span> <span class="ch">:=</span><span class="st"> lib</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">OBJEXT</span> <span class="ch">:=</span><span class="st"> .obj</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">LIBEXT</span> <span class="ch">:=</span><span class="st"> .lib</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Linux 環境 (GCC) - 既存コードをそのまま維持</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">ifneq</span> (<span class="ch">$(</span><span class="dt">CC</span><span class="ch">)</span>,g++)</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>        <span class="dt">CC</span> <span class="ch">:=</span><span class="st"> gcc</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">endif</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">CPP</span> <span class="ch">:=</span><span class="st"> g++</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    <span class="dt">AR</span> <span class="ch">:=</span><span class="st"> ar</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>    <span class="dt">OBJEXT</span> <span class="ch">:=</span><span class="st"> .o</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">LIBEXT</span> <span class="ch">:=</span><span class="st"> .a</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a><span class="cf">endif</span></span></code></pre></div>
<div data-custom-style="Source Code Caption">
testfw/makefiles/makelibsrc.mk (OS 判定部分)
</div>
<h3 data-number="5.3.2" id="ライブラリターゲット名の設定"><span class="header-section-number">5.3.2</span> ライブラリターゲット名の設定</h3>
<div class="sourceCode" id="cb19"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="cf">ifeq</span> (<span class="ch">$(</span><span class="dt">TARGETDIR</span><span class="ch">)</span>,)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">TARGETDIR</span> <span class="ch">:=</span><span class="st"> </span><span class="ch">$(</span><span class="dt">WORKSPACE_FOLDER</span><span class="ch">)</span><span class="st">/test/lib</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="cf">endif</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="cf">ifeq</span> (<span class="ch">$(</span><span class="dt">TARGET</span><span class="ch">)</span>,)</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">ifeq</span> (<span class="ch">$(</span><span class="dt">BUILD</span><span class="ch">)</span>,shared)</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">ifeq</span> (<span class="ch">$(</span><span class="dt">OS</span><span class="ch">)</span>,Windows_NT)</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>            <span class="dt">TARGET</span> <span class="ch">:=</span><span class="st"> </span><span class="ch">$(</span><span class="kw">shell</span><span class="st"> basename `pwd`</span><span class="ch">)</span><span class="st">.dll</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>            <span class="dt">TARGET</span> <span class="ch">:=</span><span class="st"> lib</span><span class="ch">$(</span><span class="kw">shell</span><span class="st"> basename `pwd`</span><span class="ch">)</span><span class="st">.so</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">endif</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">ifeq</span> (<span class="ch">$(</span><span class="dt">OS</span><span class="ch">)</span>,Windows_NT)</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>            <span class="dt">TARGET</span> <span class="ch">:=</span><span class="st"> </span><span class="ch">$(</span><span class="kw">shell</span><span class="st"> basename `pwd`</span><span class="ch">)$(</span><span class="dt">LIBEXT</span><span class="ch">)</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>            <span class="dt">TARGET</span> <span class="ch">:=</span><span class="st"> lib</span><span class="ch">$(</span><span class="kw">shell</span><span class="st"> basename `pwd`</span><span class="ch">)$(</span><span class="dt">LIBEXT</span><span class="ch">)</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">endif</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">endif</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a><span class="cf">endif</span></span></code></pre></div>
<div data-custom-style="Source Code Caption">
testfw/makefiles/makelibsrc.mk (ターゲット名設定)
</div>
<h3 data-number="5.3.3" id="ビルドルール"><span class="header-section-number">5.3.3</span> ビルドルール</h3>
<div class="sourceCode" id="cb20"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="dt">SRCS_C</span> <span class="ch">:=</span><span class="st"> </span><span class="ch">$(</span><span class="kw">wildcard</span><span class="st"> *.c</span><span class="ch">)</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="dt">OBJS</span> <span class="ch">:=</span><span class="st"> </span><span class="ch">$(</span><span class="kw">addprefix</span><span class="st"> </span><span class="ch">$(</span><span class="dt">OBJDIR</span><span class="ch">)</span><span class="st">/</span><span class="kw">,</span><span class="st"> </span><span class="ch">$(</span><span class="kw">notdir</span><span class="st"> </span><span class="ch">$(</span><span class="kw">patsubst</span><span class="st"> %.c</span><span class="kw">,</span><span class="st"> %</span><span class="ch">$(</span><span class="dt">OBJEXT</span><span class="ch">)</span><span class="kw">,</span><span class="st"> </span><span class="ch">$(</span><span class="dt">SRCS_C</span><span class="ch">))))</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="cf">ifeq</span> (<span class="ch">$(</span><span class="dt">OS</span><span class="ch">)</span>,Windows_NT)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># MSVC のビルドルール</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">ifeq</span> (<span class="ch">$(</span><span class="dt">BUILD</span><span class="ch">)</span>,shared)</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>        <span class="ch">$(</span><span class="dt">TARGETDIR</span><span class="ch">)</span>/<span class="ch">$(</span><span class="dt">TARGET</span><span class="ch">)</span>: <span class="ch">$(</span><span class="dt">OBJS</span><span class="ch">)</span> | <span class="ch">$(</span><span class="dt">TARGETDIR</span><span class="ch">)</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>            <span class="ch">$(</span><span class="dt">CC</span><span class="ch">)</span> /LD /Fe<span class="ch">$@</span> <span class="ch">$(</span><span class="dt">OBJS</span><span class="ch">)</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>        <span class="ch">$(</span><span class="dt">TARGETDIR</span><span class="ch">)</span>/<span class="ch">$(</span><span class="dt">TARGET</span><span class="ch">)</span>: <span class="ch">$(</span><span class="dt">OBJS</span><span class="ch">)</span> | <span class="ch">$(</span><span class="dt">TARGETDIR</span><span class="ch">)</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>            <span class="ch">$(</span><span class="dt">AR</span><span class="ch">)</span> /OUT:<span class="ch">$@</span> <span class="ch">$(</span><span class="dt">OBJS</span><span class="ch">)</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">endif</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    <span class="ch">$(</span><span class="dt">OBJDIR</span><span class="ch">)</span>/%<span class="ch">$(</span><span class="dt">OBJEXT</span><span class="ch">)</span>: %.c <span class="ch">$(</span><span class="dt">OBJDIR</span><span class="ch">)</span>/%.d | <span class="ch">$(</span><span class="dt">OBJDIR</span><span class="ch">)</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>        <span class="ch">$(</span><span class="dt">CC</span><span class="ch">)</span> <span class="ch">$(</span><span class="dt">CFLAGS</span><span class="ch">)</span> /c /Fo<span class="ch">$@</span> <span class="ch">$&lt;</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># GCC のビルドルール (既存コードをそのまま維持)</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">ifeq</span> (<span class="ch">$(</span><span class="dt">BUILD</span><span class="ch">)</span>,shared)</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>        <span class="ch">$(</span><span class="dt">TARGETDIR</span><span class="ch">)</span>/<span class="ch">$(</span><span class="dt">TARGET</span><span class="ch">)</span>: <span class="ch">$(</span><span class="dt">OBJS</span><span class="ch">)</span> | <span class="ch">$(</span><span class="dt">TARGETDIR</span><span class="ch">)</span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>            <span class="ch">$(</span><span class="dt">CC</span><span class="ch">)</span> -shared -o <span class="ch">$@</span> <span class="ch">$(</span><span class="dt">OBJS</span><span class="ch">)</span></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>        <span class="ch">$(</span><span class="dt">TARGETDIR</span><span class="ch">)</span>/<span class="ch">$(</span><span class="dt">TARGET</span><span class="ch">)</span>: <span class="ch">$(</span><span class="dt">OBJS</span><span class="ch">)</span> | <span class="ch">$(</span><span class="dt">TARGETDIR</span><span class="ch">)</span></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>            <span class="ch">$(</span><span class="dt">AR</span><span class="ch">)</span> rvs <span class="ch">$@</span> <span class="ch">$(</span><span class="dt">OBJS</span><span class="ch">)</span></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">endif</span></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>    <span class="ch">$(</span><span class="dt">OBJDIR</span><span class="ch">)</span>/%<span class="ch">$(</span><span class="dt">OBJEXT</span><span class="ch">)</span>: %.c <span class="ch">$(</span><span class="dt">OBJDIR</span><span class="ch">)</span>/%.d | <span class="ch">$(</span><span class="dt">OBJDIR</span><span class="ch">)</span></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>        set -o pipefail; LANG=<span class="ch">$(</span><span class="dt">FILES_LANG</span><span class="ch">)</span> <span class="ch">$(</span><span class="dt">CC</span><span class="ch">)</span> <span class="ch">$(</span><span class="dt">DEPFLAGS</span><span class="ch">)</span> <span class="ch">$(</span><span class="dt">CFLAGS</span><span class="ch">)</span> -c -o <span class="ch">$@</span> <span class="ch">$&lt;</span> -fdiagnostics-color=always 2&gt;&amp;1 | nkf</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a><span class="cf">endif</span></span></code></pre></div>
<div data-custom-style="Source Code Caption">
testfw/makefiles/makelibsrc.mk (ビルドルール)
</div>
<h2 data-number="5.4" id="testfwmakefilesmakesrc.mk-の変更"><span class="header-section-number">5.4</span> testfw/makefiles/makesrc.mk の変更</h2>
<p>OS 判定による条件分岐を追加し、Linux と Windows で異なるコンパイラとリンカを使用します。</p>
<h3 data-number="5.4.1" id="os-判定とツール設定-1"><span class="header-section-number">5.4.1</span> OS 判定とツール設定</h3>
<div class="sourceCode" id="cb21"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="cf">ifeq</span> (<span class="ch">$(</span><span class="dt">OS</span><span class="ch">)</span>,Windows_NT)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Windows 環境 (MSVC)</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">ifneq</span> (<span class="ch">$(</span><span class="dt">CC</span><span class="ch">)</span>,cl)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>        <span class="dt">CC</span> <span class="ch">:=</span><span class="st"> cl</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">endif</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">CPP</span> <span class="ch">:=</span><span class="st"> cl</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">LD</span> <span class="ch">:=</span><span class="st"> link</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">OBJEXT</span> <span class="ch">:=</span><span class="st"> .obj</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">EXEEXT</span> <span class="ch">:=</span><span class="st"> .exe</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Linux 環境 (GCC) - 既存コードをそのまま維持</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">ifneq</span> (<span class="ch">$(</span><span class="dt">CC</span><span class="ch">)</span>,g++)</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>        <span class="dt">CC</span> <span class="ch">:=</span><span class="st"> gcc</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">endif</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">CPP</span> <span class="ch">:=</span><span class="st"> g++</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">ifneq</span> (<span class="ch">$(</span><span class="dt">LD</span><span class="ch">)</span>,)</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>        <span class="dt">LD</span> <span class="ch">:=</span><span class="st"> g++</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">endif</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">OBJEXT</span> <span class="ch">:=</span><span class="st"> .o</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">EXEEXT</span> <span class="ch">:=</span></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a><span class="cf">endif</span></span></code></pre></div>
<div data-custom-style="Source Code Caption">
testfw/makefiles/makesrc.mk (OS 判定部分)
</div>
<h3 data-number="5.4.2" id="実行ファイルターゲット名の設定"><span class="header-section-number">5.4.2</span> 実行ファイルターゲット名の設定</h3>
<div class="sourceCode" id="cb22"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="cf">ifeq</span> (<span class="ch">$(</span><span class="dt">TARGETDIR</span><span class="ch">)</span>,)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">TARGETDIR</span> <span class="ch">:=</span><span class="st"> .</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="cf">endif</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="cf">ifeq</span> (<span class="ch">$(</span><span class="dt">TARGET</span><span class="ch">)</span>,)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">TARGET</span> <span class="ch">:=</span><span class="st"> </span><span class="ch">$(</span><span class="kw">shell</span><span class="st"> basename `pwd`</span><span class="ch">)</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="cf">endif</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="dt">TARGET_WITH_EXT</span> <span class="ch">:=</span><span class="st"> </span><span class="ch">$(</span><span class="dt">TARGET</span><span class="ch">)$(</span><span class="dt">EXEEXT</span><span class="ch">)</span></span></code></pre></div>
<div data-custom-style="Source Code Caption">
testfw/makefiles/makesrc.mk (ターゲット名設定)
</div>
<h3 data-number="5.4.3" id="ビルドルール-1"><span class="header-section-number">5.4.3</span> ビルドルール</h3>
<div class="sourceCode" id="cb23"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="dt">SRCS_C</span> <span class="ch">:=</span><span class="st"> </span><span class="ch">$(</span><span class="kw">wildcard</span><span class="st"> *.c</span><span class="ch">)</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="dt">OBJS</span> <span class="ch">:=</span><span class="st"> </span><span class="ch">$(</span><span class="kw">addprefix</span><span class="st"> </span><span class="ch">$(</span><span class="dt">OBJDIR</span><span class="ch">)</span><span class="st">/</span><span class="kw">,</span><span class="st"> </span><span class="ch">$(</span><span class="kw">notdir</span><span class="st"> </span><span class="ch">$(</span><span class="kw">patsubst</span><span class="st"> %.c</span><span class="kw">,</span><span class="st"> %</span><span class="ch">$(</span><span class="dt">OBJEXT</span><span class="ch">)</span><span class="kw">,</span><span class="st"> </span><span class="ch">$(</span><span class="dt">SRCS_C</span><span class="ch">))))</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="cf">ifeq</span> (<span class="ch">$(</span><span class="dt">OS</span><span class="ch">)</span>,Windows_NT)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># MSVC のビルドルール</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">ifndef</span> NO_LINK</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>        <span class="ch">$(</span><span class="dt">TARGETDIR</span><span class="ch">)</span>/<span class="ch">$(</span><span class="dt">TARGET_WITH_EXT</span><span class="ch">)</span>: <span class="ch">$(</span><span class="dt">OBJS</span><span class="ch">)</span> <span class="ch">$(</span><span class="dt">LIBSFILES</span><span class="ch">)</span> | <span class="ch">$(</span><span class="dt">TARGETDIR</span><span class="ch">)</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>            <span class="ch">$(</span><span class="dt">LD</span><span class="ch">)</span> /OUT:<span class="ch">$@</span> <span class="ch">$(</span><span class="dt">OBJS</span><span class="ch">)</span> <span class="ch">$(</span><span class="dt">LIBS</span><span class="ch">)</span> <span class="ch">$(</span><span class="dt">TEST_LIBS</span><span class="ch">)</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>        <span class="ch">$(</span><span class="dt">OBJS</span><span class="ch">)</span>: <span class="ch">$(</span><span class="dt">LIBSFILES</span><span class="ch">)</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">endif</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>    <span class="ch">$(</span><span class="dt">OBJDIR</span><span class="ch">)</span>/%<span class="ch">$(</span><span class="dt">OBJEXT</span><span class="ch">)</span>: %.c <span class="ch">$(</span><span class="dt">OBJDIR</span><span class="ch">)</span>/%.d | <span class="ch">$(</span><span class="dt">OBJDIR</span><span class="ch">)</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>        <span class="ch">$(</span><span class="dt">CC</span><span class="ch">)</span> <span class="ch">$(</span><span class="dt">CFLAGS</span><span class="ch">)</span> /c /Fo<span class="ch">$@</span> <span class="ch">$&lt;</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># GCC のビルドルール (既存コードをそのまま維持)</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">ifndef</span> NO_LINK</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>        <span class="ch">$(</span><span class="dt">TARGETDIR</span><span class="ch">)</span>/<span class="ch">$(</span><span class="dt">TARGET_WITH_EXT</span><span class="ch">)</span>: <span class="ch">$(</span><span class="dt">OBJS</span><span class="ch">)</span> <span class="ch">$(</span><span class="dt">LIBSFILES</span><span class="ch">)</span> | <span class="ch">$(</span><span class="dt">TARGETDIR</span><span class="ch">)</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>            set -o pipefail; LANG=<span class="ch">$(</span><span class="dt">FILES_LANG</span><span class="ch">)</span> <span class="ch">$(</span><span class="dt">LD</span><span class="ch">)</span> <span class="ch">$(</span><span class="dt">LDFLAGS</span><span class="ch">)</span> -o <span class="ch">$@</span> <span class="ch">$(</span><span class="dt">OBJS</span><span class="ch">)</span> <span class="ch">$(</span><span class="dt">LIBS</span><span class="ch">)</span> <span class="ch">$(</span><span class="dt">TEST_LIBS</span><span class="ch">)</span> -fdiagnostics-color=always 2&gt;&amp;1 | nkf</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>        <span class="ch">$(</span><span class="dt">OBJS</span><span class="ch">)</span>: <span class="ch">$(</span><span class="dt">LIBSFILES</span><span class="ch">)</span></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">endif</span></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>    <span class="ch">$(</span><span class="dt">OBJDIR</span><span class="ch">)</span>/%<span class="ch">$(</span><span class="dt">OBJEXT</span><span class="ch">)</span>: %.c <span class="ch">$(</span><span class="dt">OBJDIR</span><span class="ch">)</span>/%.d | <span class="ch">$(</span><span class="dt">OBJDIR</span><span class="ch">)</span></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>        <span class="ch">@</span><span class="fu">set -o pipefail; if echo </span><span class="ch">$(</span><span class="dt">TEST_SRCS</span><span class="ch">)</span><span class="fu"> | grep -q </span><span class="ch">$(</span><span class="kw">notdir</span><span class="st"> </span><span class="ch">$&lt;)</span><span class="fu">; then </span><span class="ch">\</span></span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a><span class="fu">            echo LANG=</span><span class="ch">$(</span><span class="dt">FILES_LANG</span><span class="ch">)</span><span class="fu"> </span><span class="ch">$(</span><span class="dt">CC</span><span class="ch">)</span><span class="fu"> </span><span class="ch">$(</span><span class="dt">DEPFLAGS</span><span class="ch">)</span><span class="fu"> </span><span class="ch">$(</span><span class="dt">CFLAGS_TEST</span><span class="ch">)</span><span class="fu"> -coverage -D_IN_TEST_SRC_ -c -o </span><span class="ch">$@</span><span class="fu"> </span><span class="ch">$&lt;</span><span class="fu"> -fdiagnostics-color=always 2&gt;&amp;1 | nkf; </span><span class="ch">\</span></span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a><span class="fu">            LANG=</span><span class="ch">$(</span><span class="dt">FILES_LANG</span><span class="ch">)</span><span class="fu"> </span><span class="ch">$(</span><span class="dt">CC</span><span class="ch">)</span><span class="fu"> </span><span class="ch">$(</span><span class="dt">DEPFLAGS</span><span class="ch">)</span><span class="fu"> </span><span class="ch">$(</span><span class="dt">CFLAGS_TEST</span><span class="ch">)</span><span class="fu"> -coverage -D_IN_TEST_SRC_ -c -o </span><span class="ch">$@</span><span class="fu"> </span><span class="ch">$&lt;</span><span class="fu"> -fdiagnostics-color=always 2&gt;&amp;1 | nkf; </span><span class="ch">\</span></span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a><span class="fu">        else </span><span class="ch">\</span></span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a><span class="fu">            echo LANG=</span><span class="ch">$(</span><span class="dt">FILES_LANG</span><span class="ch">)</span><span class="fu"> </span><span class="ch">$(</span><span class="dt">CC</span><span class="ch">)</span><span class="fu"> </span><span class="ch">$(</span><span class="dt">DEPFLAGS</span><span class="ch">)</span><span class="fu"> </span><span class="ch">$(</span><span class="dt">CFLAGS</span><span class="ch">)</span><span class="fu"> -c -o </span><span class="ch">$@</span><span class="fu"> </span><span class="ch">$&lt;</span><span class="fu"> -fdiagnostics-color=always 2&gt;&amp;1 | nkf; </span><span class="ch">\</span></span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a><span class="fu">            LANG=</span><span class="ch">$(</span><span class="dt">FILES_LANG</span><span class="ch">)</span><span class="fu"> </span><span class="ch">$(</span><span class="dt">CC</span><span class="ch">)</span><span class="fu"> </span><span class="ch">$(</span><span class="dt">DEPFLAGS</span><span class="ch">)</span><span class="fu"> </span><span class="ch">$(</span><span class="dt">CFLAGS</span><span class="ch">)</span><span class="fu"> -c -o </span><span class="ch">$@</span><span class="fu"> </span><span class="ch">$&lt;</span><span class="fu"> -fdiagnostics-color=always 2&gt;&amp;1 | nkf; </span><span class="ch">\</span></span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a><span class="fu">        fi</span></span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a><span class="cf">endif</span></span></code></pre></div>
<div data-custom-style="Source Code Caption">
testfw/makefiles/makesrc.mk (ビルドルール)
</div>
<h2 data-number="5.5" id="prodmakeflags.mk-の変更"><span class="header-section-number">5.5</span> prod/makeflags.mk の変更</h2>
<p>OS 判定による条件分岐を追加し、Linux 用と Windows 用のコンパイラフラグを分けます。</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="cf">ifeq</span> (<span class="ch">$(</span><span class="dt">OS</span><span class="ch">)</span>,Windows_NT)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Windows 環境 (MSVC)</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">CCOMFLAGS</span> <span class="ch">=</span><span class="st"> /W4 /Zi /TC /nologo</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">CPPCOMFLAGS</span> <span class="ch">=</span><span class="st"> /W4 /Zi /EHsc /std:c++17 /nologo</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">LDCOMFLAGS</span> <span class="ch">=</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Linux 環境 (GCC) - 既存コードをそのまま維持</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">CCOMFLAGS</span><span class="ch">=\</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wall </span><span class="ch">\</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wextra </span><span class="ch">\</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wcast-align </span><span class="ch">\</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wdisabled-optimization </span><span class="ch">\</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wfloat-equal </span><span class="ch">\</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wformat=2 </span><span class="ch">\</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a><span class="st">        -Winit-self </span><span class="ch">\</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a><span class="st">        -Winline </span><span class="ch">\</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a><span class="st">        -Winvalid-pch </span><span class="ch">\</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wmissing-format-attribute </span><span class="ch">\</span></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wmissing-noreturn </span><span class="ch">\</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wpacked </span><span class="ch">\</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wpadded </span><span class="ch">\</span></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wredundant-decls </span><span class="ch">\</span></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wstrict-aliasing=2 </span><span class="ch">\</span></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wswitch-default </span><span class="ch">\</span></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wswitch-enum </span><span class="ch">\</span></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wundef </span><span class="ch">\</span></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wvariadic-macros </span><span class="ch">\</span></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wshadow </span><span class="ch">\</span></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wmissing-declarations </span><span class="ch">\</span></span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wmissing-prototypes </span><span class="ch">\</span></span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wstrict-prototypes </span><span class="ch">\</span></span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wsequence-point </span><span class="ch">\</span></span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wpointer-arith </span><span class="ch">\</span></span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wbad-function-cast </span><span class="ch">\</span></span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wunsafe-loop-optimizations </span><span class="ch">\</span></span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wnested-externs </span><span class="ch">\</span></span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wcast-qual </span><span class="ch">\</span></span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wint-to-pointer-cast </span><span class="ch">\</span></span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wpointer-to-int-cast </span><span class="ch">\</span></span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wimplicit-fallthrough=0 </span><span class="ch">\</span></span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wformat-overflow=0 </span><span class="ch">\</span></span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wunknown-pragmas </span><span class="ch">\</span></span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a><span class="st">        -W </span><span class="ch">\</span></span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a><span class="st">        -std=c99</span></span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a>    <span class="dt">CPPCOMFLAGS</span><span class="ch">=\</span></span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wall </span><span class="ch">\</span></span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wextra </span><span class="ch">\</span></span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wcast-align </span><span class="ch">\</span></span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wdisabled-optimization </span><span class="ch">\</span></span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wfloat-equal </span><span class="ch">\</span></span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wformat=2 </span><span class="ch">\</span></span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true" tabindex="-1"></a><span class="st">        -Winit-self </span><span class="ch">\</span></span>
<span id="cb24-54"><a href="#cb24-54" aria-hidden="true" tabindex="-1"></a><span class="st">        -Winline </span><span class="ch">\</span></span>
<span id="cb24-55"><a href="#cb24-55" aria-hidden="true" tabindex="-1"></a><span class="st">        -Winvalid-pch </span><span class="ch">\</span></span>
<span id="cb24-56"><a href="#cb24-56" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wmissing-format-attribute </span><span class="ch">\</span></span>
<span id="cb24-57"><a href="#cb24-57" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wmissing-noreturn </span><span class="ch">\</span></span>
<span id="cb24-58"><a href="#cb24-58" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wpacked </span><span class="ch">\</span></span>
<span id="cb24-59"><a href="#cb24-59" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wpadded </span><span class="ch">\</span></span>
<span id="cb24-60"><a href="#cb24-60" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wredundant-decls </span><span class="ch">\</span></span>
<span id="cb24-61"><a href="#cb24-61" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wstrict-aliasing=2 </span><span class="ch">\</span></span>
<span id="cb24-62"><a href="#cb24-62" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wswitch-default </span><span class="ch">\</span></span>
<span id="cb24-63"><a href="#cb24-63" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wswitch-enum </span><span class="ch">\</span></span>
<span id="cb24-64"><a href="#cb24-64" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wundef </span><span class="ch">\</span></span>
<span id="cb24-65"><a href="#cb24-65" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wvariadic-macros </span><span class="ch">\</span></span>
<span id="cb24-66"><a href="#cb24-66" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wshadow </span><span class="ch">\</span></span>
<span id="cb24-67"><a href="#cb24-67" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wmissing-declarations </span><span class="ch">\</span></span>
<span id="cb24-68"><a href="#cb24-68" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wsequence-point </span><span class="ch">\</span></span>
<span id="cb24-69"><a href="#cb24-69" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wpointer-arith </span><span class="ch">\</span></span>
<span id="cb24-70"><a href="#cb24-70" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wunsafe-loop-optimizations </span><span class="ch">\</span></span>
<span id="cb24-71"><a href="#cb24-71" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wcast-qual </span><span class="ch">\</span></span>
<span id="cb24-72"><a href="#cb24-72" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wint-to-pointer-cast </span><span class="ch">\</span></span>
<span id="cb24-73"><a href="#cb24-73" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wimplicit-fallthrough=0 </span><span class="ch">\</span></span>
<span id="cb24-74"><a href="#cb24-74" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wformat-overflow=0 </span><span class="ch">\</span></span>
<span id="cb24-75"><a href="#cb24-75" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wunknown-pragmas </span><span class="ch">\</span></span>
<span id="cb24-76"><a href="#cb24-76" aria-hidden="true" tabindex="-1"></a><span class="st">        -W</span></span>
<span id="cb24-77"><a href="#cb24-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-78"><a href="#cb24-78" aria-hidden="true" tabindex="-1"></a>    <span class="dt">LDCOMFLAGS</span> <span class="ch">=</span></span>
<span id="cb24-79"><a href="#cb24-79" aria-hidden="true" tabindex="-1"></a><span class="cf">endif</span></span>
<span id="cb24-80"><a href="#cb24-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-81"><a href="#cb24-81" aria-hidden="true" tabindex="-1"></a><span class="dt">LIBSDIR</span> <span class="ch">=</span></span></code></pre></div>
<div data-custom-style="Source Code Caption">
prod/makeflags.mk (変更後のイメージ)
</div>
<h2 data-number="5.6" id="testmakeflags.mk-の変更"><span class="header-section-number">5.6</span> test/makeflags.mk の変更</h2>
<p>prod/makeflags.mk と同様に、OS 判定による条件分岐を追加します。</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="cf">ifeq</span> (<span class="ch">$(</span><span class="dt">OS</span><span class="ch">)</span>,Windows_NT)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Windows 環境 (MSVC)</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">CCOMFLAGS</span> <span class="ch">=</span><span class="st"> /W4 /Zi /TC /nologo</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">CPPCOMFLAGS</span> <span class="ch">=</span><span class="st"> /W4 /Zi /EHsc /std:c++17 /nologo</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">LDCOMFLAGS</span> <span class="ch">=</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Linux 環境 (GCC) - 既存コードをそのまま維持</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">CCOMFLAGS</span><span class="ch">=\</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wall </span><span class="ch">\</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wextra </span><span class="ch">\</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="st">        ... (既存のフラグ) </span><span class="ch">\</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a><span class="st">        -std=c99</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">CPPCOMFLAGS</span><span class="ch">=\</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wall </span><span class="ch">\</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a><span class="st">        -Wextra </span><span class="ch">\</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a><span class="st">        ... (既存のフラグ)</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">LDCOMFLAGS</span> <span class="ch">=</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a><span class="cf">endif</span></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a><span class="dt">LIBSDIR</span> <span class="ch">=</span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a><span class="dt">LINK_TEST</span> <span class="ch">=</span><span class="st"> 1</span></span></code></pre></div>
<div data-custom-style="Source Code Caption">
test/makeflags.mk (変更後のイメージ)
</div>
<h2 data-number="5.7" id="doxyfwmakefile-の変更"><span class="header-section-number">5.7</span> doxyfw/Makefile の変更</h2>
<p>doxyfw/Makefile は、MinGW の bash を前提とし、変更不要です。</p>
<p>既存のシェルコマンド (<code>command -v</code>, <code>mkdir -p</code>, <code>mktemp</code>, <code>cat</code>, <code>rm -f</code>, <code>cp -rp</code>) は、MinGW 環境でそのまま動作します。</p>
<h1 data-number="6" id="実装手順"><span class="header-section-number">6</span> 実装手順</h1>
<p>クロスプラットフォーム対応は、以下の手順で段階的に実装します。</p>
<h2 data-number="6.1" id="ステップ-1-testfwmakefilesprepare.mk-の更新"><span class="header-section-number">6.1</span> ステップ 1: testfw/makefiles/prepare.mk の更新</h2>
<p>OS 判定を追加しますが、Linux では既存コードをそのまま維持します。</p>
<h2 data-number="6.2" id="ステップ-2-testfwmakefilesmakelibsrc.mk-の更新"><span class="header-section-number">6.2</span> ステップ 2: testfw/makefiles/makelibsrc.mk の更新</h2>
<p>OS 判定による条件分岐を追加し、Linux と Windows で異なるコンパイラとツールを使用します。</p>
<ul>
<li>コンパイラ、アーカイバ、拡張子の切り替え</li>
<li>ライブラリターゲット名の設定</li>
<li>ビルドルールの分岐</li>
</ul>
<h2 data-number="6.3" id="ステップ-3-testfwmakefilesmakesrc.mk-の更新"><span class="header-section-number">6.3</span> ステップ 3: testfw/makefiles/makesrc.mk の更新</h2>
<p>OS 判定による条件分岐を追加し、Linux と Windows で異なるコンパイラとリンカを使用します。</p>
<ul>
<li>コンパイラ、リンカ、拡張子の切り替え</li>
<li>実行ファイルターゲット名の設定</li>
<li>ビルドルールの分岐</li>
</ul>
<h2 data-number="6.4" id="ステップ-4-prodmakeflags.mk-の更新"><span class="header-section-number">6.4</span> ステップ 4: prod/makeflags.mk の更新</h2>
<p>OS 判定による条件分岐を追加し、Linux 用と Windows 用のコンパイラフラグを分けます。</p>
<h2 data-number="6.5" id="ステップ-5-testmakeflags.mk-の更新"><span class="header-section-number">6.5</span> ステップ 5: test/makeflags.mk の更新</h2>
<p>prod/makeflags.mk と同様に、OS 判定による条件分岐を追加します。</p>
<h2 data-number="6.6" id="ステップ-6-linux-環境でのテスト"><span class="header-section-number">6.6</span> ステップ 6: Linux 環境でのテスト</h2>
<p>既存の Linux 環境で、変更後もビルドが成功することを確認します。</p>
<h2 data-number="6.7" id="ステップ-7-windows-環境でのテスト"><span class="header-section-number">6.7</span> ステップ 7: Windows 環境でのテスト</h2>
<p>Windows 環境で、MSVC を使ったビルドが成功することを確認します。</p>
<h1 data-number="7" id="テストと検証"><span class="header-section-number">7</span> テストと検証</h1>
<h2 data-number="7.1" id="linux-環境でのテスト"><span class="header-section-number">7.1</span> Linux 環境でのテスト</h2>
<p>既存の Linux 環境で、変更後もビルドが成功することを確認します。</p>
<h3 data-number="7.1.1" id="prod-のビルド確認"><span class="header-section-number">7.1.1</span> prod のビルド確認</h3>
<div class="sourceCode" id="cb26"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> prod</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> clean</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> all</span></code></pre></div>
<div data-custom-style="Source Code Caption">
Linux での prod ビルド確認
</div>
<p>生成物の確認</p>
<ul>
<li><code>prod/calc/lib/libcalc.a</code> (静的ライブラリ)</li>
<li><code>prod/calc/src/add/add</code> (実行ファイル)</li>
</ul>
<p>実行確認</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="ex">./prod/calc/src/add/add</span> 10 20</span></code></pre></div>
<div data-custom-style="Source Code Caption">
実行確認
</div>
<p>期待される出力</p>
<pre class="text"><code>30</code></pre>
<h3 data-number="7.1.2" id="test-のビルド確認"><span class="header-section-number">7.1.2</span> test のビルド確認</h3>
<div class="sourceCode" id="cb29"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> test</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> clean</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> all</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> test</span></code></pre></div>
<div data-custom-style="Source Code Caption">
Linux での test ビルド確認
</div>
<h3 data-number="7.1.3" id="doxyfw-のドキュメント生成確認"><span class="header-section-number">7.1.3</span> doxyfw のドキュメント生成確認</h3>
<div class="sourceCode" id="cb30"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> doxyfw</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> clean</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> docs</span></code></pre></div>
<div data-custom-style="Source Code Caption">
Linux での doxyfw 確認
</div>
<p>生成物の確認</p>
<ul>
<li><code>docs/doxygen/</code> (HTML ドキュメント)</li>
<li><code>docs-src/doxybook/</code> (Markdown ドキュメント)</li>
</ul>
<h2 data-number="7.2" id="windows-環境でのテスト"><span class="header-section-number">7.2</span> Windows 環境でのテスト</h2>
<p>Windows 環境で、MSVC を使ったビルドが成功することを確認します。</p>
<h3 data-number="7.2.1" id="前提条件"><span class="header-section-number">7.2.1</span> 前提条件</h3>
<div class="sourceCode" id="cb31"><pre class="sourceCode cmd"><code class="sourceCode dosbat"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="bu">call</span> <span class="ot">Add-MinGW-Path.cmd</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="bu">call</span> <span class="ot">Add-VSBT-Env-x64.cmd</span></span></code></pre></div>
<div data-custom-style="Source Code Caption">
環境設定 (重要: この順序で実行)
</div>
<h3 data-number="7.2.2" id="prod-のビルド確認-1"><span class="header-section-number">7.2.2</span> prod のビルド確認</h3>
<div class="sourceCode" id="cb32"><pre class="sourceCode cmd"><code class="sourceCode dosbat"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> prod</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>make clean</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>make all</span></code></pre></div>
<div data-custom-style="Source Code Caption">
Windows での prod ビルド確認
</div>
<p>生成物の確認</p>
<ul>
<li><code>prod/calc/lib/calc.lib</code> (静的ライブラリ)</li>
<li><code>prod/calc/lib/calc.pdb</code> (ライブラリのデバッグ情報)</li>
<li><code>prod/calc/src/add/add.exe</code> (実行ファイル)</li>
<li><code>prod/calc/src/add/add.pdb</code> (実行ファイルのデバッグ情報)</li>
</ul>
<p>実行確認</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode cmd"><code class="sourceCode dosbat"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>prod\calc\src\add\add.exe 10 20</span></code></pre></div>
<div data-custom-style="Source Code Caption">
実行確認
</div>
<p>期待される出力</p>
<pre class="text"><code>30</code></pre>
<h3 data-number="7.2.3" id="test-のビルド確認-1"><span class="header-section-number">7.2.3</span> test のビルド確認</h3>
<div class="sourceCode" id="cb35"><pre class="sourceCode cmd"><code class="sourceCode dosbat"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> test</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>make clean</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>make all</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>make test</span></code></pre></div>
<div data-custom-style="Source Code Caption">
Windows での test ビルド確認
</div>
<h3 data-number="7.2.4" id="doxyfw-のドキュメント生成確認-1"><span class="header-section-number">7.2.4</span> doxyfw のドキュメント生成確認</h3>
<div class="sourceCode" id="cb36"><pre class="sourceCode cmd"><code class="sourceCode dosbat"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> doxyfw</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>make clean</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>make docs</span></code></pre></div>
<div data-custom-style="Source Code Caption">
Windows での doxyfw 確認
</div>
<p>生成物の確認</p>
<ul>
<li><code>docs/doxygen/</code> (HTML ドキュメント)</li>
<li><code>docs-src/doxybook/</code> (Markdown ドキュメント)</li>
</ul>
<h2 data-number="7.3" id="エラー対応"><span class="header-section-number">7.3</span> エラー対応</h2>
<p>ビルドエラーが発生した場合、以下の点を確認します。</p>
<h3 data-number="7.3.1" id="コンパイラフラグの確認"><span class="header-section-number">7.3.1</span> コンパイラフラグの確認</h3>
<p>MSVC と GCC でフラグの互換性がない場合があります。</p>
<ul>
<li>MSVC 固有の警告を抑制する (<code>/wd番号</code>)</li>
<li>GCC 固有のフラグを MSVC で使わない (<code>-fPIC</code> など)</li>
</ul>
<h3 data-number="7.3.2" id="パスの確認"><span class="header-section-number">7.3.2</span> パスの確認</h3>
<p>Windows 環境でパスにスペースが含まれる場合、引用符で囲みます。</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="dt">INCDIR</span> <span class="ch">:=</span><span class="st"> &quot;C:/Program Files/include&quot;</span></span></code></pre></div>
<div data-custom-style="Source Code Caption">
パスに引用符を追加
</div>
<h3 data-number="7.3.3" id="ライブラリ名の確認"><span class="header-section-number">7.3.3</span> ライブラリ名の確認</h3>
<p>GCC では <code>-lfoo</code> で <code>libfoo.a</code> または <code>libfoo.so</code> を検索しますが、MSVC では <code>foo.lib</code> を直接指定します。</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="cf">ifeq</span> (<span class="ch">$(</span><span class="dt">OS</span><span class="ch">)</span>,Windows_NT)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">LIBS</span> <span class="ch">:=</span><span class="st"> calc.lib</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">LIBS</span> <span class="ch">:=</span><span class="st"> -lcalc</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="cf">endif</span></span></code></pre></div>
<div data-custom-style="Source Code Caption">
ライブラリ名の切り替え
</div>
<h3 data-number="7.3.4" id="シンボリックリンクの確認"><span class="header-section-number">7.3.4</span> シンボリックリンクの確認</h3>
<p>Windows では、管理者権限なしにシンボリックリンクを作成できない場合があります。testfw の inject/filter 機能がシンボリックリンクに依存している場合、コピーに変更する必要があるかもしれません。</p>
<h1 data-number="8" id="poc-実装で得られた知見"><span class="header-section-number">8</span> PoC 実装で得られた知見</h1>
<p>Windows 用の PoC Makefile を実装して動作確認を行った結果、以下の知見が得られました。</p>
<h2 data-number="8.1" id="環境設定スクリプトの実行順序"><span class="header-section-number">8.1</span> 環境設定スクリプトの実行順序</h2>
<p>環境設定スクリプトは、<strong>必ず以下の順序で実行する必要があります</strong>。</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode cmd"><code class="sourceCode dosbat"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="bu">call</span> <span class="ot">Add-MinGW-Path.cmd</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="bu">call</span> <span class="ot">Add-VSBT-Env-x64.cmd</span></span></code></pre></div>
<div data-custom-style="Source Code Caption">
環境設定の正しい順序
</div>
<p>この順序で実行することで、MSVC の <code>link.exe</code> が MinGW の <code>link</code> コマンドより PATH の優先順位が高くなります。</p>
<p>逆の順序で実行すると、リンク時に MinGW の <code>link</code> コマンドが呼び出され、以下のようなエラーが発生します。</p>
<pre class="text"><code>link: extra operand &#39;calc.lib&#39;
Try &#39;link --help&#39; for more information.</code></pre>
<h2 data-number="8.2" id="utf-8-ソースコードへの対応"><span class="header-section-number">8.2</span> UTF-8 ソースコードへの対応</h2>
<p>ソースコードが UTF-8 で記述されている場合、MSVC のコンパイル時に <code>/utf-8</code> オプションを追加する必要があります。</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="dt">CFLAGS</span> <span class="ch">:=</span><span class="st"> /W4 /Zi /TC /nologo /utf-8 /I</span><span class="ch">$(</span><span class="dt">WORKSPACE_FOLDER</span><span class="ch">)</span><span class="st">/prod/calc/include</span></span></code></pre></div>
<div data-custom-style="Source Code Caption">
UTF-8 オプションの追加
</div>
<p>このオプションを指定しないと、以下の警告が発生します。</p>
<pre class="text"><code>warning C4819: The file contains a character that cannot be represented
in the current code page (932). Save the file in Unicode format to prevent data loss</code></pre>
<h2 data-number="8.3" id="pdb-ファイルの適切な配置"><span class="header-section-number">8.3</span> PDB ファイルの適切な配置</h2>
<p>MSVC のデバッグ情報ファイル (PDB) は、以下のように配置します。</p>
<h3 data-number="8.3.1" id="ライブラリの-pdb"><span class="header-section-number">8.3.1</span> ライブラリの PDB</h3>
<p>ライブラリファイル (.lib) と同じディレクトリに配置します。</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="dt">CFLAGS</span> <span class="ch">:=</span><span class="st"> /W4 /Zi /TC /nologo /utf-8 /FS /Fd</span><span class="ch">$(</span><span class="dt">TARGETDIR</span><span class="ch">)</span><span class="st">/calc.pdb /I...</span></span></code></pre></div>
<div data-custom-style="Source Code Caption">
ライブラリの PDB 配置
</div>
<p>生成結果</p>
<pre class="text"><code>prod/calc/lib/
├── calc.lib
└── calc.pdb</code></pre>
<h3 data-number="8.3.2" id="実行ファイルの-pdb"><span class="header-section-number">8.3.2</span> 実行ファイルの PDB</h3>
<p>実行ファイルと同じディレクトリに配置します。コンパイル時の中間 PDB は obj ディレクトリに配置します。</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="dt">CFLAGS</span> <span class="ch">:=</span><span class="st"> /W4 /Zi /TC /nologo /utf-8 /Fd</span><span class="ch">$(</span><span class="dt">OBJDIR</span><span class="ch">)</span><span class="st">/add.pdb /I...</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="dt">LDFLAGS</span> <span class="ch">:=</span><span class="st"> /DEBUG /PDB:</span><span class="ch">$(</span><span class="dt">TARGETDIR</span><span class="ch">)</span><span class="st">/add.pdb /LIBPATH:...</span></span></code></pre></div>
<div data-custom-style="Source Code Caption">
実行ファイルの PDB 配置
</div>
<p>生成結果</p>
<pre class="text"><code>prod/calc/src/add/
├── add.exe
├── add.pdb     (リンク時の PDB、実行ファイルと同じ場所)
└── obj/
    ├── add.obj
    └── add.pdb (コンパイル時の PDB、obj ディレクトリ)</code></pre>
<h2 data-number="8.4" id="インクリメンタルリンク情報ファイル-ilk-の配置"><span class="header-section-number">8.4</span> インクリメンタルリンク情報ファイル (ILK) の配置</h2>
<p>MSVC のインクリメンタルリンク情報ファイル (.ilk) は、中間ファイルとして obj ディレクトリに配置します。</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="dt">LDFLAGS</span> <span class="ch">:=</span><span class="st"> /DEBUG /PDB:</span><span class="ch">$(</span><span class="dt">TARGETDIR</span><span class="ch">)</span><span class="st">/add.pdb /INCREMENTAL /ILK:</span><span class="ch">$(</span><span class="dt">OBJDIR</span><span class="ch">)</span><span class="st">/add.ilk /LIBPATH:...</span></span></code></pre></div>
<div data-custom-style="Source Code Caption">
ILK ファイルの配置
</div>
<p>生成結果</p>
<pre class="text"><code>prod/calc/src/add/
├── add.exe
├── add.pdb
└── obj/
    ├── add.obj
    ├── add.pdb
    └── add.ilk (インクリメンタルリンク情報)</code></pre>
<h2 data-number="8.5" id="workspace_folder-のパス変換"><span class="header-section-number">8.5</span> WORKSPACE_FOLDER のパス変換</h2>
<p>Makefile 内で Unix スタイルのパス (<code>/d/Users/...</code>) を取得した場合、MSVC はこのパスを認識できません。<code>cygpath -w</code> を使用して Windows スタイルのパス (<code>D:\Users\...</code>) に変換する必要があります。</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="dt">WORKSPACE_FOLDER</span> <span class="ch">:=</span><span class="st"> </span><span class="ch">$(</span><span class="kw">shell</span><span class="st"> \</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="st">    dir=`pwd`; \</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="st">    while [ &quot;</span><span class="ch">$$</span><span class="st">dir&quot; != &quot;/&quot; ]; do \</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="st">        if [ -f &quot;</span><span class="ch">$$</span><span class="st">dir/.workspaceRoot&quot; ]; then \</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="st">            cygpath -w &quot;</span><span class="ch">$$</span><span class="st">dir&quot; 2&gt;/dev/null || echo </span><span class="ch">$$</span><span class="st">dir; \</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="st">            break; \</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a><span class="st">        fi; \</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a><span class="st">        dir=</span><span class="ch">$$</span><span class="st">(dirname </span><span class="ch">$$</span><span class="st">dir); \</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a><span class="st">    done \</span></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a><span class="ch">)</span></span></code></pre></div>
<div data-custom-style="Source Code Caption">
WORKSPACE_FOLDER のパス変換
</div>
<p><code>cygpath -w</code> が利用できない環境では、<code>echo $$dir</code> にフォールバックします。</p>
<h2 data-number="8.6" id="fs-オプションの追加"><span class="header-section-number">8.6</span> /FS オプションの追加</h2>
<p>複数のソースファイルが同じ PDB ファイルに同時に書き込む場合、<code>/FS</code> オプションを追加して同期を保証する必要があります。</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="dt">CFLAGS</span> <span class="ch">:=</span><span class="st"> /W4 /Zi /TC /nologo /utf-8 /FS /Fd</span><span class="ch">$(</span><span class="dt">TARGETDIR</span><span class="ch">)</span><span class="st">/calc.pdb /I...</span></span></code></pre></div>
<div data-custom-style="Source Code Caption">
/FS オプションの追加
</div>
<p>このオプションを指定しないと、以下のエラーが発生することがあります。</p>
<pre class="text"><code>fatal error C1041: cannot open program database &#39;calc.pdb&#39;;
if multiple CL.EXE write to the same .PDB file, please use /FS</code></pre>
<h2 data-number="8.7" id="makefile-の変数定義順序"><span class="header-section-number">8.7</span> Makefile の変数定義順序</h2>
<p>Makefile 内で <code>$(OBJDIR)</code> や <code>$(TARGETDIR)</code> を参照する場合、これらの変数は参照前に定義されている必要があります。</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="dt">OBJDIR</span> <span class="ch">:=</span><span class="st"> obj</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="dt">TARGETDIR</span> <span class="ch">:=</span><span class="st"> </span><span class="ch">$(</span><span class="dt">WORKSPACE_FOLDER</span><span class="ch">)</span><span class="st">/prod/calc/lib</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="cf">ifeq</span> (<span class="ch">$(</span><span class="dt">OS</span><span class="ch">)</span>,Windows_NT)</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ここで $(OBJDIR) や $(TARGETDIR) を参照可能</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">CFLAGS</span> <span class="ch">:=</span><span class="st"> ... /Fd</span><span class="ch">$(</span><span class="dt">TARGETDIR</span><span class="ch">)</span><span class="st">/calc.pdb ...</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a><span class="cf">endif</span></span></code></pre></div>
<div data-custom-style="Source Code Caption">
変数定義の順序
</div>
<h2 data-number="8.8" id="ディレクトリの依存関係"><span class="header-section-number">8.8</span> ディレクトリの依存関係</h2>
<p>PDB ファイルを TARGETDIR に出力する場合、コンパイルルールに TARGETDIR の依存関係を追加する必要があります。</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="dv">$(OBJDIR)/%$(OBJEXT):</span><span class="dt"> %.c | </span><span class="ch">$(</span><span class="dt">OBJDIR</span><span class="ch">)</span><span class="dt"> </span><span class="ch">$(</span><span class="dt">TARGETDIR</span><span class="ch">)</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="er">    </span><span class="ch">$(</span><span class="dt">CC</span><span class="ch">)</span> <span class="ch">$(</span><span class="dt">CFLAGS</span><span class="ch">)</span> /c /Fo<span class="ch">$@</span> <span class="ch">$&lt;</span></span></code></pre></div>
<div data-custom-style="Source Code Caption">
ディレクトリの依存関係
</div>
<p>これにより、コンパイル前に TARGETDIR が作成されることが保証されます。</p>
<h2 data-number="8.9" id="clean-ターゲットの改善"><span class="header-section-number">8.9</span> clean ターゲットの改善</h2>
<p>Windows 環境では、clean ターゲットで PDB ファイルも削除する必要があります。ILK ファイルは obj ディレクトリに配置されるため、<code>rm -rf $(OBJDIR)</code> で削除されます。</p>
<h3 data-number="8.9.1" id="ライブラリの-clean-ターゲット"><span class="header-section-number">8.9.1</span> ライブラリの clean ターゲット</h3>
<div class="sourceCode" id="cb54"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="ot">.PHONY:</span><span class="dt"> clean</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="dv">clean:</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="er">    </span>rm -rf <span class="ch">$(</span><span class="dt">OBJDIR</span><span class="ch">)</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>    rm -f <span class="ch">$(</span><span class="dt">TARGETDIR</span><span class="ch">)</span>/<span class="ch">$(</span><span class="dt">TARGET</span><span class="ch">)</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="cf">ifeq</span> (<span class="ch">$(</span><span class="dt">OS</span><span class="ch">)</span>,Windows_NT)</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>    rm -f <span class="ch">$(</span><span class="dt">TARGETDIR</span><span class="ch">)</span>/*.pdb</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a><span class="cf">endif</span></span></code></pre></div>
<div data-custom-style="Source Code Caption">
ライブラリの clean ターゲット
</div>
<h3 data-number="8.9.2" id="実行ファイルの-clean-ターゲット"><span class="header-section-number">8.9.2</span> 実行ファイルの clean ターゲット</h3>
<div class="sourceCode" id="cb55"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="ot">.PHONY:</span><span class="dt"> clean</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="dv">clean:</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="er">    </span>rm -rf <span class="ch">$(</span><span class="dt">OBJDIR</span><span class="ch">)</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>    rm -f <span class="ch">$(</span><span class="dt">TARGETDIR</span><span class="ch">)</span>/<span class="ch">$(</span><span class="dt">TARGET</span><span class="ch">)</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a><span class="cf">ifeq</span> (<span class="ch">$(</span><span class="dt">OS</span><span class="ch">)</span>,Windows_NT)</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>    rm -f <span class="ch">$(</span><span class="dt">TARGETDIR</span><span class="ch">)</span>/*.pdb</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a><span class="cf">endif</span></span></code></pre></div>
<div data-custom-style="Source Code Caption">
実行ファイルの clean ターゲット
</div>
<p>obj ディレクトリの削除により、コンパイル時の PDB と ILK ファイルが削除されます。TARGETDIR に配置されたリンク時の PDB ファイルのみ、明示的に削除します。</p>
<h1 data-number="9" id="まとめ"><span class="header-section-number">9</span> まとめ</h1>
<p>本設計では、testfw、doxyfw、prod、test の全体を Linux と Windows の両環境でビルド・動作可能にするため、以下の方針で対応します。</p>
<h2 data-number="9.1" id="採用する方針"><span class="header-section-number">9.1</span> 採用する方針</h2>
<ul>
<li>OS 判定による条件分岐で、コンパイラとツールを切り替える</li>
<li>MinGW 環境を活用し、既存のシェルスクリプトとシェルコマンドを利用する</li>
<li>testfw サブモジュールの Makefile テンプレートに OS 判定を追加する</li>
<li>doxyfw サブモジュールの Makefile は MinGW の bash を前提とし、変更不要</li>
<li>prod/makeflags.mk と test/makeflags.mk に OS 判定を追加する</li>
<li>Linux 環境では既存の動作を完全に維持する (条件分岐の else 節に既存コードを配置)</li>
</ul>
<h2 data-number="9.2" id="メリット"><span class="header-section-number">9.2</span> メリット</h2>
<ul>
<li>testfw と doxyfw がクロスプラットフォーム対応され、他のプロジェクトでも利用できる</li>
<li>Linux と Windows で同じ Makefile を使用できるため、メンテナンス性が向上する</li>
<li>MinGW 環境により、既存のシェルスクリプトとシェルコマンドを活用できる</li>
<li>MSVC を使用することで、Windows ネイティブなバイナリを生成できる</li>
<li>Linux の動作は完全に維持される (既存コードをそのまま維持)</li>
</ul>
<h2 data-number="9.3" id="注意点"><span class="header-section-number">9.3</span> 注意点</h2>
<ul>
<li>testfw の Makefile テンプレートは複数のプロジェクトで共有されるため、変更時には慎重に行う</li>
<li>MSVC と GCC でコンパイラフラグが異なるため、makeflags.mk の条件分岐を慎重に設定する</li>
<li>Windows 環境では、環境設定スクリプトを <strong>必ず正しい順序</strong> (<code>Add-MinGW-Path.cmd</code> → <code>Add-VSBT-Env-x64.cmd</code>) で実行する必要がある</li>
<li>doxyfw は MinGW の bash を前提としているため、Windows では MinGW 環境が必須</li>
<li>テストライブラリ (gtest, gmock, gcov) の Windows 版が必要 (LINK_TEST=1 の場合)</li>
<li>ソースコードが UTF-8 の場合、MSVC では <code>/utf-8</code> オプションが必要</li>
<li>PDB ファイルと ILK ファイルを適切なディレクトリに配置する必要がある</li>
</ul>
<h2 data-number="9.4" id="次のステップ"><span class="header-section-number">9.4</span> 次のステップ</h2>
<p>設計に基づき、以下の順序で実装を進めます。</p>
<ol type="1">
<li>testfw/makefiles/prepare.mk の更新</li>
<li>testfw/makefiles/makelibsrc.mk の更新</li>
<li>testfw/makefiles/makesrc.mk の更新</li>
<li>prod/makeflags.mk の更新</li>
<li>test/makeflags.mk の更新</li>
<li>Linux 環境でのテスト (prod, test, doxyfw)</li>
<li>Windows 環境でのテスト (prod, test, doxyfw)</li>
</ol>
<p>これにより、プロジェクト全体のクロスプラットフォーム対応が完了します。</p>
            </div>
    </div>
  </div>
  <script src="https://vjs.zencdn.net/5.4.4/video.js"></script>

</body>
</html>
