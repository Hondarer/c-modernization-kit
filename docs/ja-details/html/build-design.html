<!doctype html>
<html >
<head>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="Content-Style-Type" content="text/css" />

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/template.css" />

    <link href="https://vjs.zencdn.net/5.4.4/video-js.css" rel="stylesheet" />

    <script src="https://code.jquery.com/jquery-2.2.1.min.js"></script>

    <script type='text/javascript' src='https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/js/jquery.cookie.js'></script>
    <script type='text/javascript' src='https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/js/jquery.hoverIntent.minified.js'></script>
    <script type='text/javascript' src='https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/js/jquery.dcjqaccordion.2.7.min.js'></script>

    <link href="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/css/skins/blue.css" rel="stylesheet" type="text/css" />
    <link href="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/css/skins/graphite.css" rel="stylesheet" type="text/css" />
    <link href="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/menu/css/skins/grey.css" rel="stylesheet" type="text/css" />
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script src="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/script.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/diversen/pandoc-bootstrap-adaptive-template@959c3622/jquery.sticky-kit.js"></script>
    
    <meta name="generator" content="pandoc" />
  <meta name="author" content="Tetsuo Honda" />
  <title>クロスプラットフォームビルドシステムの設計と実装</title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="html-style.css" />
</head>
<body>

    
    <div class="navbar navbar-static-top">
    <div class="navbar-inner">
      <div class="container">
        <span class="doc-title">クロスプラットフォームビルドシステムの設計と実装</span>
        <ul class="nav pull-right doc-info">
                    <li><p class="navbar-text">Tetsuo Honda</p></li>
                              <li><p class="navbar-text">Tue, 18 Nov 2025 21:53:55 +0900 529d288</p></li>
                  </ul>
      </div>
    </div>
  </div>
    <div class="container">
    <div class="row">
            <div id="TOC" class="span3">
        <div class="well toc">

        <ul>
        <li><a href="#概要" id="toc-概要"><span class="toc-section-number">1</span> 概要</a>
        <ul>
        <li><a href="#設計の目標" id="toc-設計の目標"><span class="toc-section-number">1.1</span> 設計の目標</a></li>
        </ul></li>
        <li><a href="#前提条件" id="toc-前提条件"><span class="toc-section-number">2</span> 前提条件</a>
        <ul>
        <li><a href="#windows-環境" id="toc-windows-環境"><span class="toc-section-number">2.1</span> Windows 環境</a></li>
        <li><a href="#linux-環境" id="toc-linux-環境"><span class="toc-section-number">2.2</span> Linux 環境</a></li>
        </ul></li>
        <li><a href="#ビルド方法" id="toc-ビルド方法"><span class="toc-section-number">3</span> ビルド方法</a>
        <ul>
        <li><a href="#ビルド実行" id="toc-ビルド実行"><span class="toc-section-number">3.1</span> ビルド実行</a></li>
        <li><a href="#テストのビルドと実行" id="toc-テストのビルドと実行"><span class="toc-section-number">3.2</span> テストのビルドと実行</a></li>
        <li><a href="#クリーンアップ" id="toc-クリーンアップ"><span class="toc-section-number">3.3</span> クリーンアップ</a></li>
        </ul></li>
        <li><a href="#ファイル構成" id="toc-ファイル構成"><span class="toc-section-number">4</span> ファイル構成</a>
        <ul>
        <li><a href="#プロジェクト構造" id="toc-プロジェクト構造"><span class="toc-section-number">4.1</span> プロジェクト構造</a></li>
        </ul></li>
        <li><a href="#主な機能" id="toc-主な機能"><span class="toc-section-number">5</span> 主な機能</a>
        <ul>
        <li><a href="#makefw-フレームワークによる統合" id="toc-makefw-フレームワークによる統合"><span class="toc-section-number">5.1</span> 1. makefw フレームワークによる統合</a></li>
        <li><a href="#makeflags.mk-による追加設定" id="toc-makeflags.mk-による追加設定"><span class="toc-section-number">5.2</span> 2. makeflags.mk による追加設定</a></li>
        <li><a href="#静的ライブラリの自動組み込み" id="toc-静的ライブラリの自動組み込み"><span class="toc-section-number">5.3</span> 3. 静的ライブラリの自動組み込み</a></li>
        <li><a href="#クロスプラットフォーム対応" id="toc-クロスプラットフォーム対応"><span class="toc-section-number">5.4</span> 4. クロスプラットフォーム対応</a></li>
        <li><a href="#ライブラリ構成" id="toc-ライブラリ構成"><span class="toc-section-number">5.5</span> 5. ライブラリ構成</a></li>
        </ul></li>
        <li><a href="#設計思想" id="toc-設計思想"><span class="toc-section-number">6</span> 設計思想</a>
        <ul>
        <li><a href="#技術的な対処方針" id="toc-技術的な対処方針"><span class="toc-section-number">6.1</span> 技術的な対処方針</a>
        <ul>
        <li><a href="#os-判定による条件分岐" id="toc-os-判定による条件分岐"><span class="toc-section-number">6.1.1</span> OS 判定による条件分岐</a></li>
        <li><a href="#コンパイラとツールチェーンの違い" id="toc-コンパイラとツールチェーンの違い"><span class="toc-section-number">6.1.2</span> コンパイラとツールチェーンの違い</a></li>
        <li><a href="#mingw-環境の活用" id="toc-mingw-環境の活用"><span class="toc-section-number">6.1.3</span> MinGW 環境の活用</a></li>
        </ul></li>
        <li><a href="#makefw-フレームワーク" id="toc-makefw-フレームワーク"><span class="toc-section-number">6.2</span> makefw フレームワーク</a></li>
        <li><a href="#ライブラリ構成-1" id="toc-ライブラリ構成-1"><span class="toc-section-number">6.3</span> ライブラリ構成</a></li>
        <li><a href="#実装ファイル" id="toc-実装ファイル"><span class="toc-section-number">6.4</span> 実装ファイル</a></li>
        </ul></li>
        <li><a href="#実装の特徴" id="toc-実装の特徴"><span class="toc-section-number">7</span> 実装の特徴</a></li>
        <li><a href="#デバッグ" id="toc-デバッグ"><span class="toc-section-number">8</span> デバッグ</a></li>
        <li><a href="#現在の制限事項" id="toc-現在の制限事項"><span class="toc-section-number">9</span> 現在の制限事項</a></li>
        <li><a href="#今後の拡張可能性" id="toc-今後の拡張可能性"><span class="toc-section-number">10</span> 今後の拡張可能性</a></li>
        <li><a href="#実装のベストプラクティスと重要なノート" id="toc-実装のベストプラクティスと重要なノート"><span class="toc-section-number">11</span> 実装のベストプラクティスと重要なノート</a>
        <ul>
        <li><a href="#環境設定スクリプトの実行順序重要" id="toc-環境設定スクリプトの実行順序重要"><span class="toc-section-number">11.1</span> 環境設定スクリプトの実行順序（重要）</a></li>
        <li><a href="#utf-8-ソースコードへの対応" id="toc-utf-8-ソースコードへの対応"><span class="toc-section-number">11.2</span> UTF-8 ソースコードへの対応</a></li>
        <li><a href="#pdb-ファイルの適切な配置" id="toc-pdb-ファイルの適切な配置"><span class="toc-section-number">11.3</span> PDB ファイルの適切な配置</a>
        <ul>
        <li><a href="#ライブラリの-pdb" id="toc-ライブラリの-pdb"><span class="toc-section-number">11.3.1</span> ライブラリの PDB</a></li>
        <li><a href="#実行ファイルの-pdb" id="toc-実行ファイルの-pdb"><span class="toc-section-number">11.3.2</span> 実行ファイルの PDB</a></li>
        </ul></li>
        <li><a href="#fs-オプションの追加" id="toc-fs-オプションの追加"><span class="toc-section-number">11.4</span> /FS オプションの追加</a></li>
        <li><a href="#workspace_folder-のパス変換" id="toc-workspace_folder-のパス変換"><span class="toc-section-number">11.5</span> WORKSPACE_FOLDER のパス変換</a></li>
        <li><a href="#ディレクトリの依存関係" id="toc-ディレクトリの依存関係"><span class="toc-section-number">11.6</span> ディレクトリの依存関係</a></li>
        <li><a href="#clean-ターゲットの実装" id="toc-clean-ターゲットの実装"><span class="toc-section-number">11.7</span> clean ターゲットの実装</a></li>
        </ul></li>
        <li><a href="#まとめと今後の展望" id="toc-まとめと今後の展望"><span class="toc-section-number">12</span> まとめと今後の展望</a>
        <ul>
        <li><a href="#採用した方針" id="toc-採用した方針"><span class="toc-section-number">12.1</span> 採用した方針</a></li>
        <li><a href="#メリット" id="toc-メリット"><span class="toc-section-number">12.2</span> メリット</a></li>
        <li><a href="#注意点" id="toc-注意点"><span class="toc-section-number">12.3</span> 注意点</a></li>
        </ul></li>
        </ul>

        </div>
      </div>
            <div class="span9">

                <H1>クロスプラットフォームビルドシステムの設計と実装</H1>
      
      
      <h1 data-number="1" id="概要"><span class="header-section-number">1</span> 概要</h1>
<p>このドキュメントは、c-modernization-kit プロジェクトのクロスプラットフォームビルドシステムの設計、実装、および使用方法を説明します。</p>
<p>本プロジェクトは、Windows/Linux クロスプラットフォームビルドシステムを実現しています。MSVC (Microsoft Visual C++) と GCC の両方に対応し、単一の Makefile で Linux と Windows の両環境でビルドできます。</p>
<h2 data-number="1.1" id="設計の目標"><span class="header-section-number">1.1</span> 設計の目標</h2>
<ul>
<li>prod, test 配下のソースコードを Linux と Windows の両環境でビルドできるようにする</li>
<li>doxyfw でのドキュメント生成を Linux と Windows の両環境で実行できるようにする</li>
<li>makefw フレームワークをクロスプラットフォーム対応する（他のプロジェクトでも利用可能にする）</li>
<li>既存の Linux 環境でのビルドを完全に維持する（動作に変更を加えない）</li>
<li>Windows 環境では MSVC (cl.exe, lib.exe, link.exe) を使用する</li>
<li>Git for Windows に付属している MinGW 環境のシェルコマンドを活用して、既存スクリプトの互換性を保つ</li>
</ul>
<h1 data-number="2" id="前提条件"><span class="header-section-number">2</span> 前提条件</h1>
<h2 data-number="2.1" id="windows-環境"><span class="header-section-number">2.1</span> Windows 環境</h2>
<p><strong>VS Code 使用時</strong>: 環境変数は VS Code 起動時に自動設定済みの前提です。以下の環境が利用可能である必要があります：</p>
<ol type="1">
<li><p><strong>ポータブル版 Visual Studio Build Tools</strong></p>
<ul>
<li>MSVC コンパイラ (<code>cl.exe</code>)</li>
<li>MSVC リンカー (<code>link.exe</code>)</li>
</ul></li>
<li><p><strong>Git for Windows (MinGW)</strong></p>
<ul>
<li>GNU Make (<code>make.exe</code>)</li>
<li>各種 Unix コマンド</li>
</ul></li>
<li><p><strong>環境設定の実行順序（手動設定時のみ）</strong></p>
<div class="sourceCode" id="cb1"><pre class="sourceCode cmd"><code class="sourceCode dosbat"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="bu">call</span> <span class="ot">Add-MinGW-Path.cmd</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="bu">call</span> <span class="ot">Add-VSBT-Env-x64.cmd</span></span></code></pre></div>
<p>この順序で実行することで、MSVC の <code>link.exe</code> が MinGW の <code>link</code> より優先されます。</p></li>
</ol>
<h2 data-number="2.2" id="linux-環境"><span class="header-section-number">2.2</span> Linux 環境</h2>
<p>標準的な開発ツールが必要です：<br />
- GCC コンパイラ<br />
- GNU Make</p>
<h1 data-number="3" id="ビルド方法"><span class="header-section-number">3</span> ビルド方法</h1>
<h2 data-number="3.1" id="ビルド実行"><span class="header-section-number">3.1</span> ビルド実行</h2>
<p>プロジェクトルートまたは <code>prod/calc</code> ディレクトリで make コマンドを実行します：</p>
<p><strong>Windows:</strong></p>
<div class="sourceCode" id="cb2"><pre class="sourceCode cmd"><code class="sourceCode dosbat"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>make</span></code></pre></div>
<p><strong>Linux:</strong></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span></span></code></pre></div>
<p>このコマンドで以下がビルドされます：</p>
<p><strong>ライブラリ / Libraries:</strong></p>
<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 27%" />
<col style="width: 21%" />
<col style="width: 18%" />
</colgroup>
<thead>
<tr>
<th>ライブラリ</th>
<th>Windows</th>
<th>Linux</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td>libcalcbase</td>
<td><code>prod/calc/lib/calcbase.lib</code></td>
<td><code>prod/calc/lib/libcalcbase.a</code></td>
<td>基本計算関数ライブラリ（静的ライブラリ固定）</td>
</tr>
<tr>
<td>libcalc</td>
<td><code>prod/calc/lib/calc.dll</code> + <code>calc.lib</code></td>
<td><code>prod/calc/lib/libcalc.so</code></td>
<td>計算ハンドラーライブラリ（動的ライブラリ固定、calcbase を内部に静的リンク）</td>
</tr>
</tbody>
</table>
<p><strong>コマンド / Commands:</strong></p>
<table>
<colgroup>
<col style="width: 21%" />
<col style="width: 21%" />
<col style="width: 17%" />
<col style="width: 39%" />
</colgroup>
<thead>
<tr>
<th>コマンド</th>
<th>Windows</th>
<th>Linux</th>
<th>リンクライブラリ</th>
</tr>
</thead>
<tbody>
<tr>
<td>add</td>
<td><code>prod/calc/src/add/add.exe</code></td>
<td><code>prod/calc/src/add/add</code></td>
<td>calcbase のみ</td>
</tr>
<tr>
<td>calc</td>
<td><code>prod/calc/src/calc/calc.exe</code></td>
<td><code>prod/calc/src/calc/calc</code></td>
<td>calc のみ</td>
</tr>
<tr>
<td>shared-and-static-add</td>
<td><code>prod/calc/src/shared-and-static-add/shared-and-static-add.exe</code></td>
<td><code>prod/calc/src/shared-and-static-add/shared-and-static-add</code></td>
<td>calc + calcbase (両方)</td>
</tr>
</tbody>
</table>
<p><strong>重要</strong>: libcalc は動的ライブラリとして固定実装されており、calcbase を内部に静的リンクします。shared-and-static-add は、動的ライブラリと静的ライブラリの両方をリンクする実装例です。</p>
<h2 data-number="3.2" id="テストのビルドと実行"><span class="header-section-number">3.2</span> テストのビルドと実行</h2>
<p>test/ ディレクトリでテストをビルド・実行します：</p>
<p><strong>Windows:</strong></p>
<div class="sourceCode" id="cb4"><pre class="sourceCode cmd"><code class="sourceCode dosbat"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> test</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>make</span></code></pre></div>
<p><strong>Linux:</strong></p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> test</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span></span></code></pre></div>
<p>テストは Google Test フレームワークを使用しており、以下の種類があります：<br />
- <strong>単体テスト</strong>: ライブラリ関数の単体テスト（<code>test/src/calc/libcalcbaseTest/</code>）<br />
- <strong>統合テスト</strong>: コマンド全体の統合テスト（<code>test/src/calc/main/</code>）<br />
- <strong>モックライブラリ</strong>: テスト用のモック実装（<code>test/libsrc/mock_*/</code>）</p>
<h2 data-number="3.3" id="クリーンアップ"><span class="header-section-number">3.3</span> クリーンアップ</h2>
<p><strong>プロダクションコードのクリーンアップ:</strong></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> prod/calc</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> clean</span></code></pre></div>
<p><strong>テストコードのクリーンアップ:</strong></p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> test</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> clean</span></code></pre></div>
<h1 data-number="4" id="ファイル構成"><span class="header-section-number">4</span> ファイル構成</h1>
<h2 data-number="4.1" id="プロジェクト構造"><span class="header-section-number">4.1</span> プロジェクト構造</h2>
<pre><code>c-modernization-kit/
├── makefw/                              # Makefile フレームワーク（testfw から切り出し）
│   ├── makefiles/
│   │   ├── makelibsrc.mk               # ライブラリビルド用共通テンプレート
│   │   ├── makesrc.mk                  # 実行ファイルビルド用共通テンプレート
│   │   ├── prepare.mk                  # 準備処理
│   │   └── _*.mk                       # 内部処理用ファイル
│   └── docs-src/                       # フレームワーク技術ドキュメント
├── prod/calc/
│   ├── Makefile                        # トップレベル Makefile（再帰ビルド）
│   ├── libsrc/
│   │   ├── Makefile                    # libsrc 配下の再帰ビルド
│   │   ├── makeflags.mk                # ライブラリ共通設定
│   │   ├── calcbase/
│   │   │   └── Makefile                # calcbase ビルド定義（静的ライブラリ）
│   │   └── calc/
│   │       ├── Makefile                # calc ビルド定義（動的ライブラリ）
│   │       └── makeflags.mk            # calc 固有設定（LIB_TYPE=shared）
│   └── src/
│       ├── Makefile                    # src 配下の再帰ビルド
│       ├── add/
│       │   └── Makefile                # add コマンドビルド定義
│       ├── calc/
│       │   └── Makefile                # calc コマンドビルド定義
│       └── shared-and-static-add/
│           └── Makefile                # shared-and-static-add ビルド定義
└── test/
    ├── Makefile                        # テストトップレベル Makefile
    ├── makeflags.mk                    # テスト共通設定
    ├── libsrc/
    │   ├── Makefile                    # テスト用ライブラリ配下の再帰ビルド
    │   ├── mock_calcbase/
    │   │   └── Makefile                # calcbase モックライブラリ
    │   └── mock_calc/
    │       └── Makefile                # calc モックライブラリ
    └── src/
        ├── Makefile                    # テスト配下の再帰ビルド
        └── calc/
            ├── libcalcbaseTest/
            │   └── addTest/
            │       └── Makefile        # add 関数単体テスト
            └── main/
                ├── addTest/
                │   └── Makefile        # add コマンド統合テスト
                ├── calcTest/
                │   └── Makefile        # calc コマンド統合テスト
                └── shared-and-static-addTest/
                    └── Makefile        # shared-and-static-add 統合テスト</code></pre>
<p><strong>設計方針</strong>:<br />
- 単一の <code>Makefile</code> で Linux/Windows 両対応<br />
- makefw テンプレートが OS 判定を自動処理<br />
- 各 Makefile は最小限の設定のみを記述</p>
<h1 data-number="5" id="主な機能"><span class="header-section-number">5</span> 主な機能</h1>
<h2 data-number="5.1" id="makefw-フレームワークによる統合"><span class="header-section-number">5.1</span> 1. makefw フレームワークによる統合</h2>
<p><code>makefw</code> は testfw から Makefile 機能を切り出したフレームワークです。共通テンプレートにより、Windows/Linux の差異を吸収します。</p>
<p><strong>ライブラリ用 Makefile の基本形:</strong></p>
<div class="sourceCode" id="cb9"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="dt">find-up</span> <span class="ch">=</span><span class="st"> ...</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="dt">WORKSPACE_FOLDER</span> <span class="ch">:=</span><span class="st"> </span><span class="ch">$(</span><span class="kw">strip</span><span class="st"> </span><span class="ch">$(</span><span class="kw">call</span><span class="st"> find-up</span><span class="kw">,</span><span class="ch">$(</span><span class="dt">CURDIR</span><span class="ch">)</span><span class="kw">,</span><span class="st">.workspaceRoot</span><span class="ch">))</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="kw">include</span> <span class="ch">$(</span><span class="dt">WORKSPACE_FOLDER</span><span class="ch">)</span>/makefw/makefiles/prepare.mk</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="dt">LIBS</span> <span class="ch">+=</span><span class="st"> calcbase</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="kw">include</span> <span class="ch">$(</span><span class="dt">WORKSPACE_FOLDER</span><span class="ch">)</span>/makefw/makefiles/makelibsrc.mk</span></code></pre></div>
<p><strong>実行ファイル用 Makefile の基本形:</strong></p>
<div class="sourceCode" id="cb10"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="kw">include</span> <span class="ch">$(</span><span class="dt">WORKSPACE_FOLDER</span><span class="ch">)</span>/makefw/makefiles/prepare.mk</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="dt">LIBS</span> <span class="ch">+=</span><span class="st"> calc</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="kw">include</span> <span class="ch">$(</span><span class="dt">WORKSPACE_FOLDER</span><span class="ch">)</span>/makefw/makefiles/makesrc.mk</span></code></pre></div>
<h2 data-number="5.2" id="makeflags.mk-による追加設定"><span class="header-section-number">5.2</span> 2. makeflags.mk による追加設定</h2>
<p>各ライブラリ/コマンド固有の設定は <code>makeflags.mk</code> に記述できます。</p>
<p><strong>calc/makeflags.mk の例:</strong></p>
<div class="sourceCode" id="cb11"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="cf">ifeq</span> (<span class="ch">$(</span><span class="dt">OS</span><span class="ch">)</span>,Windows_NT)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Windows: DLL エクスポート定義</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">CFLAGS</span>   <span class="ch">+=</span><span class="st"> /DCALC_EXPORTS</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">CXXFLAGS</span> <span class="ch">+=</span><span class="st"> /DCALC_EXPORTS</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="cf">endif</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="dt">LIB_TYPE</span> <span class="ch">=</span><span class="st"> shared</span></span></code></pre></div>
<p>この設定により、calc は Windows では DLL、Linux では .so として自動的にビルドされます。</p>
<p><strong>test/makeflags.mk の例:</strong></p>
<div class="sourceCode" id="cb12"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="dt">LINK_TEST</span> <span class="ch">=</span><span class="st"> 1</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="cf">ifeq</span> (<span class="ch">$(</span><span class="dt">OS</span><span class="ch">)</span>,Windows_NT)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Windows: CALC_STATIC マクロを定義</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">CFLAGS</span>   <span class="ch">+=</span><span class="st"> /DCALC_STATIC</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">CXXFLAGS</span> <span class="ch">+=</span><span class="st"> /DCALC_STATIC</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="cf">endif</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="dt">LIBSDIR</span> <span class="ch">+=</span><span class="st"> </span><span class="ch">\</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="st">    </span><span class="ch">$(</span><span class="dt">WORKSPACE_FOLDER</span><span class="ch">)</span><span class="st">/testfw/lib </span><span class="ch">\</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="st">    </span><span class="ch">$(</span><span class="dt">WORKSPACE_FOLDER</span><span class="ch">)</span><span class="st">/test/lib</span></span></code></pre></div>
<p><code>LINK_TEST = 1</code> を設定することで、Google Test フレームワークが自動的にリンクされます。</p>
<h2 data-number="5.3" id="静的ライブラリの自動組み込み"><span class="header-section-number">5.3</span> 3. 静的ライブラリの自動組み込み</h2>
<p><code>LIB_TYPE=shared</code> の場合、動的ライブラリ（DLL/.so）は依存する静的ライブラリを自動的に内部リンクします。</p>
<p><strong>calc/Makefile の例:</strong></p>
<div class="sourceCode" id="cb13"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="dt">LIBS</span> <span class="ch">+=</span><span class="st"> calcbase</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="kw">include</span> <span class="ch">$(</span><span class="dt">WORKSPACE_FOLDER</span><span class="ch">)</span>/makefw/makefiles/makelibsrc.mk</span></code></pre></div>
<p><strong>calc/makeflags.mk:</strong></p>
<div class="sourceCode" id="cb14"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="dt">LIB_TYPE</span> <span class="ch">=</span><span class="st"> shared</span></span></code></pre></div>
<p><strong>動作:</strong><br />
- <code>LIBS</code> に指定された <code>calcbase</code> をライブラリ検索パスから検索<br />
- Windows: <code>calcbase.lib</code> を検索<br />
- Linux: <code>libcalcbase.a</code> を検索<br />
- 静的ライブラリが見つかった場合は DLL/.so に静的リンク<br />
- 見つからない場合は動的リンクフラグとして保持</p>
<h2 data-number="5.4" id="クロスプラットフォーム対応"><span class="header-section-number">5.4</span> 4. クロスプラットフォーム対応</h2>
<p>makefw テンプレートが Windows (MSVC) と Linux (GCC) の両方に自動対応します。</p>
<p><strong>makefw/makefiles/makelibsrc.mk 内の OS 判定:</strong></p>
<div class="sourceCode" id="cb15"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="cf">ifeq</span> (<span class="ch">$(</span><span class="dt">OS</span><span class="ch">)</span>,Windows_NT)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Windows (MSVC)</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">CC</span> <span class="ch">:=</span><span class="st"> cl</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">LD</span> <span class="ch">:=</span><span class="st"> link</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">TARGET</span> <span class="ch">:=</span><span class="st"> </span><span class="ch">$(</span><span class="dt">TARGET</span><span class="ch">)</span><span class="st">.dll  </span><span class="co"># (LIB_TYPE=shared の場合)</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Linux (GCC)</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">CC</span> <span class="ch">:=</span><span class="st"> gcc</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">LD</span> <span class="ch">:=</span><span class="st"> gcc</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">TARGET</span> <span class="ch">:=</span><span class="st"> lib</span><span class="ch">$(</span><span class="dt">TARGET</span><span class="ch">)</span><span class="st">.so  </span><span class="co"># (LIB_TYPE=shared の場合)</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="cf">endif</span></span></code></pre></div>
<p>各 Makefile はテンプレートを include するだけで、OS 固有の処理は不要です。</p>
<h2 data-number="5.5" id="ライブラリ構成"><span class="header-section-number">5.5</span> 5. ライブラリ構成</h2>
<p>本プロジェクトでは、以下の構成でライブラリをビルドします：</p>
<table>
<colgroup>
<col style="width: 25%" />
<col style="width: 23%" />
<col style="width: 20%" />
<col style="width: 16%" />
<col style="width: 13%" />
</colgroup>
<thead>
<tr>
<th>ライブラリ</th>
<th>LIB_TYPE 設定</th>
<th>Windows</th>
<th>Linux</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td>libcalcbase</td>
<td>未設定 (→ static)</td>
<td><code>.lib</code></td>
<td><code>.a</code></td>
<td>静的ライブラリ</td>
</tr>
<tr>
<td>libcalc</td>
<td><code>shared</code> (makeflags.mk で指定)</td>
<td><code>.dll</code> + <code>.lib</code></td>
<td><code>.so</code></td>
<td>動的ライブラリ + インポートライブラリ</td>
</tr>
</tbody>
</table>
<p><strong>LIB_TYPE 変数:</strong><br />
- 未設定の場合はデフォルトで <code>static</code><br />
- <code>makeflags.mk</code> で <code>LIB_TYPE = shared</code> を指定すると動的ライブラリとしてビルド</p>
<h1 data-number="6" id="設計思想"><span class="header-section-number">6</span> 設計思想</h1>
<h2 data-number="6.1" id="技術的な対処方針"><span class="header-section-number">6.1</span> 技術的な対処方針</h2>
<h3 data-number="6.1.1" id="os-判定による条件分岐"><span class="header-section-number">6.1.1</span> OS 判定による条件分岐</h3>
<p>Makefile 内で OS を判定し、コンパイラやツールを切り替えます。</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="cf">ifeq</span> (<span class="ch">$(</span><span class="dt">OS</span><span class="ch">)</span>,Windows_NT)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Windows 環境</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">CC</span> <span class="ch">:=</span><span class="st"> cl</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">LD</span> <span class="ch">:=</span><span class="st"> link</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">AR</span> <span class="ch">:=</span><span class="st"> lib</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">OBJEXT</span> <span class="ch">:=</span><span class="st"> .obj</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">EXEEXT</span> <span class="ch">:=</span><span class="st"> .exe</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Linux 環境</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">CC</span> <span class="ch">:=</span><span class="st"> gcc</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">LD</span> <span class="ch">:=</span><span class="st"> gcc</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">AR</span> <span class="ch">:=</span><span class="st"> ar</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">OBJEXT</span> <span class="ch">:=</span><span class="st"> .o</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">EXEEXT</span> <span class="ch">:=</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a><span class="cf">endif</span></span></code></pre></div>
<p><code>$(OS)</code> 環境変数は、Windows では <code>Windows_NT</code> が設定されます。Linux では通常未定義です。</p>
<h3 data-number="6.1.2" id="コンパイラとツールチェーンの違い"><span class="header-section-number">6.1.2</span> コンパイラとツールチェーンの違い</h3>
<table>
<thead>
<tr>
<th style="text-align: left;">項目</th>
<th style="text-align: left;">Linux (GCC)</th>
<th style="text-align: left;">Windows (MSVC)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">C コンパイラ</td>
<td style="text-align: left;">gcc</td>
<td style="text-align: left;">cl.exe</td>
</tr>
<tr>
<td style="text-align: left;">C++ コンパイラ</td>
<td style="text-align: left;">g++</td>
<td style="text-align: left;">cl.exe</td>
</tr>
<tr>
<td style="text-align: left;">リンカー</td>
<td style="text-align: left;">gcc/g++</td>
<td style="text-align: left;">link.exe</td>
</tr>
<tr>
<td style="text-align: left;">静的ライブラリ生成</td>
<td style="text-align: left;">ar</td>
<td style="text-align: left;">lib.exe</td>
</tr>
<tr>
<td style="text-align: left;">静的ライブラリ拡張</td>
<td style="text-align: left;">.a</td>
<td style="text-align: left;">.lib</td>
</tr>
<tr>
<td style="text-align: left;">共有ライブラリ拡張</td>
<td style="text-align: left;">.so</td>
<td style="text-align: left;">.dll</td>
</tr>
<tr>
<td style="text-align: left;">実行ファイル拡張</td>
<td style="text-align: left;">なし</td>
<td style="text-align: left;">.exe</td>
</tr>
<tr>
<td style="text-align: left;">オブジェクト拡張</td>
<td style="text-align: left;">.o</td>
<td style="text-align: left;">.obj</td>
</tr>
</tbody>
</table>
<h3 data-number="6.1.3" id="mingw-環境の活用"><span class="header-section-number">6.1.3</span> MinGW 環境の活用</h3>
<p>Windows 環境では、Git for Windows に付属する MinGW 環境を活用します。これにより：</p>
<ul>
<li><code>bash</code>, <code>pwd</code>, <code>dirname</code> などの Linux コマンドが使える</li>
<li><code>sh</code> コマンドで既存のシェルスクリプトを実行できる</li>
<li>makefw/cmnd/ 配下のシェルスクリプトがそのまま動作する</li>
<li>doxyfw の Makefile がそのまま動作する</li>
</ul>
<h2 data-number="6.2" id="makefw-フレームワーク"><span class="header-section-number">6.2</span> makefw フレームワーク</h2>
<p>makefw は testfw から Makefile 関連機能を切り出したフレームワークです：<br />
- <strong>testfw</strong>: テスト実行、モック、Google Test 統合に特化<br />
- <strong>makefw</strong>: クロスプラットフォームビルドシステムに特化</p>
<p>この分離により、ビルドシステムとテストフレームワークの責務が明確になりました。</p>
<h2 data-number="6.3" id="ライブラリ構成-1"><span class="header-section-number">6.3</span> ライブラリ構成</h2>
<p>本プロジェクトでは、以下の構成を採用しています：<br />
- <strong>libcalcbase</strong>: 静的ライブラリ（LIB_TYPE 変数未設定、デフォルトで static）<br />
- <strong>libcalc</strong>: 動的ライブラリ（makeflags.mk で <code>LIB_TYPE = shared</code> を指定）</p>
<p>この構成により、以下のメリットがあります：<br />
1. calc.dll/.so が calcbase を内部に静的リンクする<br />
2. 依存関係が単純化され、配布時に calc.dll/.so のみを配置すれば動作<br />
3. Windows と Linux で同様の動作を実現</p>
<h2 data-number="6.4" id="実装ファイル"><span class="header-section-number">6.4</span> 実装ファイル</h2>
<p><strong>フレームワーク:</strong><br />
- <code>makefw/makefiles/makelibsrc.mk</code> - ライブラリビルド用共通テンプレート<br />
- <code>makefw/makefiles/makesrc.mk</code> - 実行ファイルビルド用共通テンプレート<br />
- <code>makefw/makefiles/prepare.mk</code> - 準備処理</p>
<p><strong>ライブラリ:</strong><br />
- <code>prod/calc/libsrc/calcbase/Makefile</code> - calcbase ビルド定義（LIB_TYPE 未設定 → static）<br />
- <code>prod/calc/libsrc/calc/Makefile</code> - calc ビルド定義<br />
- <code>prod/calc/libsrc/calc/makeflags.mk</code> - calc 固有設定（LIB_TYPE = shared）</p>
<p><strong>コマンド:</strong><br />
- <code>prod/calc/src/add/Makefile</code> - add コマンド（calcbase のみリンク）<br />
- <code>prod/calc/src/calc/Makefile</code> - calc コマンド（calc のみリンク）<br />
- <code>prod/calc/src/shared-and-static-add/Makefile</code> - shared-and-static-add コマンド（calc + calcbase をリンク）</p>
<p><strong>テスト:</strong><br />
- <code>test/makeflags.mk</code> - テスト共通設定（テストフレームワークリンク、警告レベル設定）<br />
- <code>test/libsrc/mock_calcbase/Makefile</code> - calcbase モックライブラリ<br />
- <code>test/libsrc/mock_calc/Makefile</code> - calc モックライブラリ<br />
- <code>test/src/calc/libcalcbaseTest/addTest/Makefile</code> - add 関数単体テスト<br />
- <code>test/src/calc/main/addTest/Makefile</code> - add コマンド統合テスト<br />
- <code>test/src/calc/main/calcTest/Makefile</code> - calc コマンド統合テスト<br />
- <code>test/src/calc/main/shared-and-static-addTest/Makefile</code> - shared-and-static-add 統合テスト</p>
<h1 data-number="7" id="実装の特徴"><span class="header-section-number">7</span> 実装の特徴</h1>
<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr>
<th>項目</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td>クロスプラットフォーム</td>
<td>単一の Makefile で Windows/Linux 両対応</td>
</tr>
<tr>
<td>OS 判定</td>
<td>makefw テンプレートが自動処理</td>
</tr>
<tr>
<td>ライブラリ構成</td>
<td>makeflags.mk で柔軟に設定可能</td>
</tr>
<tr>
<td>依存関係解決</td>
<td><code>LIBS</code> 変数による明示的な指定</td>
</tr>
<tr>
<td>静的リンク自動化</td>
<td>動的ライブラリビルド時に静的ライブラリを自動検索・リンク</td>
</tr>
<tr>
<td>テストフレームワーク統合</td>
<td><code>LINK_TEST = 1</code> で Google Test を自動リンク</td>
</tr>
<tr>
<td>モック機能</td>
<td>testfw のインクルードオーバーライド機能によるモック</td>
</tr>
</tbody>
</table>
<h1 data-number="8" id="デバッグ"><span class="header-section-number">8</span> デバッグ</h1>
<p>makefw テンプレートには <code>debug</code> ターゲットがあり、設定された変数を表示できます：</p>
<p><strong>calcbase のデバッグ:</strong></p>
<p>Windows:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode cmd"><code class="sourceCode dosbat"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> prod\calc\libsrc\calcbase</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>make debug</span></code></pre></div>
<p>Linux:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> prod/calc/libsrc/calcbase</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> debug</span></code></pre></div>
<p>出力例（Windows の場合）:</p>
<pre><code>TARGET = calcbase.lib
LIB_TYPE = static
OS = Windows_NT
LIBS =
STATIC_LIBS =
OBJS = obj/add.obj</code></pre>
<p><strong>calc のデバッグ:</strong></p>
<p>Windows:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode cmd"><code class="sourceCode dosbat"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> prod\calc\libsrc\calc</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>make debug</span></code></pre></div>
<p>Linux:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> prod/calc/libsrc/calc</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> debug</span></code></pre></div>
<p>出力例（Windows の場合、makeflags.mk で LIB_TYPE=shared 設定済み）:</p>
<pre><code>TARGET = calc.dll
LIB_TYPE = shared
OS = Windows_NT
LIBS = calcbase
STATIC_LIBS = C:/path/to/prod/calc/lib/calcbase.lib
OBJS = obj/calcHandler.obj</code></pre>
<h1 data-number="9" id="現在の制限事項"><span class="header-section-number">9</span> 現在の制限事項</h1>
<ol type="1">
<li><strong>ライブラリ構成の固定</strong>
<ul>
<li>libcalcbase は静的ライブラリとして実装（makeflags.mk で変更可能だが、依存関係上推奨しない）</li>
<li>libcalc は動的ライブラリとして実装（makeflags.mk で <code>LIB_TYPE = shared</code> 設定済み）</li>
</ul></li>
<li><strong>testfw 機能との分離</strong>
<ul>
<li>makefw はビルドシステムのみを提供</li>
<li>テスト機能（inject, filter, モック）は testfw が提供</li>
</ul></li>
<li><strong>ライブラリ検索パス</strong>
<ul>
<li><code>LIBSDIR</code> で指定されたパスから検索</li>
<li>prepare.mk により、以下のデフォルトパスが設定されます：
<ul>
<li><code>$(WORKSPACE_FOLDER)/prod/calc/lib</code></li>
<li><code>$(WORKSPACE_FOLDER)/test/lib</code></li>
</ul></li>
</ul></li>
</ol>
<h1 data-number="10" id="今後の拡張可能性"><span class="header-section-number">10</span> 今後の拡張可能性</h1>
<ol type="1">
<li><strong>より高度な依存関係解決</strong>
<ul>
<li><code>-L</code> オプションの追加サポート</li>
<li>システムライブラリパスの自動検索</li>
</ul></li>
<li><strong>ビルド最適化</strong>
<ul>
<li>並列ビルドのさらなる最適化</li>
<li>インクリメンタルビルドの改善</li>
</ul></li>
<li><strong>プラットフォーム拡張</strong>
<ul>
<li>macOS サポート</li>
<li>その他のコンパイラサポート (Clang など)</li>
</ul></li>
</ol>
<h1 data-number="11" id="実装のベストプラクティスと重要なノート"><span class="header-section-number">11</span> 実装のベストプラクティスと重要なノート</h1>
<p>このセクションでは、クロスプラットフォーム対応の実装で得られた重要な知見とベストプラクティスを説明します。</p>
<h2 data-number="11.1" id="環境設定スクリプトの実行順序重要"><span class="header-section-number">11.1</span> 環境設定スクリプトの実行順序（重要）</h2>
<p>Windows 環境では、環境設定スクリプトを<strong>必ず以下の順序で実行する必要があります</strong>：</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode cmd"><code class="sourceCode dosbat"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="bu">call</span> <span class="ot">Add-MinGW-Path.cmd</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="bu">call</span> <span class="ot">Add-VSBT-Env-x64.cmd</span></span></code></pre></div>
<p>この順序で実行することで、MSVC の <code>link.exe</code> が MinGW の <code>link</code> コマンドより PATH の優先順位が高くなります。</p>
<p><strong>逆の順序で実行すると、リンク時にエラーが発生します：</strong></p>
<pre class="text"><code>link: extra operand &#39;calc.lib&#39;
Try &#39;link --help&#39; for more information.</code></pre>
<p>これは、MinGW の <code>link</code> コマンド（シンボリックリンク作成用）が呼び出されてしまうためです。</p>
<h2 data-number="11.2" id="utf-8-ソースコードへの対応"><span class="header-section-number">11.2</span> UTF-8 ソースコードへの対応</h2>
<p>ソースコードが UTF-8 で記述されている場合、MSVC のコンパイル時に <code>/utf-8</code> オプションを追加する必要があります。</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="dt">CFLAGS</span> <span class="ch">:=</span><span class="st"> /W4 /Zi /TC /nologo /utf-8 /I</span><span class="ch">$(</span><span class="dt">WORKSPACE_FOLDER</span><span class="ch">)</span><span class="st">/prod/calc/include</span></span></code></pre></div>
<p>このオプションを指定しないと、以下の警告が発生します：</p>
<pre class="text"><code>warning C4819: The file contains a character that cannot be represented
in the current code page (932). Save the file in Unicode format to prevent data loss</code></pre>
<h2 data-number="11.3" id="pdb-ファイルの適切な配置"><span class="header-section-number">11.3</span> PDB ファイルの適切な配置</h2>
<p>MSVC のデバッグ情報ファイル (PDB) は、以下のように配置します。</p>
<h3 data-number="11.3.1" id="ライブラリの-pdb"><span class="header-section-number">11.3.1</span> ライブラリの PDB</h3>
<p>ライブラリファイル (.lib) と同じディレクトリに配置します。</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="dt">CFLAGS</span> <span class="ch">:=</span><span class="st"> /W4 /Zi /TC /nologo /utf-8 /FS /Fd</span><span class="ch">$(</span><span class="dt">TARGETDIR</span><span class="ch">)</span><span class="st">/calc.pdb /I...</span></span></code></pre></div>
<p>生成結果：</p>
<pre class="text"><code>prod/calc/lib/
├── calc.lib
└── calc.pdb</code></pre>
<h3 data-number="11.3.2" id="実行ファイルの-pdb"><span class="header-section-number">11.3.2</span> 実行ファイルの PDB</h3>
<p>実行ファイルと同じディレクトリに配置します。コンパイル時の中間 PDB は obj ディレクトリに配置します。</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="dt">CFLAGS</span> <span class="ch">:=</span><span class="st"> /W4 /Zi /TC /nologo /utf-8 /Fd</span><span class="ch">$(</span><span class="dt">OBJDIR</span><span class="ch">)</span><span class="st">/add.pdb /I...</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="dt">LDFLAGS</span> <span class="ch">:=</span><span class="st"> /DEBUG /PDB:</span><span class="ch">$(</span><span class="dt">TARGETDIR</span><span class="ch">)</span><span class="st">/add.pdb /LIBPATH:...</span></span></code></pre></div>
<p>生成結果：</p>
<pre class="text"><code>prod/calc/src/add/
├── add.exe
├── add.pdb     (リンク時の PDB、実行ファイルと同じ場所)
└── obj/
    ├── add.obj
    └── add.pdb (コンパイル時の PDB、obj ディレクトリ)</code></pre>
<h2 data-number="11.4" id="fs-オプションの追加"><span class="header-section-number">11.4</span> /FS オプションの追加</h2>
<p>複数のソースファイルが同じ PDB ファイルに同時に書き込む場合、<code>/FS</code> オプションを追加して同期を保証する必要があります。</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="dt">CFLAGS</span> <span class="ch">:=</span><span class="st"> /W4 /Zi /TC /nologo /utf-8 /FS /Fd</span><span class="ch">$(</span><span class="dt">TARGETDIR</span><span class="ch">)</span><span class="st">/calc.pdb /I...</span></span></code></pre></div>
<p>このオプションを指定しないと、以下のエラーが発生することがあります：</p>
<pre class="text"><code>fatal error C1041: cannot open program database &#39;calc.pdb&#39;;
if multiple CL.EXE write to the same .PDB file, please use /FS</code></pre>
<h2 data-number="11.5" id="workspace_folder-のパス変換"><span class="header-section-number">11.5</span> WORKSPACE_FOLDER のパス変換</h2>
<p>Makefile 内で Unix スタイルのパス (<code>/d/Users/...</code>) を取得した場合、MSVC はこのパスを認識できません。<code>cygpath -w</code> を使用して Windows スタイルのパス (<code>D:\Users\...</code>) に変換する必要があります。</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="dt">WORKSPACE_FOLDER</span> <span class="ch">:=</span><span class="st"> </span><span class="ch">$(</span><span class="kw">shell</span><span class="st"> \</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="st">    dir=`pwd`; \</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="st">    while [ &quot;</span><span class="ch">$$</span><span class="st">dir&quot; != &quot;/&quot; ]; do \</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="st">        if [ -f &quot;</span><span class="ch">$$</span><span class="st">dir/.workspaceRoot&quot; ]; then \</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="st">            cygpath -w &quot;</span><span class="ch">$$</span><span class="st">dir&quot; 2&gt;/dev/null || echo </span><span class="ch">$$</span><span class="st">dir; \</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="st">            break; \</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="st">        fi; \</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="st">        dir=</span><span class="ch">$$</span><span class="st">(dirname </span><span class="ch">$$</span><span class="st">dir); \</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="st">    done \</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="ch">)</span></span></code></pre></div>
<p><code>cygpath -w</code> が利用できない環境では、<code>echo $$dir</code> にフォールバックします。</p>
<h2 data-number="11.6" id="ディレクトリの依存関係"><span class="header-section-number">11.6</span> ディレクトリの依存関係</h2>
<p>PDB ファイルを TARGETDIR に出力する場合、コンパイルルールに TARGETDIR の依存関係を追加する必要があります。</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="dv">$(OBJDIR)/%$(OBJEXT):</span><span class="dt"> %.c | </span><span class="ch">$(</span><span class="dt">OBJDIR</span><span class="ch">)</span><span class="dt"> </span><span class="ch">$(</span><span class="dt">TARGETDIR</span><span class="ch">)</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="er">    </span><span class="ch">$(</span><span class="dt">CC</span><span class="ch">)</span> <span class="ch">$(</span><span class="dt">CFLAGS</span><span class="ch">)</span> /c /Fo<span class="ch">$@</span> <span class="ch">$&lt;</span></span></code></pre></div>
<p>これにより、コンパイル前に TARGETDIR が作成されることが保証されます。</p>
<h2 data-number="11.7" id="clean-ターゲットの実装"><span class="header-section-number">11.7</span> clean ターゲットの実装</h2>
<p>Windows 環境では、clean ターゲットで PDB ファイルも削除する必要があります。</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="ot">.PHONY:</span><span class="dt"> clean</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="dv">clean:</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="er">    </span>rm -rf <span class="ch">$(</span><span class="dt">OBJDIR</span><span class="ch">)</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    rm -f <span class="ch">$(</span><span class="dt">TARGETDIR</span><span class="ch">)</span>/<span class="ch">$(</span><span class="dt">TARGET</span><span class="ch">)</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="cf">ifeq</span> (<span class="ch">$(</span><span class="dt">OS</span><span class="ch">)</span>,Windows_NT)</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    rm -f <span class="ch">$(</span><span class="dt">TARGETDIR</span><span class="ch">)</span>/*.pdb</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="cf">endif</span></span></code></pre></div>
<p>obj ディレクトリの削除により、コンパイル時の PDB と ILK ファイルが削除されます。TARGETDIR に配置されたリンク時の PDB ファイルのみ、明示的に削除します。</p>
<h1 data-number="12" id="まとめと今後の展望"><span class="header-section-number">12</span> まとめと今後の展望</h1>
<h2 data-number="12.1" id="採用した方針"><span class="header-section-number">12.1</span> 採用した方針</h2>
<p>本プロジェクトのクロスプラットフォーム対応では、以下の方針を採用しました：</p>
<ul>
<li><strong>OS 判定による条件分岐</strong>: コンパイラとツールを切り替え</li>
<li><strong>MinGW 環境の活用</strong>: 既存のシェルスクリプトとシェルコマンドを利用</li>
<li><strong>makefw フレームワーク</strong>: testfw から切り出し、クロスプラットフォーム対応</li>
<li><strong>既存コードの保護</strong>: Linux 環境では既存の動作を完全に維持</li>
</ul>
<h2 data-number="12.2" id="メリット"><span class="header-section-number">12.2</span> メリット</h2>
<ul>
<li><strong>再利用性</strong>: makefw がクロスプラットフォーム対応され、他のプロジェクトでも利用できる</li>
<li><strong>保守性</strong>: Linux と Windows で同じ Makefile を使用できるため、メンテナンス性が向上</li>
<li><strong>互換性</strong>: MinGW 環境により、既存のシェルスクリプトとシェルコマンドを活用できる</li>
<li><strong>ネイティブ性</strong>: MSVC を使用することで、Windows ネイティブなバイナリを生成できる</li>
<li><strong>安定性</strong>: Linux の動作は完全に維持される</li>
</ul>
<h2 data-number="12.3" id="注意点"><span class="header-section-number">12.3</span> 注意点</h2>
<ul>
<li><strong>makefw の共有</strong>: makefw は複数のプロジェクトで共有されるため、変更時には慎重に行う</li>
<li><strong>コンパイラフラグ</strong>: MSVC と GCC でコンパイラフラグが異なるため、makeflags.mk の条件分岐を慎重に設定</li>
<li><strong>環境設定順序</strong>: Windows では環境設定スクリプトを必ず正しい順序で実行</li>
<li><strong>MinGW 必須</strong>: doxyfw は MinGW の bash を前提としているため、Windows では MinGW 環境が必須</li>
<li><strong>テストライブラリ</strong>: テストを実行する場合、Windows 版の Google Test ライブラリが必要</li>
<li><strong>文字コード</strong>: ソースコードが UTF-8 の場合、MSVC では <code>/utf-8</code> オプションが必要</li>
</ul>
            </div>
    </div>
  </div>
  <script src="https://vjs.zencdn.net/5.4.4/video.js"></script>

</body>
</html>
